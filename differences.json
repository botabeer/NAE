[
    {
        'original': 'https://mrkzgulfup.com/uploads/176303338682671.jpeg',
        'solution': 'https://mrkzgulfup.com/uploads/176303338684742.jpeg',
        'answer': 5
    },
    {
        'original': 'https://mrkzgulfup.com/uploads/176303338686833.jpeg',
        'solution': 'https://mrkzgulfup.com/uploads/176303338695684.jpeg',
        'answer': 5
    },
    {
        'original': 'https://mrkzgulfup.com/uploads/176303338705925.jpeg',
        'solution': 'https://mrkzgulfup.com/uploads/176303338714356.jpeg',
        'answer': 5
    },
    {
        'original': 'https://mrkzgulfup.com/uploads/176303338715787.jpeg',
        'solution': 'https://mrkzgulfup.com/uploads/176303338717158.jpeg',
        'answer': 5
    },
    {
        'original': 'https://mrkzgulfup.com/uploads/176303338718499.jpeg',
        'solution': 'https://mrkzgulfup.com/uploads/1763033387254610.jpeg',
        'answer': 5
    },
    {
        'original': 'https://mrkzgulfup.com/uploads/1763033387269511.jpeg',
        'solution': 'https://mrkzgulfup.com/uploads/1763033387284912.jpeg',
        'answer': 5
    },
    {
        'original': 'https://mrkzgulfup.com/uploads/1763033387350313.jpeg',
        'solution': 'https://mrkzgulfup.com/uploads/176303338737714.jpeg',
        'answer': 5
    },
]

# === حالة المستخدم ===
user_difference_state = {}  # {user_id: {"index":0, "score":0}}

# === بدء اللعبة ===
def start_difference_game(event):
    user_id = event.source.user_id
    user_difference_state[user_id] = {"index": 0, "score": 0}
    send_difference_question(event, user_id)

# === إرسال السؤال ===
def send_difference_question(event, user_id):
    state = user_difference_state[user_id]
    if state["index"] >= 5:
        score = state["score"]
        line_bot_api.reply_message(
            event.reply_token,
            TextSendMessage(
                text=f"انتهت اللعبة!\nلقد أجبت بشكل صحيح على {score}/5 أسئلة."
            )
        )
        del user_difference_state[user_id]
        return

    question = DIFFERENCE_SETS[state["index"]]
    line_bot_api.reply_message(
        event.reply_token,
        [
            TextSendMessage(
                text=f"السؤال {state['index']+1}/5\nكم فرق تجد في هذه الصورة؟ أرسل الرقم فقط.",
                quick_reply=create_main_menu()
            ),
            ImageSendMessage(
                original_content_url=question["original"],
                preview_image_url=question["original"]
            )
        ]
    )

# === معالجة الإجابة ===
def handle_difference_answer(event, text):
    user_id = event.source.user_id
    if user_id not in user_difference_state:
        return False

    state = user_difference_state[user_id]
    question = DIFFERENCE_SETS[state["index"]]

    if not text.isdigit():
        return False

    user_answer = int(text)
    messages = []

    if user_answer == question["answer"]:
        messages.append(TextSendMessage(text="صحيح! إليك الحل:"))
        state["score"] += 1
    else:
        messages.append(TextSendMessage(
            text=f"خطأ! العدد الصحيح: {question['answer']}\nإليك الحل:"
        ))

    messages.append(
        ImageSendMessage(
            original_content_url=question["solution"],
            preview_image_url=question["solution"]
        )
    )

    state["index"] += 1
    line_bot_api.reply_message(event.reply_token, messages)
    send_difference_question(event, user_id)
    return True
