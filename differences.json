# === Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„ÙØ±ÙˆÙ‚Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ===
DIFFERENCE_SETS = [
    {
        'original': 'https://mrkzgulfup.com/uploads/176303338682671.jpeg',
        'solution': 'https://mrkzgulfup.com/uploads/176303338684742.jpeg',
        'answer': 5  # Ø¹Ø¯Ù„ Ø­Ø³Ø¨ Ø§Ù„ÙØ±ÙˆÙ‚Ø§Øª
    },
    {
        'original': 'https://mrkzgulfup.com/uploads/176303338686833.jpeg',
        'solution': 'https://mrkzgulfup.com/uploads/176303338695684.jpeg',
        'answer': 5
    },
    {
        'original': 'https://mrkzgulfup.com/uploads/176303338705925.jpeg',
        'solution': 'https://mrkzgulfup.com/uploads/176303338714356.jpeg',
        'answer': 5
    },
    {
        'original': 'https://mrkzgulfup.com/uploads/176303338715787.jpeg',
        'solution': 'https://mrkzgulfup.com/uploads/176303338717158.jpeg',
        'answer': 5
    },
    {
        'original': 'https://mrkzgulfup.com/uploads/176303338718499.jpeg',
        'solution': 'https://mrkzgulfup.com/uploads/1763033387254610.jpeg',
        'answer': 5
    },
    {
        'original': 'https://mrkzgulfup.com/uploads/1763033387269511.jpeg',
        'solution': 'https://mrkzgulfup.com/uploads/1763033387284912.jpeg',
        'answer': 5
    },
    {
        'original': 'https://mrkzgulfup.com/uploads/1763033387350313.jpeg',
        'solution': 'https://mrkzgulfup.com/uploads/176303338737714.jpeg',
        'answer': 5
    },
]

# === Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ===
user_difference_state = {}  # {user_id: {"index":0, "score":0}}

# === Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© ===
def start_difference_game(event):
    user_id = event.source.user_id
    user_difference_state[user_id] = {"index": 0, "score": 0}
    send_difference_question(event, user_id)

# === Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø³Ø¤Ø§Ù„ ===
def send_difference_question(event, user_id):
    state = user_difference_state[user_id]
    if state["index"] >= 5:  # Ø§Ù†ØªÙ‡Ø§Ø¡ 5 Ø£Ø³Ø¦Ù„Ø©
        score = state["score"]
        line_bot_api.reply_message(
            event.reply_token,
            TextSendMessage(
                text=f"ğŸ‰ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©!\nÙ„Ù‚Ø¯ Ø£Ø¬Ø¨Øª Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ Ø¹Ù„Ù‰ {score}/5 Ø£Ø³Ø¦Ù„Ø©."
            )
        )
        del user_difference_state[user_id]
        return

    question = DIFFERENCE_SETS[state["index"]]
    # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ ÙÙ‚Ø·
    line_bot_api.reply_message(
        event.reply_token,
        [
            TextSendMessage(
                text=f"Ø§Ù„Ø³Ø¤Ø§Ù„ {state['index']+1}/5\nÙƒÙ… ÙØ±Ù‚ ØªØ¬Ø¯ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ØµÙˆØ±Ø©ØŸ Ø£Ø±Ø³Ù„ Ø§Ù„Ø±Ù‚Ù… ÙÙ‚Ø·.",
                quick_reply=create_main_menu()
            ),
            ImageSendMessage(
                original_content_url=question["original"],
                preview_image_url=question["original"]
            )
        ]
    )

# === Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© ===
def handle_difference_answer(event, text):
    user_id = event.source.user_id
    if user_id not in user_difference_state:
        return False

    state = user_difference_state[user_id]
    question = DIFFERENCE_SETS[state["index"]]

    if not text.isdigit():
        return False

    user_answer = int(text)
    messages = []

    if user_answer == question["answer"]:
        messages.append(TextSendMessage(text="âœ… ØµØ­ÙŠØ­! Ø¥Ù„ÙŠÙƒ Ø§Ù„Ø­Ù„:"))
        state["score"] += 1
    else:
        messages.append(TextSendMessage(
            text=f"âŒ Ø®Ø·Ø£! Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„ØµØ­ÙŠØ­: {question['answer']}\nØ¥Ù„ÙŠÙƒ Ø§Ù„Ø­Ù„:"
        ))

    # Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØ±Ø© Ø§Ù„Ø­Ù„
    messages.append(
        ImageSendMessage(
            original_content_url=question["solution"],
            preview_image_url=question["solution"]
        )
    )

    state["index"] += 1

    # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø«Ù… Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ
    line_bot_api.reply_message(event.reply_token, messages)
    send_difference_question(event, user_id)
    return True
