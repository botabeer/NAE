import json
from flask import Flask, request, abort
from linebot import LineBotApi, WebhookHandler
from linebot.exceptions import InvalidSignatureError
from linebot.models import MessageEvent, TextMessage, TextSendMessage
import os, typing

app = Flask(__name__)

LINE_CHANNEL_ACCESS_TOKEN = os.getenv("LINE_CHANNEL_ACCESS_TOKEN")
LINE_CHANNEL_SECRET = os.getenv("LINE_CHANNEL_SECRET")
if not LINE_CHANNEL_ACCESS_TOKEN or not LINE_CHANNEL_SECRET:
    raise RuntimeError("Set LINE_CHANNEL_ACCESS_TOKEN and LINE_CHANNEL_SECRET environment variables")

line_bot_api = LineBotApi(LINE_CHANNEL_ACCESS_TOKEN)
handler = WebhookHandler(LINE_CHANNEL_SECRET)

# --- ุชุญููู ุงููููุงุช ุงูุฃุฎุฑู ---
def load_file_lines(filename: str) -> typing.List[str]:
    try:
        with open(filename, "r", encoding="utf-8") as f:
            return [line.strip() for line in f if line.strip()]
    except Exception:
        return []

questions_file = load_file_lines("questions.txt")
challenges_file = load_file_lines("challenges.txt")
confessions_file = load_file_lines("confessions.txt")
personal_file = load_file_lines("personality.txt")
more_file = load_file_lines("more_file.txt")

# --- ุชุญููู ุงูุฃูุนุงุจ ูู ููู JSON ---
try:
    with open("personality_games.json", "r", encoding="utf-8") as f:
        games_data = json.load(f)
except Exception:
    games_data = {}

# ุชุฑุชูุจ ุงูุฃูุนุงุจ ุญุณุจ ุงูููุชุงุญ
games_list = [games_data[key] for key in sorted(games_data.keys())]

# --- ูุชุงุจุนุฉ ุญุงูุฉ ูู ูุณุชุฎุฏู ---
user_game_state = {}  # user_id: {"game_index": 0, "question_index": 0, "answers": []}

# --- ูุตูุต ุงูุชุญููู ุงูููุตู ููู ูุนุจุฉ ---
detailed_results = {
    "ูุนุจุฉ1": {
        "ุฃ": """ููุจู ูู ุฐูุจ ูุชุถุญู ูู ุฏูู ุชุฑุฏุฏ
ุฃูุช ุดุฎุต ูุณุงูุฏ ุจุทุจูุนุชูุ ูุชุดุนุฑ ุงูุขุฎุฑูู ุจุงูุฃูุงู.  
ุชูุชูู ุงููุฏุฑุฉ ุนูู ุชูุฏูู ุงูุฏุนู ุงูููุณู ูุงููุงุฏูุ ูุชุถุน ุฑุงุญุฉ ุงูุขุฎุฑูู ูุจู ุฑุงุญุชู.  
ูุฏ ุชุชุนุจ ุฃุญูุงููุง ุจุณุจุจ ุงูุชุฒุงูู ุชุฌุงู ุงูุขุฎุฑููุ ููู ูุฐุง ุฌุฒุก ูู ุดุฎุตูุชู ุงููุจููุฉ.  
ุชุนูู ููู ุชุญูู ููุจู ูุทุงูุชู ููู ูุณุชุญู ูุนูุงูุ ูุงุจุชุนุฏ ุนู ุงุณุชุบูุงู ุทูุจุชู.""",
        "ุจ": """ููุจู ููู ูููู ุญุฐุฑ
ุฃูุช ุชุนุทู ุจุญุฏูุฏ ูุชุญุจ ุจุนููุ ุชุนุฑู ูุชู ุชูุชุฑุจ ููุชู ุชุจุชุนุฏ.  
ูุดุงุนุฑู ูุงุถุฌุฉ ูุชุชุนุงูู ูุน ุงูุญูุงุฉ ุจูุนูุ ูุชูุงุฒู ุจูู ุงูุญุจ ูุงูุงุญุชูุงุท.  
ุฎููู ุฃุญูุงููุง ูููุนู ูู ุงูุฏุฎูู ูู ุนูุงูุงุช ุนูููุฉ ุจุณุฑุนุฉุ ููู ูุฐุง ูุฌุนูู ุชุฎุชุงุฑ ุงูุฃุดุฎุงุต ุงูููุงุณุจูู.""",
        "ุฌ": """ููุจู ูุฑูู ูุงูุฒุฌุงุฌ ูููู ููู ูุงูุฌุจุงู
ุชุดุนุฑ ุจูู ุดูุก ุจุนููุ ูุชุคุซุฑ ุจู ุงูุฃุญุฏุงุซ ุณุฑูุนูุง.  
ุชุชุฃุซุฑ ุจุณูููุฉ ูููู ุชุชุนุงูู ุจุตูุชุ ูุชุณุชููุฏ ูู ุชุฌุงุฑุจู ุงูุณุงุจูุฉ ูุชูููุฉ ุดุฎุตูุชู.  
ุฌุฑุญู ูุชุฑู ุฃุซุฑูุงุ ูููู ูุตููู ููุฌุนูู ุฃูุซุฑ ููููุง ูููุณู ูููุขุฎุฑูู."""
    },
    "ูุนุจุฉ2": {
        "ุฃ": """ุฃูุช ุดุฎุต ููู ุงูุชุญูู
ุชูุงุฌู ุงูุตุนูุจุงุช ุจุซูุฉ ูุตุจุฑุ ููุง ุชุณุชุณูู ุจุณูููุฉ.  
ุชุนุชูุฏ ุนูู ููุณู ูุญู ุงููุดููุงุชุ ูุชุชุนูู ูู ูู ุชุฌุฑุจุฉ ูุชุนุฒูุฒ ูุฏุฑุงุชู.  
ูุฏ ูุดุนุฑ ุงูุจุนุถ ุจุตุนูุจุฉ ููุงูุจุชูุ ููู ูุฐุง ูุนูุณ ุนุฒููุชู ูุชุตูููู.""",
        "ุจ": """ุงูููุฉ ุงูุงุฌุชูุงุนูุฉ ูู ุณูุงุญู
ุชุนุชูุฏ ุนูู ุฏุนู ุงูุขุฎุฑููุ ูุชุณุชููุฏ ูู ุงูุนูุงูุงุช ุงููููุฉ ูู ุญูุงุชู.  
ุชุนุฑู ูุชู ุชุณุชุดูุฑ ููุชู ุชุชุญุฑู ุจููุฑุฏู.  
ุดุฎุตูุชู ุชุญุชุฑู ุงูุขุฎุฑูู ูุชูุณุจ ุซูุชูู ุจุณูููุฉ.""",
        "ุฌ": """ุงูููุฉ ุงูุฏุงุฎููุฉ ูุงููุนู ุงูุฐุงุชู
ุชูุชูู ูุนููุง ุนููููุง ุจููุณู ููุฏุฑุงุชูุ ูุชุชุนุงูู ูุน ุงูุญูุงุฉ ุจุชูุงุฒู.  
ุชุฏุฑู ููุงุท ููุชู ูุถุนููุ ูุชุณุนู ูุชุทููุฑ ููุณู ุจุงุณุชูุฑุงุฑ.  
ูุฏ ุชุจุฏู ูุงุฏุฆูุง ููุขุฎุฑููุ ููู ุฏุงุฎูู ูููุก ุจุงูุฅุตุฑุงุฑ ูุงูุชุฑููุฒ."""
    },
    "ูุนุจุฉ3": {
        "ุฃ": """ุญุจ ุงูุฃูุงู ูุงูุซูุฉ
ุฃูุช ุดุฎุต ูุจุญุซ ุนู ุงูุซุจุงุช ูุงูุงุนุชูุงุฏ ุนูู ุงูุดุฑููุ ูุชููู ุฃูููุฉ ูุจูุฑุฉ ููุซูุฉ.  
ุชูุฏุฑ ุงูุงุณุชูุฑุงุฑ ุงูุนุงุทูู ูุชุจุญุซ ุนู ุนูุงูุฉ ูุงุฆูุฉ ุนูู ุงูุงุญุชุฑุงู ูุงูุตุฏู.  
ูุฏ ุชููู ุญุณุงุณูุง ุชุฌุงู ุงูุฎูุงูุฉ ุฃู ุงููุฐุจุ ูุฐูู ุชุฎุชุงุฑ ุดุฑูุงุก ุญูุงุชู ุจุนูุงูุฉ.""",
        "ุจ": """ุญุจ ุงููุฑุญ ูุงูุถุญู
ุชุณุชูุชุน ุจุงูุฃููุงุช ุงูููุชุนุฉ ูุงูุถุญู ูุน ุงูุดุฑููุ ูุชุญุจ ูุดุงุฑูุฉ ุงูุณุนุงุฏุฉ.  
ุชุจุญุซ ุนู ุนูุงูุฉ ูููุฆุฉ ุจุงูุญูููุฉ ูุงูุทุงูุฉ ุงูุฅูุฌุงุจูุฉ.  
ูุฏ ุชุชุฌูุจ ุงูุฌุฏูุฉ ุฃุญูุงููุงุ ููู ุชูุงุฒู ุงููุฑุญ ูุน ุงูุงูุชุฒุงู ูุธูุฑ ูุถุฌู ุงูุนุงุทูู.""",
        "ุฌ": """ุญุจ ุงูุชูุงูู ูุงูุฏุนู
ุฃูุช ุดุฎุต ูุณุนู ููุชูุงูู ุงูุนููู ูุงูุฏุนู ุงููุชุจุงุฏู.  
ุชูุฏุฑ ุงูุญูุงุฑ ุงูุตุงุฏู ูุชุดุนุฑ ุจุงููุณุคูููุฉ ุชุฌุงู ูุดุงุนุฑ ุงูุขุฎุฑูู.  
ูุฏ ุชุชุญูู ุงููุซูุฑ ูู ุงููุดุงุนุฑุ ููู ูุฐุง ูุฌุนูู ุดุฑูููุง ูุฎูุตูุง ููุชููููุง."""
    },
    "ูุนุจุฉ4": {
        "ุฃ": """ุณูุงู ุงูุงูุนุฒุงู ุงูุฐุงุชู
ุชููู ูููุฏูุก ูุงูุชุฃููุ ูุชุฌุฏ ุงูุฑุงุญุฉ ูู ููุชู ุงูุฎุงุต.  
ุชุชุนุงูู ูุน ุงูุถุบูุท ุจุงูุชูููุฑ ูุงูุชุฃูู ุงูุฏุงุฎููุ ูุชุนูุฏ ุชุฑุชูุจ ุฃููุงุฑู ุจูุฏูุก.  
ูุฏ ูุฑุงู ุงูุขุฎุฑูู ููุนุฒููุงุ ูููู ุชุณุชุฎุฏู ุงูููุช ูุชูููุฉ ููุณู.""",
        "ุจ": """ุณูุงู ุงููุดุงุท ูุงูุญุฑูุฉ
ุชุญุจ ุงูุงูุฎุฑุงุท ูู ุงููุดุงุทุงุช ูุงูุญุฑูุฉ ููุชุฎูุต ูู ุงูุชูุชุฑ.  
ุชุนุชูุฏ ุนูู ุงููุดุงุท ุงูุจุฏูู ุฃู ุงูููุงูุงุช ูุชุตููุฉ ุฐููู.  
ูุฐู ุงูุทุฑููุฉ ุชููุญู ุทุงูุฉ ุฅูุฌุงุจูุฉ ูุชูุงุฒูู ุงูููุณู.""",
        "ุฌ": """ุณูุงู ุงูุฑุถุง ุงูุฏุงุฎูู
ุชุฑูุฒ ุนูู ูุจูู ูุง ูุง ููููู ุชุบููุฑู ูุชุญููู ุงูุชูุงุฒู ุงูููุณู.  
ุชูุชูู ูุฏุฑุฉ ุนูู ุงูุชุนุงูู ูุน ุงูุตุนูุจุงุช ุจุตุจุฑ ููุนู.  
ุชุชุนูู ูู ุงูุชุฌุงุฑุจ ูุชุทูุฑ ููุณู ุจุงุณุชูุฑุงุฑ ูููุตูู ูุฑุงุญุฉ ุฏุงุฎููุฉ ุญููููุฉ."""
    },
    "ูุนุจุฉ5": {
        "ุฃ": """ุทููุญ ุดุฎุตู ูุณุชูู
ุชุณุนู ูุชุญููู ุฃูุฏุงูู ุจููุณูุ ูุชุนุชูุฏ ุนูู ููุชู ูุฅุตุฑุงุฑู.  
ุชูุงุฌู ุงูุชุญุฏูุงุช ุฏูู ุงูุงุนุชูุงุฏ ุงููุงูู ุนูู ุงูุขุฎุฑููุ ูุชุชุนูู ูู ูู ุชุฌุฑุจุฉ.  
ูุฏ ุชููู ุตูุจูุง ูู ุงุชุฎุงุฐ ุงููุฑุงุฑุงุชุ ููู ูุฐุง ูุถูู ูู ุงููุฌุงุญ ุงูุญูููู.""",
        "ุจ": """ุทููุญ ุงุฌุชูุงุนู
ุชุณุนู ูุชุญููู ุฃูุฏุงูู ุจูุดุงุฑูุฉ ุงูุขุฎุฑูู ูุงูุฏุนู ุงููุชุจุงุฏู.  
ุชุคูู ุจููุฉ ุงููุฑูู ูุงูุชุนุงููุ ูุชูุฏุฑ ุงูุฃููุงุฑ ุงููุฎุชููุฉ.  
ุดุฎุตูุชู ูุชุนุงููุฉ ูุชุญุจ ุจูุงุก ุนูุงูุงุช ูููุฉ ูุชุญููู ุงููุฌุงุญ.""",
        "ุฌ": """ุทููุญ ูุฏุฑูุณ ููุงุนู
ุชุฎุทุท ููู ุฎุทูุฉ ุจุญููุฉ ููุนูุ ูุชูุงุฒู ุจูู ุงูุทููุญ ูุงููุงูุนูุฉ.  
ุชุนุชูุฏ ุนูู ุชูููู ุงููุฑุต ูุงููุฎุงุทุฑ ูุจู ุงุชุฎุงุฐ ุงููุฑุงุฑ.  
ุชุณุนู ูุชุญููู ุงูุฅูุฌุงุฒุงุช ุจุทุฑููุฉ ูุชุฒูุฉ ููุณุชุฏุงูุฉ."""
    },
    "ูุนุจุฉ6": {
        "ุฃ": """ุชูููุฑ ุนููู ูุญู ุงููุดููุงุช
ุชุนุชูุฏ ุนูู ุงูููุทู ูุงูุชุญูููุ ูุชุณุนู ูุญู ูู ูุดููุฉ ุจุทุฑููุฉ ุนูููุฉ.  
ุชุณุชููุฏ ูู ุฎุจุฑุงุชู ูุชุฌุงุฑุจู ูุชุฌูุจ ุงูุฃุฎุทุงุก.  
ูุฏ ูุฑุงู ุงูุจุนุถ ุนููุงูููุง ุฌุฏูุงุ ููู ูุฐู ุงูุทุฑููุฉ ุชุฌุนูู ูุนุงููุง ูู ุญูุงุชู.""",
        "ุจ": """ุชูููุฑ ุงุฌุชูุงุนู ููุดุงุฑู
ุชุคูู ุจููุฉ ุงููุดุงุฑูุฉ ููุณุงุนุฏุฉ ุงูุขุฎุฑููุ ูุชุณุชุดูุฑ ุนูุฏ ุงูุญุงุฌุฉ.  
ุชุณุนู ูุชุจุงุฏู ุงูุฎุจุฑุงุช ูุงููุนุฑูุฉุ ูุชูุฏุฑ ุงูุนูุงูุงุช ุงูุฅูุณุงููุฉ.  
ูุฐุง ุงูุชูููุฑ ูุฌุนูู ูุญุจูุจูุง ููุคุซุฑูุง ูู ูุญูุทู.""",
        "ุฌ": """ุชูููุฑ ูุงุฏุฆ ููุชูุงุฒู
ุชููู ููุชูููุฑ ุงูุนููู ูุงุชุฎุงุฐ ุงููุฑุงุฑุงุช ุจุฑููุฉ.  
ุชูุงุฒู ุจูู ุงููุดุงุนุฑ ูุงูููุทูุ ูุชุจุญุซ ุนู ุฃูุถู ุงูุญููู ุจูุฏูุก.  
ูุฐุง ูููุญู ุณูุงููุง ุฏุงุฎูููุง ููุฏุฑุฉ ุนูู ุงูุชุนุงูู ูุน ุงูุญูุงุฉ ุจุซูุฉ."""
    },
    "ูุนุจุฉ7": {
        "ุฃ": """ุตุฏูู ูุฎูุต ููุณุคูู
ุฃูุช ุฏุงุฆููุง ุญุงุถุฑ ููุณุงุนุฏุฉ ุฃุตุฏูุงุฆูุ ูุชุชุญูู ุงููุณุคูููุฉ ุนู ุนูุงูุงุชู.  
ุชุนุชูุฏ ุนูู ุงูุตุฏู ูุงูููุงุกุ ูุชุญุจ ุชูุฏูู ุงูุฏุนู ุฏูู ุงูุชุธุงุฑ ููุงุจู.  
ูุฏ ูุฑุงู ุงูุจุนุถ ุตุงุฑููุง ุฃุญูุงููุงุ ููู ูุฐุง ูุนูุณ ุฅุฎูุงุตู ูุตุฏูู.""",
        "ุจ": """ุตุฏูู ูุฑุญ ูููุชุน
ุชุชูุชุน ุจุฑูุญ ูุฑุญุฉุ ูุชุญุจ ูุดุฑ ุงูุณุนุงุฏุฉ ุจูู ุฃุตุฏูุงุฆู.  
ุชุนุทู ุทุงูุฉ ุฅูุฌุงุจูุฉ ูุชุณุงุนุฏ ุนูู ุงูุชุฎููู ูู ุงูุชูุชุฑ.  
ูุฏ ุชุจุฏู ุบูุฑ ุฌุฏู ุฃุญูุงููุงุ ููู ุฃุตุฏูุงุคู ููุฏูุฑูู ูุฑููุชู ูุฑูุญู ุงููุฑุญุฉ.""",
        "ุฌ": """ุตุฏูู ูุงุฏุฆ ููุชูุงูู
ุชูุชูู ูุฏุฑุฉ ุนูู ุงูุงุณุชูุงุน ูุงูุชูููุ ูุชุชุนุงูู ูุน ุงูุฃุตุฏูุงุก ุจุตุจุฑ ููุนู.  
ุชูุถู ุญู ุงููุดููุงุช ุจุงูุญูุงุฑ ูุงููุฏูุกุ ูุชุฌูุจ ุงูุตุฑุงุนุงุช ูุฏุฑ ุงูุฅููุงู.  
ูุฐุง ูุฌุนู ููู ุตุฏูููุง ูุนุชูุฏ ุนููู ููุซู ุจู ุงูุขุฎุฑูู."""
    },
    "ูุนุจุฉ8": {
        "ุฃ": """ูุฑุงุฑ ุณุฑูุน ููุงุซู
ุชุซู ุจุญุฏุณู ูุชุชุฎุฐ ุงููุฑุงุฑุงุช ุจุณุฑุนุฉ ุนูุฏ ุงูุญุงุฌุฉ.  
ุชุนุชูุฏ ุนูู ุฎุจุฑุงุชู ููุนูููุงุชู ุฏูู ุชุฑุฏุฏ.  
ูุฏ ุชููู ุฃุญูุงููุง ููุฏูุนูุงุ ููู ุซูุชู ุจููุณู ุชุณุงุนุฏู ุนูู ุงููุถู ูุฏููุง ุจุซุจุงุช.""",
        "ุจ": """ูุฑุงุฑ ุชุนุงููู ููุดุชุฑู
ุชุณุชุดูุฑ ุงูุขุฎุฑูู ูุจู ุงุชุฎุงุฐ ุงููุฑุงุฑุงุชุ ูุชูุฏุฑ ูุฌูุงุช ุงููุธุฑ ุงููุฎุชููุฉ.  
ุชุนูู ุนูู ุชุญููู ุชูุงุฒู ุจูู ุฑุฃูู ูุฑุฃู ุงูุขุฎุฑูู.  
ูุฐุง ูููุญู ูุฑุงุฑุงุช ูุฏุฑูุณุฉ ูุนุงุฏูุฉุ ูููุณุจู ุงุญุชุฑุงู ุงููุญูุทูู.""",
        "ุฌ": """ูุฑุงุฑ ูุฏุฑูุณ ููุงุนู
ุชููู ุจุชุญููู ูู ุงูุฎูุงุฑุงุช ุจุนูุงูุฉ ูุจู ุงุชุฎุงุฐ ุฃู ูุฑุงุฑ.  
ุชูุงุฒู ุจูู ุงููุฎุงุทุฑ ูุงูููุงุฆุฏุ ูุชุจุญุซ ุนู ุงูุญู ุงูุฃูุซู ููุฌููุน.  
ูุฐุง ูุฌุนูู ุดุฎุตูุง ุญุฐุฑูุง ูููุซูููุง ูู ุงุชุฎุงุฐ ุงููุฑุงุฑุงุช ุงููุงูุฉ."""
    },
    "ูุนุจุฉ9": {
        "ุฃ": """ุญูู ุดุฎุตู ูุณุชูู
ุชุฑูุฒ ุนูู ุชุญููู ุฃูุฏุงูู ุจููุณูุ ูุชุณุนู ูุชุทููุฑ ููุงุฑุงุชู ููุฏุฑุงุชู.  
ุชุชูุชุน ุจุงูุฅุตุฑุงุฑ ูุงููุซุงุจุฑุฉุ ูุชูุงุฌู ุงูุชุญุฏูุงุช ุจุซูุฉ.  
ูุฐุง ูุถูู ูู ุงููุฌุงุญ ุงูุฐุงุชู ููุฌุนูู ูุฏูุฉ ููู ุญููู.""",
        "ุจ": """ุญูู ุงุฌุชูุงุนู
ุชูุชู ุจุฅุณุนุงุฏ ุงูุขุฎุฑูู ูุชุญููู ูุฑู ูู ุญูุงุชูู.  
ุชูุฏุฑ ุงูุชุนุงูู ูุงููุดุงุฑูุฉุ ูุชุณุนู ูุชุฑู ุฃุซุฑ ุฅูุฌุงุจู ูู ูุญูุทู.  
ูุฐุง ูุนูุณ ุฑูุญู ุงูุฅูุณุงููุฉ ููุฌุนู ููู ุดุฎุตูุง ูุญุจูุจูุง ูููุซูููุง.""",
        "ุฌ": """ุญูู ูุชูุงุฒู ููุงุนู
ุชูุงุฒู ุจูู ุทููุญู ุงูุดุฎุตู ููุณุงุนุฏุฉ ุงูุขุฎุฑูู.  
ุชุณุนู ูุชุญููู ุฑุถุง ุฏุงุฎูู ูุงุณุชูุฑุงุฑ ุนุงุทููุ ูุน ูุฑุงุนุงุฉ ูุญูุทู ุงูุงุฌุชูุงุนู.  
ูุฐุง ูููุญู ุฑุคูุฉ ูุงุถุญุฉ ููุณุชูุจู ูุชูุงุฒู."""
    },
    "ูุนุจุฉ10": {
        "ุฃ": """ุณูุงู ุงูุงูุนุฒุงู ุงูุฐุงุชู
ุชุญุจ ุฃู ุชููู ูุน ููุณู ูุชุฌุฏูุฏ ุงูุทุงูุฉ ูุงูุชุฑููุฒ.  
ุชุชุนุงูู ูุน ุงูุชูุชุฑ ุจุถุจุท ุงูููุณ ูุงูุชุฃูู.  
ุชูุชูู ูุฏุฑุฉ ุนูู ุงูุชุญููู ุงูุฏุงุฎูู ูุงูุชูุงุฒู ุงูููุณู.""",
        "ุจ": """ุณูุงู ุงููุดุงุท ูุงูุญุฑูุฉ
ุชุนุชูุฏ ุนูู ุงููุดุงุท ุงูุจุฏูู ูุงูููุงูุงุช ููุชุฎูุต ูู ุงูุชูุชุฑ.  
ุชุฌุฏ ูู ุงูุญุฑูุฉ ูุงูุทุงูุฉ ุงูุฅูุฌุงุจูุฉ ูุณููุฉ ูุชูุงุฒู ุญูุงุชู.  
ูุฐุง ูุฌุนูู ุดุฎุตูุง ูุดูุทูุง ููููุฆูุง ุจุงูุญูููุฉ.""",
        "ุฌ": """ุณูุงู ุงูุฑุถุง ุงูุฏุงุฎูู
ุชุฑูุฒ ุนูู ุงููุจูู ุงูุฏุงุฎูู ูุงูุชูุงุฒู ุงูููุณู.  
ุชุนุฑู ููู ุชุณุชููุฏ ูู ุชุฌุงุฑุจู ูุชุนูุด ุจุณูุงู ูุฑุถุง.  
ุชุชูุชุน ุจุญููุฉ ููุฏุฑุฉ ุนูู ุงูุชุนุงูู ูุน ุงูุตุนูุจุงุช ุจูุฏูุก."""
    }
}

# --- ูุคุดุฑุงุช ููู ูุณุชุฎุฏู ููุฃูุงูุฑ ุงูุฃุฎุฑู ---
user_indices = {"ุณุคุงู":{}, "ุชุญุฏู":{}, "ุงุนุชุฑุงู":{}, "ุดุฎุตู":{}, "ุฃูุซุฑ":{}}
global_indices = {"ุณุคุงู":0, "ุชุญุฏู":0, "ุงุนุชุฑุงู":0, "ุดุฎุตู":0, "ุฃูุซุฑ":0}

# --- ูุงููุณ ุงููุฑุงุฏูุงุช ููู ุฃูุฑ ---
commands_map = {
    "ุณุคุงู": ["ุณุคุงู", "ุณูุงู", "ุงุณุฃูู", "ุงุณุฆูุฉ"],
    "ุชุญุฏู": ["ุชุญุฏู", "ุชุญุฏูุงุช", "ุชุญุฏ"],
    "ุงุนุชุฑุงู": ["ุงุนุชุฑุงู", "ุงุนุชุฑุงูุงุช"],
    "ุดุฎุตู": ["ุดุฎุตู", "ุดุฎุตูุฉ", "ุดุฎุตูุงุช"],
    "ุฃูุซุฑ": ["ุฃูุซุฑ", "ุงูุซุฑ"]
}

@app.route("/", methods=["GET"])
def home():
    return "ุงูุจูุช ูุนูู", 200

@app.route("/callback", methods=["POST"])
def callback():
    signature = request.headers.get("X-Line-Signature", "")
    body = request.get_data(as_text=True)
    try:
        handler.handle(body, signature)
    except InvalidSignatureError:
        abort(400)
    return "OK"

@handler.add(MessageEvent, message=TextMessage)
def handle_message(event):
    user_id = event.source.user_id
    text = event.message.text.strip().lower()

    # --- ูุณุงุนุฏุฉ ---
    if text == "ูุณุงุนุฏุฉ":
        help_text = (
            "ุงูุฃูุงูุฑ ุงููุชุงุญุฉ:\n"
            "- ุณุคุงู\n"
            "- ุดุฎุตู\n"
            "- ุชุญุฏู\n"
            "- ุงุนุชุฑุงู\n"
            "- ุฃูุซุฑ\n"
            "- ูุนุจู"
        )
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text=help_text))
        return

    # --- ุฃูุงูุฑ ุงูุฃูุนุงุจ ุงูุฃุฎุฑู ---
    command = None
    for key, variants in commands_map.items():
        if text in [v.lower() for v in variants]:
            command = key
            break

    if command:
        if command == "ุณุคุงู":
            file_list = questions_file
        elif command == "ุชุญุฏู":
            file_list = challenges_file
        elif command == "ุงุนุชุฑุงู":
            file_list = confessions_file
        elif command == "ุดุฎุตู":
            file_list = personal_file
        elif command == "ุฃูุซุฑ":
            file_list = more_file

        if file_list:
            index = global_indices[command]
            msg = file_list[index]
            line_bot_api.reply_message(event.reply_token, TextSendMessage(text=msg))
            global_indices[command] = (index + 1) % len(file_list)
            user_indices[command][user_id] = global_indices[command]
        else:
            line_bot_api.reply_message(event.reply_token, TextSendMessage(text=f"ูุง ุชูุฌุฏ ุจูุงูุงุช ูู {command} ุญุงููุงู."))
        return

    # --- ุจุฏุก ูุนุจุฉ ุงูุดุฎุตูุฉ ---
    if text == "ูุนุจู":
        games_titles = "\n".join([
            "1. ุฃู ููุน ูู ุงููููุจ ุชูุชูู",
            "2. ุงูุฃุญูุงู ูุงูุทููุญุงุช ุงูุดุฎุตูุฉ",
            "3. ุงูุณุนุงุฏุฉ ุงูุฏุงุฎููุฉ",
            "4. ุงูููุฉ ุงูุดุฎุตูุฉ",
            "5. ุงูุญุจ ูุงูุนูุงูุงุช",
            "6. ุงูุณูุงู ุงูุฏุงุฎูู",
            "7. ุงูุทููุญ ูุงููุฌุงุญ",
            "8. ุงูุชูููุฑ ุงูุฅูุฌุงุจู",
            "9. ุงูุตุฏุงูุฉ ูุงูุนูุงูุงุช ุงูุงุฌุชูุงุนูุฉ",
            "10. ุงููุฑุงุฑุงุช ุงูุญูุงุชูุฉ"
        ])
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text=f"ุงุฎุชุฑ ุงููุนุจุฉ ูุชุจุฏุฃ:\n{games_titles}"))
        return

    # --- ุงุฎุชูุงุฑ ุฑูู ุงููุนุจุฉ ---
    if text.isdigit():
        num = int(text)
        if 1 <= num <= len(games_list):
            game_index = num - 1
            user_game_state[user_id] = {"game_index": game_index, "question_index": 0, "answers": []}
            first_question = games_list[game_index]["questions"][0]
            options_text = "\n".join([f"{k}: {v}" for k, v in first_question["options"].items()])
            line_bot_api.reply_message(event.reply_token, TextSendMessage(text=f"{first_question['question']}\n{options_text}"))
        return

    # --- ุงูุฑุฏ ุนูู ุณุคุงู ุฏุงุฎู ุงููุนุจุฉ ---
    if user_id in user_game_state:
        state = user_game_state[user_id]
        answer = text.strip()
        if answer in ["ุฃ", "ุจ", "ุฌ", "1", "2", "3"]:
            mapping = {"1": "ุฃ", "2": "ุจ", "3": "ุฌ"}
            answer = mapping.get(answer, answer)
            state["answers"].append(answer)

            game = games_list[state["game_index"]]
            state["question_index"] += 1

            if state["question_index"] < len(game["questions"]):
                q = game["questions"][state["question_index"]]
                options_text = "\n".join([f"{k}: {v}" for k, v in q["options"].items()])
                line_bot_api.reply_message(event.reply_token, TextSendMessage(text=f"{q['question']}\n{options_text}"))
            else:
                # ููุงูุฉ ุงููุนุจุฉุ ุนุฑุถ ุงููุชูุฌุฉ ุงูููุตูุฉ
                a_count = {"ุฃ": 0, "ุจ": 0, "ุฌ": 0}
                for ans in state["answers"]:
                    if ans in a_count:
                        a_count[ans] += 1
                most = max(a_count, key=a_count.get)

                game_key = list(games_data.keys())[state["game_index"]]
                detailed_text = detailed_results.get(game_key, {}).get(most, "")
                line_bot_api.reply_message(event.reply_token, TextSendMessage(text=f"๐ ุงููุชูุฌุฉ:\n{detailed_text}"))
                del user_game_state[user_id]

if __name__ == "__main__":
    port = int(os.getenv("PORT", 5000))
    app.run(host="0.0.0.0", port=port)
