from flask import Flask, request, abort
from linebot import LineBotApi, WebhookHandler
from linebot.exceptions import InvalidSignatureError
from linebot.models import MessageEvent, TextMessage, TextSendMessage
import random, os

app = Flask(__name__)

LINE_CHANNEL_ACCESS_TOKEN = os.environ.get('LINE_CHANNEL_ACCESS_TOKEN')
LINE_CHANNEL_SECRET = os.environ.get('LINE_CHANNEL_SECRET')

line_bot_api = LineBotApi(LINE_CHANNEL_ACCESS_TOKEN)
handler = WebhookHandler(LINE_CHANNEL_SECRET)

# -------------------------------
# ุงูุฃุณุฆูุฉ ุงูู200 ุญุจ/ุตุฑุงุญุฉ/ุฑููุงูุณูุฉ
# -------------------------------
questions = [
"ูุง ุฃูุซุฑ ุดูุก ุชุญุจู ูู ุดุฑูู ุญูุงุชูุ",
"ุงุนุชุฑู ุจุดูุก ุชุฎููู ุนูู.",
"ูู ุณุจู ููุฏูุช ุนูู ุชุตุฑู ูุน ุดุฑูููุ",
"ูู ุชุบุงุฑ ุนููู ูุซูุฑุ",
"ูู ุชุดุนุฑ ุฃูู ููููู ุจุฏูู ููุงูุ",
"ูุง ุฃูู ุดูุก ุฌุฐุจู ูููุ",
"ูู ุชุนุชุจุฑ ููุณู ุงูุทุฑู ุงูุฃูุซุฑ ุญุจุงูุ",
"ูู ุชุญุจ ุงูููุงุฌุขุช ุงูุฑููุงูุณูุฉุ",
"ูุง ุฃูุซุฑ ุดูุก ูุฌุนูู ุชุจุชุณู ูุนูุ",
"ูุง ุฃุฌูู ุฐูุฑู ุจููููุงุ",
"ูู ุชุซู ุจู ุซูุฉ ูุงููุฉุ",
"ูู ุชุญุจ ุชุจุฏุฃ ุจุงููุตุงูุญุฉ ุฃู ุชูุชุธุฑุ",
"ูุง ุฃูู ุดุนูุฑ ุญุณููุชู ููุง ุดูุชู ุฃูู ูุฑุฉุ",
"ูุง ุฃูุซุฑ ุชุตุฑู ูุฎููู ููุณุจ ุฑุถุงู ุจุณุฑุนุฉุ",
"ูู ุชูุถู ุงูููุงููุงุช ุงูุทูููุฉ ุฃู ุงูุฑุณุงุฆู ุงููุตูุฑุฉุ",
"ูู ุณุจู ุจููุช ูู ุดููู ููุ",
"ูู ุชุชุฎูู ุงููุณุชูุจู ูุนูุ",
"ูุง ุฃูุซุฑ ูููุฉ ุชุญุจ ุชุณูุนูุง ูููุ",
"ูู ุชุญุจ ุงูููุงุฌุขุช ุงูุจุณูุทุฉุ",
"ูุง ุฃูุซุฑ ุดูุก ูุฐูุฑู ููู ุนูุฏูุง ูุบูุจุ",
"ุงุนุชุฑู ุจุฃุบุฑุจ ุดุนูุฑ ุดุนุฑุช ุจู ุชุฌุงู ุดุฑููู.",
"ุงุนุชุฑู ุจุฃูุจุฑ ุฎุทุฃ ุงุฑุชูุจุชู ูู ุงูุนูุงูุฉ.",
"ูุง ุฃูุซุฑ ูููู ุฌุฑูุก ููุช ุจู ูุน ุดุฑูู ุญูุงุชู.",
"ูุง ุฃูุซุฑ ูุญุธุฉ ุฑููุงูุณูุฉ ุฌุนูุชู ุชุดุนุฑ ุจุงูุดุบู.",
"ูู ุณุจู ุฃู ุฌุฑุจุช ุดูุฆุงู ุฌุฏูุฏุงู ูุนู ุฃู ูุนูุง.",
"ูุง ุฃูุซุฑ ุฑุบุจุฉ ุฑููุงูุณูุฉ ุชุชููู ุชุญููููุง ูุน ุดุฑููู.",
"ูุง ุฃูุซุฑ ุดูุก ูุซูุฑู ุนุงุทููุงู ุนูุฏ ุดุฑููู.",
"ุงุนุชุฑู ุจุฃูุซุฑ ุชุตุฑู ุฌุฐุจู ูุดุฑููู.",
"ูุง ุฃูุซุฑ ุดูุก ุชุญุจ ูุนูู ูุนู ูู ุงููุญุธุงุช ุงูุฎุงุตุฉ.",
"ูู ุณุจู ุฃู ุดุนุฑุช ุจุงูุบูุฑุฉ ูู ุงูุนูุงูุฉ.",
"ูู ุณุจู ุฃู ุฃุฑุณูุช ุฑุณุงูุฉ ุญุจ ุบูุฑ ูุชููุนุฉ.",
"ูุง ุฃูุซุฑ ุดูุก ุชุฎุงู ุฃู ููุนูู ุดุฑููู.",
"ูู ุชุฑุบุจ ุจุงูููุงุฌุขุช ุฃู ุงูุชุฎุทูุท ุงููุณุจู.",
"ูุง ุฃูุซุฑ ุชุตุฑู ุญููู ูุงู ุจู ูุนู.",
"ูุง ุฃุทุฑู ูููู ุญุตู ูุนู ุฃุซูุงุก ุงูุนูุงูุฉ.",
"ุงุนุชุฑู ุจุฃูุซุฑ ูููู ุดุนุฑุช ููู ุจุงูุฎูู ุนููู.",
"ูุง ุฃูุซุฑ ุดูุก ูุฌุนูู ุชุดุนุฑ ุจุงูุญุจ ุงูุญูููู.",
"ูุง ุฃูุซุฑ ูุญุธุฉ ุฌุนูุชู ุชุดุนุฑ ุจุงูุณุนุงุฏุฉ ูุนู ุฃู ูุนูุง.",
"ุงุนุชุฑู ุจูููู ุดุนุฑุช ููู ุจุงูุญุฑุฌ ุฃูุงูู.",
"ูุง ุฃูุซุฑ ุตูุฉ ุชุญุจูุง ููู ุฃู ูููุง.",
"ูุง ุฃูุซุฑ ูุญุธุฉ ุฑููุงูุณูุฉ ุชุชููู ุชูุฑุงุฑูุง.",
"ูู ุณุจู ุฃู ุดุนุฑุช ุจุงูุฑุบุจุฉ ูู ุงููุฑูุจ ูุนู ุฃู ูุนูุง.",
"ูุง ุฃูุซุฑ ุดูุก ูุฐูุฑู ุจุดุฑููู ุนูุฏ ุงูุงุจุชุนุงุฏ.",
"ูู ุณุจู ุฃู ุฃุฎุจุฑุช ุดุฎุตุงู ุณุฑุง ุนู ุนูุงูุชู.",
"ูู ุณุจู ุฃู ูุชุจุช ูู ุฑุณุงูุฉ ุญุจ ุทูููุฉ.",
"ูุง ุฃูุซุฑ ุดูุก ูุฌุนูู ุชุดุชุงู ูู ุฃู ููุง.",
"ูุง ุฃูุซุฑ ุดูุก ุชุชููู ูุนูู ูุนู ูู ุงููุณุงุก.",
"ูุง ุฃูุซุฑ ูููุฉ ุฑููุงูุณูุฉ ููุชูุง ูู ุฃู ููุง.",
"ูุง ุฃูุซุฑ ุดูุก ูุฌุนูู ุชุญุณ ุจุงูุญุจ ุงูุนููู.",
"ูุง ุฃูุซุฑ ูููู ูุถุญู ุญุตู ุจููููุง.",
"ูุง ุฃูุซุฑ ุชุตุฑู ูุซูุฑ ุบูุฑุชู.",
"ุงุนุชุฑู ุจุฃูุซุฑ ูููู ุฌุนูู ุชูุฏู.",
"ูู ุณุจู ุฃู ุดุนุฑุช ุจุงูุจุฑูุฏ ูู ุงูุนูุงูุฉุ",
"ูุง ุฃูุซุฑ ุดูุก ูุนูุฏ ุงูุดุบู ุจููููุงุ",
"ูู ุชุซู ุจุดุฑููู ุซูุฉ ูุงููุฉุ",
"ูุง ุฃูุซุฑ ูุญุธุฉ ุฌุนูุชู ุชููู ูู ููุณู (ุฃูุง ูุญุธูุธ ุจู).",
"ูู ุณุจู ุฃู ุฎุฐูุช ุดุฑูููุ",
"ูุง ุฃูุซุฑ ุดูุก ูุฌุนูู ุชุบูุฑ ุจุณุฑุนุฉุ",
"ูู ุชูุถู ุงูุนูุงูุฉ ุงููุงุฏุฆุฉ ุฃู ุงููููุฆุฉ ุจุงูููุงุฌุขุชุ",
"ูุง ุฃูุซุฑ ูุญุธุฉ ุดุนุฑุช ูููุง ุฃู ุญุจูู ูุถุฌุ",
"ูู ุชุนุชุจุฑ ุงูุบูุฑุฉ ุฏููู ุญุจุ",
"ูู ุณุจู ุฃู ุชุฎููุช ุญูุงุชู ุจุฏูููุ",
"ูุง ุฃูุซุฑ ุดูุก ูุฑุจุทู ููู ุฑูุญูุงูุ",
"ุงุนุชุฑู ุจุฃูุซุฑ ุณุฑ ูุง ูุนุฑูู ุนูู.",
"ูู ุณุจู ุฃู ุจููุช ุจุณุจุจูุ",
"ูุง ุฃูุซุฑ ุดุนูุฑ ุชุญุจ ุฃู ููุฏูู ููุ",
"ูู ุณุจู ุฃู ุญุณูุช ุฃูู ุชุญุจู ุฃูุซุฑ ููุง ูุญุจูุ",
"ูุง ุฃูุซุฑ ุชุตุฑู ูุฌุนูู ุชุฑุชุงุญ ููุ",
"ูุง ุฃูุซุฑ ูุญุธุฉ ููุช ูููุง (ุฃูุง ุฃุญุจู ูุนูุงู).",
"ูุง ุฃูุซุฑ ุดูุก ุชูุชูุฏู ุฅุฐุง ุบุงุจุ",
"ูุง ุฃูุซุฑ ุดูุก ูุฌุนูู ุชุดุชุงู ููุ",
"ูู ุณุจู ุฃู ุญุณูุช ุจุงูุฎุฐูุงู ูููุ",
"ูุง ุฃูุซุฑ ูููุฉ ุชููููุง ูู ุฏุงุฆูุงูุ",
"ูู ุชุดุนุฑ ุฃู ุงูุนูุงูุฉ ุชุญุชุงุฌ ุชุฌุฏูุฏุ",
"ูุง ุฃูุซุฑ ุดูุก ูุฌุนูู ุชุดุนุฑ ุฃูู ูุญุจูุจุ",
"ูู ุณุจู ุฃู ุชูููุช ุฃู ุชุนุฑู ูุง ูููุฑ ูููุ",
"ูุง ุฃูุซุฑ ูุญุธุฉ ุฑููุงูุณูุฉ ุญููุช ุจูุง ูุนูุ",
"ูู ุชุญุจ ุฃู ุชุจุฏุฃ ุจุงููุตุงูุญุฉ ุฃู ุชูุชุธุฑุ",
"ุงุนุชุฑู ุจุฃูุซุฑ ุดูุก ุชุญุจ ูู ุดุฎุตูุชู.",
"ูุง ุฃูุซุฑ ุดูุก ุชุชููู ูุชุบูุฑ ูููุ",
"ูู ุชุดุนุฑ ุฃู ุญุจูู ูุฒูุฏ ูุน ุงูููุชุ",
"ูู ุชุญุจ ุงูููุงุฌุขุช ุฃู ุงูููุงู ุงูุตุงุฏู ุฃูุซุฑุ",
"ูุง ุฃูุซุฑ ุดูุก ูุดุนุฑู ุจุงูุฃูุงู ูุนูุ",
"ูุง ุฃูุซุฑ ุชุตุฑู ูุฌุนู ูููู ุฃุฌููุ",
"ูู ุณุจู ุฃู ูุฏูุช ุนูู ุชุตุฑู ูุน ุดุฑูููุ",
"ูู ุชุญุจ ุฃู ุชุณูุน ูููุฉ ุฃุญุจู ูุซูุฑุงูุ",
"ูุง ุฃูุซุฑ ููุงู ุชุชููู ุชูุถู ููู ููุช ูุน ุดุฑูููุ",
"ูุง ุฃูุซุฑ ูุญุธุฉ ุชูููุช ุงูุฒูู ูุชููู ูููุง ูุนูุ",
"ูู ุชุญุจ ุงูุตุฑุงุญุฉ ุงููุทููุฉุ",
"ูุง ุฃูุซุฑ ุดูุก ูุฌุนูู ุชุถุญู ูุนูุ",
"ูุง ุฃูุซุฑ ุตูุฉ ุชุฌุนูู ุชุฐูุจ ุญุจุงูุ",
"ูุง ุฃูุซุฑ ูุญุธุฉ ุชูููุช ูููุง ูุฑุจูุ",
"ูู ุชุดุนุฑ ุฃูู ููููู ุจุฏูู ููุงูุ",
"ูุง ุฃูุซุฑ ุดูุก ูุฌุนูู ุชุบุถุจ ูููุ",
"ูู ุชูุถู ุงูููุงู ุฃู ุงูุฃูุนุงู ูู ุงูุญุจุ",
"ูุง ุฃูุซุฑ ุฐูุฑู ูุง ุชูุณุงูุง ูุนูุ",
"ูุง ุฃูุซุฑ ูููู ุฌุนูู ุชุญุณ ุฃูู ููู ููุ",
"ูู ุงูุญุจ ุนูุฏู ุชุถุญูุฉ ุฃู ูุดุงุฑูุฉุ",
"ุงุนุชุฑู ุจุฃูู ุดุนูุฑ ุดุนุฑุช ุจู ุชุฌุงูู.",
"ูู ุชุดุนุฑ ุฃูู ุชุจุงุฏุฑ ุจุงูุญุจ ุฃูุซุฑุ",
"ูุง ุฃูุซุฑ ูููุฉ ูููููุง ูุชุคุซุฑ ูููุ",
"ูู ุณุจู ุฃู ุชุฎููุช ุนู ูุจุฑูุงุฆู ูู ุฃุฌููุ",
"ูุง ุฃูุซุฑ ุดูุก ุชุญุจู ูู ุถุญูุชูุ",
"ูู ุชุดุนุฑ ุฃูู ูุญุจู ููุง ุฃูุชุ",
"ูุง ุฃูุซุฑ ุชุตุฑู ูุฌุนูู ุชุดุชุงู ูู ููุฑุงูุ",
"ูู ุชุญุจ ุงูุฑุณุงุฆู ุงูุทูููุฉ ุฃู ุงููุตูุฑุฉุ",
"ูุง ุฃูุซุฑ ูููุฉ ุชุฑุจุทู ุจู ููุฃุจุฏุ"
]

user_asked_questions = {}

# -------------------------------
# ูููุงุณ ุงูุญุจ
# -------------------------------
love_game_progress = {}
love_game_questions = [
    f"ูู ูุจุฏุฃ ุจุงูุตูุญ ุจุนุฏ ุงูุฒุนูุ",
    f"ูู ูููู ุฃุญุจู ุฃูุซุฑุ",
    f"ูู ูุบุงุฑ ุฃูุซุฑุ",
    f"ูู ูุญุจ ุงูููุงุฌุขุช ุฃูุซุฑุ",
    f"ูู ูุนุจุฑ ุนู ูุดุงุนุฑู ุจุณูููุฉุ",
    f"ูู ูุถุญู ุฃูุซุฑ ูู ุงูููุงูู ุงูุบุฑูุจุฉุ",
    f"ูู ูุญุจ ุงูุชูุงุตูู ุงูุตุบูุฑุฉุ",
    f"ูู ูุฑุณู ุงูุฑุณุงุฆู ุฃููุงูุ",
    f"ูู ูุดุชุงู ุฃูุซุฑุ",
    f"ูู ุฃูุซุฑ ุฑููุงูุณูุฉุ",
    f"ูู ูุญุจ ุงูููู ุจุญุถู ุงูุขุฎุฑุ",
    f"ูู ูุฎุทุท ูููุงุก ุฃูุซุฑุ",
    f"ูู ูููู ูููุงุช ูุทููุฉ ุฃูุซุฑุ",
    f"ูู ูุญุจ ูุถุงุก ุงูููุช ุฃูุซุฑ ูุน ุงูุซุงููุ",
    f"ูู ูุชุถุงูู ุฃุณุฑุนุ",
    f"ูู ูุถุญู ุนูู ุฃุชูู ุณุจุจุ",
    f"ูู ูุฑุถู ุจุณุฑุนุฉ ุจุนุฏ ุงูุฒุนูุ",
    f"ูู ููุงุฌุฆ ุงูุซุงูู ุฃูุซุฑุ",
    f"ูู ูุบูู ููุญุจ ุฃูุซุฑุ",
    f"ูู ูุนุจุฑ ุจูุธุฑุงุชู ุฃูุซุฑุ"
]

def start_love_game(user_id):
    love_game_progress[user_id] = {
        "questions": random.sample(love_game_questions, 10),
        "current": 0,
        "he": 0,
        "she": 0
    }
    q = love_game_progress[user_id]["questions"][0]
    return f"๐ ูุนุจุฉ ูููุงุณ ุงูุญุจ ุจุฏุฃุช!\nุณุคุงู 1: {q}\nุงูุชุจ (ูู) ุฃู (ูู)"

def update_love_game(user_id, answer):
    data = love_game_progress[user_id]
    if "ูู" in answer:
        data["he"] += 1
    elif "ูู" in answer:
        data["she"] += 1
    data["current"] += 1
    if data["current"] >= 10:
        if data["he"] > data["she"]:
            result = "๐ ูู ุงูุฃูุซุฑ ุญุจูุง ุงูููู!"
        elif data["she"] > data["he"]:
            result = "๐ ูู ุงูุฃูุซุฑ ุญุจูุง ุงูููู!"
        else:
            result = "๐ ุงูุญุจ ูุชุจุงุฏู ุจุงูุชุณุงูู ุจููููุง!"
        del love_game_progress[user_id]
        return f"ุงูุชูุช ุงููุนุจุฉ!\n{result}"
    else:
        q = data["questions"][data["current"]]
        return f"ุณุคุงู {data['current']+1}: {q}\nุงูุชุจ (ูู) ุฃู (ูู)"

# -------------------------------
# ุชุญุฏู ุงูุญุจ
# -------------------------------
love_challenges = [
    "ุงุฑุณู ูู/ููุง ุฑุณุงูุฉ ุญุจ ุงูุขู.",
    "ุตู ุดุฑููู ุจุซูุงุซ ูููุงุช ุฌูููุฉ.",
    "ุงูุชุจ ูู ุฑุณุงูุฉ ุชุจุฏุฃ ุจูููุฉ (ุงุดุชูุช).",
    "ูู ูู ุฃูู ุดูุก ุฎุทุฑ ุจุจุงูู ุงูุขู.",
    "ุงุฎุชุฑ ุฃุบููุฉ ุชุนุจูุฑ ุนู ุญุจู ูู ุงูููู.",
    "ุดุงุฑู ุตูุฑุฉ ุฃู ุฐูุฑู ูุฏููุฉ ุจููููุง.",
    "ุงุฐูุฑ ุฃุฌูู ูุญุธุฉ ุฌูุนุชูู.",
    "ุงูุชุจ ูู ุดู ูุฌุนู ูููู ุฃุฌูู.",
    "ุงุฎุจุฑู ุจุดูุก ุชุญุจู ููู ููุง ูุฏ ููุชู ูู ูุจู.",
    "ุฎุทุท ูููุงุฌุฃุฉ ุตุบูุฑุฉ ุงูููู ูุดุฑููู.",
    "ุงูุชุจ ูู ุณุจุจ ูุงุญุฏ ูุฌุนูู ุชุญุจู ุฃูุซุฑ ูู ููู.",
    "ุฃุฑุณู ูู ุฑุณุงูุฉ ุชููู ูููุง (ุฃููุฑ ููู).",
    "ุงุญูู ูู ุนู ุฃูู ูุฑุฉ ุฎูู ููุจู ูู.",
    "ููู ูู ูููุฉ ุญุจ ูุง ููุชูุง ูู ูู ูุจู.",
    "ุงุฑุณู ูู ููุชุฉ ุฃู ุดูุก ูุถุญูู.",
    "ุดุงุฑู ูุนู ุฃูููุฉ ุชุชูููู ุชุญูููููุง ุณูุง.",
    "ุงุฐูุฑ ุนุงุฏุฉ ุจุณูุทุฉ ุชุญุจูุง ููู.",
    "ููู ูู ุฌููุฉ ุชุจุฏุฃ ุจู (ุฃุญุจู ูุฃู...).",
    "ุชุฎูู ูุญุธุฉ ูุซุงููุฉ ุจูููู ูุงุญูููุง ูู.",
    "ุงุฐูุฑ ูููู ุฎูุงู ุชููู (ุฃูุง ูุญุธูุธ ููู)."
]

# -------------------------------
# ุงูุฑุฏูุฏ ุงูุฃุณุงุณูุฉ
# -------------------------------
@app.route("/callback", methods=['POST'])
def callback():
    signature = request.headers.get('X-Line-Signature', '')
    body = request.get_data(as_text=True)
    try:
        handler.handle(body, signature)
    except InvalidSignatureError:
        abort(400)
    return 'OK'

@handler.add(MessageEvent, message=TextMessage)
def handle_message(event):
    user_id = event.source.user_id
    text = event.message.text.strip().lower()

    if user_id in love_game_progress:
        reply = update_love_game(user_id, text)
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text=reply))
        return

    if "ุณุคุงู" in text or "ุณูุงู" in text:
        asked = user_asked_questions.get(user_id, set())
        available = [q for q in questions if q not in asked]
        if not available:
            user_asked_questions[user_id] = set()
            available = questions.copy()
        q = random.choice(available)
        user_asked_questions.setdefault(user_id, set()).add(q)
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text=q))
        return

    elif "ูููุงุณ" in text or "ุญุจ" in text:
        reply = start_love_game(user_id)
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text=reply))
        return

    elif "ุชุญุฏู" in text:
        c = random.choice(love_challenges)
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text=f"๐ {c}"))
        return

    elif "ูุณุงุนุฏุฉ" in text:
        help_text = (
            "๐ฌ ุฃูุงูุฑ ุงูุจูุช:\n"
            "- 'ุณุคุงู' ุฃู 'ุณูุงู' โ ุนุฑุถ ุณุคุงู ุญุจ ุฃู ุตุฑุงุญุฉ.\n"
            "- 'ูููุงุณ ุงูุญุจ' โ ูุนุจุฉ ูู 10 ุฃุณุฆูุฉ ูุชุญุฏูุฏ ูู ูุญุจ ุฃูุซุฑ.\n"
            "- 'ุชุญุฏู' ุฃู 'ุชุญุฏู ุงูุญุจ' โ ุชุฌุฑุจุฉ ุชุญุฏู ุฑููุงูุณูุฉ.\n"
            "- ูู ูุฑุฉ ุงูุฃุณุฆูุฉ ูุงูุชุญุฏูุงุช ุนุดูุงุฆูุฉ ุจุฏูู ุชูุฑุงุฑ.\n"
            "- ุงุณุชูุชุน ุจุงููุนุจ โค๏ธ"
        )
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text=help_text))
        return

if __name__ == "__main__":
    port = int(os.environ.get('PORT', 5000))
    app.run(host='0.0.0.0', port=port)
