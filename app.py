from flask import Flask, request, abort
from linebot import LineBotApi, WebhookHandler
from linebot.exceptions import InvalidSignatureError
from linebot.models import MessageEvent, TextMessage, TextSendMessage
import random, os

app = Flask(__name__)

LINE_CHANNEL_ACCESS_TOKEN = os.environ.get('LINE_CHANNEL_ACCESS_TOKEN')
LINE_CHANNEL_SECRET = os.environ.get('LINE_CHANNEL_SECRET')

line_bot_api = LineBotApi(LINE_CHANNEL_ACCESS_TOKEN)
handler = WebhookHandler(LINE_CHANNEL_SECRET)

asked_questions = []

# قائمة 200+ سؤال مدموج: حب، جريئة، اعترافات، أحكام زوجية وجنسية
questions = [
    "ما أكثر شيء تحبه في شريك حياتك",
    "من يحب الآخر أكثر اليوم",
    "هل سبق أن أحببت من النظرة الأولى",
    "كيف تعبر عن حبك لشريكك",
    "ما أكثر كلمة رومانسية تود سماعها منه أو منها",
    "اعترف بأغرب شعور شعرت به تجاه شريكك",
    "اعترف بأكبر خطأ ارتكبته في العلاقة",
    "ما أكثر موقف جريء قمت به مع شريك حياتك",
    "ما أكثر لحظة رومانسية جعلتك تشعر بالشغف",
    "هل سبق أن جربت شيئاً جديداً معه أو معها",
    "ما أكثر رغبة رومانسية تتمنى تحقيقها مع شريكك",
    "ما أكثر شيء يثيرك عاطفياً وجنسياً عند شريكك",
    "اعترف بأكثر تصرف جنسي جذبك لشريكك",
    "ما أكثر شيء تحب فعله معه في اللحظات الحميمة",
    "هل سبق أن شعرت بالغيرة في العلاقة",
    "هل سبق أن أرسلت رسالة حب غير متوقعة",
    "ما أكثر شيء تخاف أن يفعله شريكك",
    "هل ترغب بالمفاجآت أم التخطيط المسبق",
    "ما أكثر تصرف حنون قام به معك",
    "ما أطرف موقف حصل معك أثناء العلاقة",
    "اعترف بأكثر موقف شعرت فيه بالخوف عليه",
    "ما أكثر شيء يجعلك تشعر بالحب الحقيقي",
    "ما أكثر لحظة جعلتك تشعر بالسعادة معه أو معها",
    "اعترف بموقف شعرت فيه بالحرج أمامه",
    "ما أكثر صفة تحبها فيه أو فيها",
    "ما أكثر لحظة رومانسية تتمنى تكرارها",
    "هل سبق أن شعرت بالرغبة في الهروب معه أو معها",
    "ما أكثر موقف جريء حصل لك معه أو معها",
    "ما أكثر شيء يذكرك بشريكك عند الابتعاد",
    "هل سبق أن أخبرت شخصاً سرا رومانسياً عن العلاقة",
    "ما أكثر موقف جنسي شعرت فيه بالإثارة معه أو معها",
    "هل سبق أن أخفيت رغبة عن شريكك",
    "ما أكثر تصرف جريء تود فعله معه أو معها",
    "هل سبق أن كتبت رسالة حب طويلة لشريكك",
    "ما أكثر شيء يجعلك تشتاق له أو لها",
    "ما أكثر موقف جعلك تضحك معه أو معها",
    "ما أكثر موقف جعلك تشعر بالفخر مع شريكك",
    "ما أكثر شيء تتمنى فعله معه في عطلة نهاية الأسبوع",
    "ما أكثر كلمة رومانسية قلتها لشريكك",
    "ما أكثر شيء يثير اهتمامك عند شريكك",
    "ما أكثر شيء يجعلك تشعر بالشغف",
    "هل سبق أن شاركت شريكك حلمك الجنسي",
    "ما أكثر موقف جعل قلبك يخفق معه",
    "هل سبق أن قررت مفاجأته أو مفاجأتها بشيء مميز",
    "ما أكثر شيء تحبه في شخصيته",
    "ما أكثر تصرف يثير غيرتك",
    "اعترف بأكثر موقف شعرت فيه بالغيرة الشديدة",
    "ما أكثر شيء يذكرك بالحب الحقيقي",
    "هل سبق أن فكرت في المستقبل معه أو معها",
    "ما أكثر شيء تريد تغييره في العلاقة",
    "ما أكثر شيء تحب فعله معه في المساء",
    "ما أكثر موقف جعلك تشعر بالحنين",
    "ما أكثر موقف جريء وجنسي حصل معك",
    "اعترف بأكثر موقف شعرت فيه بالإثارة",
    "ما أكثر شيء يجعل قلبك يطمئن له",
    "هل ترغب بالمغامرة الجديدة معه اليوم",
    "ما أكثر موقف جعلك تشعر بالحب المطلق",
    "هل سبق أن أرسلت له رسالة رومانسية فجأة",
    "ما أكثر كلمة رومانسية يريد سماعها منك",
    "هل ترغب بالتجربة الجديدة معه في الحياة اليومية",
    "ما أكثر شيء شعرت بالسعادة تجاهه",
    "ما أكثر موقف جعلك تبتسم طوال اليوم",
    "ما أكثر شيء يذكرك بالحب الحقيقي",
    "هل سبق أن أعطيت شريكك هدية مفاجئة",
    "ما أكثر شيء جذبك له من البداية",
    "اعترف بأكثر شعور غريب شعرت به معه",
    "ما أكثر شيء تحبه في العلاقة الجسدية معه",
    "ما أكثر موقف أثارك جسدياً وعاطفياً",
    "هل سبق أن شعرت بالانجذاب القوي له أو لها",
    "ما أكثر كلمة تقولها لتشعره بالحب",
    "ما أكثر موقف جريء في العلاقة العاطفية",
    "هل سبق أن شعرت بالرغبة في تجربة شيء جديد",
    "ما أكثر موقف جعلك تشعر بالشغف والرومانسية",
    "ما أكثر شيء يجعلك تحب شريكك أكثر",
    "ما أكثر موقف شعرت فيه بالحب الحقيقي",
    "هل ترغب بالمفاجآت الجنسية أو الرومانسية أكثر",
    "ما أكثر موقف جعلك تشعر بالحنان معه",
    "ما أكثر موقف مضحك حصل بينكم",
    "ما أكثر شيء يخيفك في العلاقة",
    "ما أكثر لحظة رومانسية تتذكرها",
    "اعترف بموقف شعرت فيه بالخجل أمامه",
    "ما أكثر شيء يجعلك تحس بالحب",
    "ما أكثر تصرف يثيرك في العلاقة",
    "ما أكثر موقف شعرت فيه بالأمان معه",
    "هل سبق أن شعرت بالخيانة العاطفية",
    "ما أكثر شيء تتمنى فعله معه أو معها",
    "ما أكثر موقف جعلك تشعر بالرومانسية",
    "ما أكثر موقف جعل قلبك يخفق بشدة",
    "ما أكثر شيء يشعرك بالحب كل يوم",
    "ما أكثر موقف يذكرك بالحب القديم",
    "ما أكثر تصرف يجعلك تشعر بالشغف العاطفي",
    "ما أكثر موقف جعلك تشعر بالإثارة",
    "اعترف بأكثر شعور شعرت به نحو شريكك",
    "ما أكثر شيء جذبك في البداية لشريكك",
    "ما أكثر تصرف يثير حبك وعاطفتك",
    "ما أكثر موقف جعلك تحس بالحب العميق",
    "ما أكثر موقف مضحك وجريء حصل بينكم",
    "ما أكثر لحظة رومانسية تود تكرارها",
    "اعترف بأكثر شيء أزعجك في العلاقة",
    "ما أكثر شيء تحبه في العلاقة الحميمة",
    "ما أكثر موقف شعرت فيه بالإثارة الجسدية",
    "هل سبق أن كتبت له رسالة حب طويلة",
    "ما أكثر شيء يذكرك به كل يوم",
    "ما أكثر شيء يثيرك جسدياً وعاطفياً",
    "ما أكثر لحظة شعرت فيها بالحب الحقيقي",
    "ما أكثر موقف شعرت فيه بالشغف معه",
    "ما أكثر تصرف يثير غيرتك في العلاقة",
    "ما أكثر شيء تتمنى فعله معه الآن",
    "ما أكثر موقف شعرت فيه بالسعادة المطلقة",
    "ما أكثر موقف شعرت فيه بالعاطفة والجاذبية",
    "ما أكثر شيء شعرت بالانجذاب له",
    "ما أكثر شيء شعرت معه بالأمان العاطفي",
    "ما أكثر شيء يجعلك تفكر فيه قبل النوم",
    "ما أكثر تصرف جعلك تبتسم طول اليوم",
    "ما أكثر موقف جعلك تشعر بالحب العميق",
    "ما أكثر شيء جعلك تقع في حبه من جديد",
    "ما أكثر موقف شعرت فيه بالحب والرغبة",
    "ما أكثر شيء جعلك تشعر بالشغف تجاهه",
    "ما أكثر شيء شعرت معه بالطمأنينة والراحة",
    "ما أكثر موقف شعرت فيه بالحب والحنان",
    "ما أكثر تصرف جعلك تشعر بالحب الحقيقي",
    "ما أكثر لحظة شعرت فيها بالرومانسية المطلقة",
    "ما أكثر موقف جعلك تشعر بالإثارة والرغبة",
    "ما أكثر شيء جعلك تحب شريكك اليوم",
    "ما أكثر تصرف يجعلك تبتسم كل يوم",
    "ما أكثر موقف جعلك تشعر بالسعادة المطلقة",
    "ما أكثر شيء شعرت معه بالحب العميق",
    "ما أكثر لحظة رومانسية شعرت فيها بالإثارة",
    "ما أكثر شيء جعل قلبك يخفق بسرعة",
    "ما أكثر موقف جعلك تشعر بالحب والجاذبية",
    "ما أكثر شيء شعرت معه بالشغف والحنان",
    "ما أكثر تصرف جعلك تشعر بالحب والرومانسية",
    "ما أكثر موقف شعرت فيه بالحب الحقيقي",
    "ما أكثر لحظة جعلتك تشعر بالشغف والرومانسية",
    "ما أكثر شيء جعلك تحب شريكك اليوم أكثر من أي وقت",
]

@app.route("/callback", methods=['POST'])
def callback():
    signature = request.headers.get('X-Line-Signature', '')
    body = request.get_data(as_text=True)
    try:
        handler.handle(body, signature)
    except InvalidSignatureError:
        abort(400)
    return 'OK'

@handler.add(MessageEvent, message=TextMessage)
def handle_message(event):
    global asked_questions
    text = event.message.text.strip().lower()

    if "سؤال" in text:
        available = [q for q in questions if q not in asked_questions]
        if not available:
            asked_questions = []
            available = questions.copy()
        q = random.choice(available)
        asked_questions.append(q)
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text=q))
        return

    elif "تحدي" in text:
        challenges = [
            "اختر تحدي صراحة مع شريكك",
            "اختر تحدي جريء مع شريكك",
            "شارك ذكرى رومانسية مع شريكك",
            "جرب تجربة رومانسية جديدة اليوم",
        ]
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text=random.choice(challenges)))
        return

    elif "مقياس الحب" in text:
        line_bot_api.reply_message(event.reply_token, TextSendMessage(
            text="اليوم، من يحب الآخر أكثر؟ أجب بصراحة على مقياس من 1 إلى 10."
        ))
        return

    elif "مساعدة" in text:
        help_text = (
            "أوامر البوت:\n"
            "- اكتب 'سؤال' للحصول على سؤال عشوائي.\n"
            "- اكتب 'تحدي' لتجربة تحدي رومانسية أو جريء.\n"
            "- اكتب 'مقياس الحب' لمعرفة من يحب الآخر أكثر اليوم.\n"
            "- اكتب 'مساعدة' لعرض هذه الرسالة التوضيحية."
        )
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text=help_text))
        return

    # لا يرد على أي نص آخر
    return

if __name__ == "__main__":
    port = int(os.environ.get('PORT', 5000))
    app.run(host='0.0.0.0', port=port)
