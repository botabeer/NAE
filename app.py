from flask import Flask, request, abort
from linebot import LineBotApi, WebhookHandler
from linebot.exceptions import InvalidSignatureError
from linebot.models import MessageEvent, TextMessage, TextSendMessage
import os, random

app = Flask(__name__)

LINE_CHANNEL_ACCESS_TOKEN = os.environ.get('LINE_CHANNEL_ACCESS_TOKEN')
LINE_CHANNEL_SECRET = os.environ.get('LINE_CHANNEL_SECRET')

line_bot_api = LineBotApi(LINE_CHANNEL_ACCESS_TOKEN)
handler = WebhookHandler(LINE_CHANNEL_SECRET)

# ------------------ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ§Øª ÙˆØ§Ù„Ø§Ø¹ØªØ±Ø§ÙØ§Øª ------------------
questions = [
    "Ù…Ø§ Ø£ÙƒØ«Ø± Ø´ÙŠØ¡ ØªØ­Ø¨Ù‡ ÙÙŠ Ø´Ø±ÙŠÙƒ Ø­ÙŠØ§ØªÙƒØŸ",
    "Ø§Ø¹ØªØ±Ù Ø¨Ø´ÙŠØ¡ ØªØ®ÙÙŠÙ‡ Ø¹Ù†Ù‡.",
    "Ù‡Ù„ Ø³Ø¨Ù‚ ÙˆÙ†Ø¯Ù…Øª Ø¹Ù„Ù‰ ØªØµØ±Ù Ù…Ø¹ Ø´Ø±ÙŠÙƒÙƒØŸ",
    "Ù‡Ù„ ØªØºØ§Ø± Ø¹Ù„ÙŠÙ‡ ÙƒØ«ÙŠØ±ØŸ",
    "Ù‡Ù„ ØªØ´Ø¹Ø± Ø£Ù†Ù‡ ÙŠÙÙ‡Ù…Ùƒ Ø¨Ø¯ÙˆÙ† ÙƒÙ„Ø§Ù…ØŸ",
    "Ù…Ø§ Ø£ÙˆÙ„ Ø´ÙŠØ¡ Ø¬Ø°Ø¨Ùƒ ÙÙŠÙ‡ØŸ",
    "Ù‡Ù„ ØªØ¹ØªØ¨Ø± Ù†ÙØ³Ùƒ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø£ÙƒØ«Ø± Ø­Ø¨Ø§Ù‹ØŸ",
    "Ù‡Ù„ ØªØ­Ø¨ Ø§Ù„Ù…ÙØ§Ø¬Ø¢Øª Ø§Ù„Ø±ÙˆÙ…Ø§Ù†Ø³ÙŠØ©ØŸ",
    "Ù…Ø§ Ø£ÙƒØ«Ø± Ø´ÙŠØ¡ ÙŠØ¬Ø¹Ù„Ùƒ ØªØ¨ØªØ³Ù… Ù…Ø¹Ù‡ØŸ",
    "Ù…Ø§ Ø£Ø¬Ù…Ù„ Ø°ÙƒØ±Ù‰ Ø¨ÙŠÙ†ÙƒÙ…Ø§ØŸ"
]
love_challenges = [
    "Ø§ÙƒØªØ¨ Ù„Ù‡ Ø±Ø³Ø§Ù„Ø© ØªØ¨Ø¯Ø£ Ø¨ÙƒÙ„Ù…Ø© (Ø£Ø­Ø¨Ùƒ Ù„Ø£Ù†...).",
    "Ø´Ø§Ø±Ùƒ Ù…Ø¹Ù‡ Ø°ÙƒØ±Ù‰ Ù…Ø§ ØªÙ†Ø³Ø§Ù‡Ø§.",
    "Ù‚Ù„ Ù„Ù‡ Ø´ÙŠ ØªØ­Ø¨Ù‡ ÙÙŠÙ‡ Ù…Ø§ Ù‚Ø¯ Ù‚Ù„ØªÙ‡.",
    "Ø§Ø±Ø³Ù„Ù‡ ØµÙˆØ±Ø© Ù‚Ø¯ÙŠÙ…Ø© ØªØ¬Ù…Ø¹ÙƒÙ….",
    "Ø§Ø­ÙƒÙŠ Ù„Ù‡ Ø£ÙˆÙ„ Ù„Ø­Ø¸Ø© Ø®ÙÙ‚ ÙÙŠÙ‡Ø§ Ù‚Ù„Ø¨Ùƒ Ù„Ù‡."
]
confessions = [
    "Ø§Ø¹ØªØ±Ù Ø¨Ø£ÙˆÙ„ Ø´Ø®Øµ Ø¬Ø°Ø¨Ùƒ ÙÙŠ Ø­ÙŠØ§ØªÙƒ.",
    "Ø§Ø¹ØªØ±Ù Ø¨Ø£ÙƒØ«Ø± Ø¹Ø§Ø¯Ø© Ø³ÙŠØ¦Ø© Ø¹Ù†Ø¯Ùƒ.",
    "Ø§Ø¹ØªØ±Ù Ø¨Ø´ÙŠ Ù†Ø¯Ù…Øª Ø¹Ù„ÙŠÙ‡.",
    "Ø§Ø¹ØªØ±Ù Ø¨Ø§Ø³Ù… Ø£ÙˆÙ„ Ø­Ø¨ ÙÙŠ Ø­ÙŠØ§ØªÙƒ.",
    "Ø§Ø¹ØªØ±Ù Ø¨Ø£ÙƒØ«Ø± Ø´ÙŠØ¡ ØªØ®Ø§Ù Ù…Ù†Ù‡."
]

# ------------------ Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ ------------------
games = {
    "1": {"name": "Ø§Ù„ØºØ§Ø¨Ø©", "questions":[
        {"q":"Ø£Ù†Øª ÙÙŠ ØºØ§Ø¨Ø©ØŒ ØªØ±Ù‰ ÙƒÙˆØ® Ù‚Ø¯ÙŠÙ…. Ù…Ø§Ø°Ø§ ØªÙØ¹Ù„ØŸ", "options":["ØªØ¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ®","ØªØ³ØªÙƒØ´Ù Ø§Ù„ØºØ§Ø¨Ø©","ØªÙ†ØªØ¸Ø± Ù…Ø³Ø§Ø¹Ø¯Ø©","ØªØ±Ø¬Ø¹ Ù„Ù„Ù…Ù†Ø²Ù„"]},
        {"q":"ØªØ³Ù…Ø¹ ØµÙˆØª ØºØ±ÙŠØ¨. Ù…Ø§Ø°Ø§ ØªØ®ØªØ§Ø±ØŸ", "options":["ØªØ¬Ø§Ù‡Ù„Ù‡","ØªØªØ¨Ø¹Ù‡","ØªØµØ±Ø®","ØªØ®ØªØ¨Ø¦"]},
        {"q":"ÙˆØ¬Ø¯Øª Ù†Ù‡Ø± ØµØºÙŠØ±. Ù…Ø§Ø°Ø§ ØªÙØ¹Ù„ØŸ", "options":["ØªØ´Ø±Ø¨ Ù…Ù†Ù‡","ØªØ¹Ø¨Ø±Ù‡","ØªØ¬Ù„Ø³ Ø¨Ø¬Ø§Ù†Ø¨Ù‡","ØªÙ„ØªÙ‚Ø· ØµÙˆØ±"]},
        {"q":"Ø±Ø£ÙŠØª Ø¢Ø«Ø§Ø± Ø£Ù‚Ø¯Ø§Ù… ØºØ±ÙŠØ¨Ø©. Ù…Ø§Ø°Ø§ ØªÙØ¹Ù„ØŸ", "options":["ØªØªØ¨Ø¹Ù‡Ø§","ØªØªØ¬Ø§Ù‡Ù„Ù‡Ø§","ØªØµÙ†Ø¹ ÙØ®","ØªØ³ØªØ¯Ø¹ÙŠ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©"]},
        {"q":"Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø·Ø± ÙŠÙ‡Ø·Ù„. Ù…Ø§Ø°Ø§ ØªÙØ¹Ù„ØŸ", "options":["ØªØ¨Ø­Ø« Ø¹Ù† Ù…Ø£ÙˆÙ‰","ØªØ³ØªÙ…Ø± Ø¨Ø§Ù„Ù…ØºØ§Ù…Ø±Ø©","ØªØ¬Ù…Ø¹ Ø£ÙˆØ±Ø§Ù‚ Ù„ØªØºØ·ÙŠØ© Ù†ÙØ³Ùƒ","ØªØ¹ÙˆØ¯"]},
        {"q":"Ø³Ù…Ø¹Øª ØµÙˆØª Ø­ÙŠÙˆØ§Ù† Ù…ÙØªØ±Ø³. Ù…Ø§Ø°Ø§ ØªØ®ØªØ§Ø±ØŸ", "options":["ØªÙ‡Ø±Ø¨","ØªØ®ØªØ¨Ø¦","ØªØµØ¯Ø± ØµÙˆØª Ù„ØªØ®ÙŠÙÙ‡","ØªØªØ³Ù„Ù‚ Ø´Ø¬Ø±Ø©"]},
        {"q":"ÙˆØ¬Ø¯Øª ÙØ§ÙƒÙ‡Ø© ØºØ±ÙŠØ¨Ø©. Ù…Ø§Ø°Ø§ ØªÙØ¹Ù„ØŸ", "options":["ØªØ£ÙƒÙ„Ù‡Ø§","ØªØªØ±ÙƒÙ‡Ø§","ØªØ£Ø®Ø°Ù‡Ø§ Ù…Ø¹Ùƒ","ØªØ¯Ø±Ø³Ù‡Ø§"]},
        {"q":"Ø´Ø§Ù‡Ø¯Øª Ø¶ÙˆØ¡ ØºØ±ÙŠØ¨ Ø¨ÙŠÙ† Ø§Ù„Ø£Ø´Ø¬Ø§Ø±. Ù…Ø§Ø°Ø§ ØªØ®ØªØ§Ø±ØŸ", "options":["ØªÙ‚ØªØ±Ø¨","ØªØ¨ØªØ¹Ø¯","ØªØ±Ø§Ù‚Ø¨ Ù…Ù† Ø¨Ø¹ÙŠØ¯","ØªØ³Ø¬Ù„ Ø§Ù„Ø¶ÙˆØ¡ Ø¨Ø§Ù„Ù‡Ø§ØªÙ"]},
        {"q":"Ø±Ø£ÙŠØª Ø¬Ø³Ø± Ù…ØªÙ‡Ø¯Ù…. Ù…Ø§Ø°Ø§ ØªÙØ¹Ù„ØŸ", "options":["ØªØ¹Ø¨Ø± Ø¨Ø­Ø°Ø±","ØªØ¹ÙˆØ¯","ØªØ¨Ù†ÙŠ Ø¬Ø³Ø± ØµØºÙŠØ±","ØªØ³ØªÙƒØ´Ù Ø§Ù„Ù…Ù†Ø·Ù‚Ø©"]},
        {"q":"ÙˆØµÙ„Øª Ø¥Ù„Ù‰ Ø³Ø§Ø­Ø© Ù…ÙØªÙˆØ­Ø©. Ù…Ø§Ø°Ø§ ØªØ®ØªØ§Ø±ØŸ", "options":["ØªØ³ØªØ±ÙŠØ­","ØªØ¬Ø±ÙŠ","ØªØ¨Ø­Ø« Ø¹Ù† Ù…ÙƒØ§Ù† Ù…Ø®ÙÙŠ","ØªØµÙˆØ± Ø§Ù„Ù…ÙƒØ§Ù†"]},
    ]},
    "2": {"name": "Ø§Ù„Ø¬Ø²ÙŠØ±Ø©", "questions":[
        {"q":"Ø¹Ù„Ù‰ Ø¬Ø²ÙŠØ±Ø© Ù…Ù‡Ø¬ÙˆØ±Ø©ØŒ ØªØ±Ù‰ Ø®ÙŠÙ…Ø©. Ù…Ø§Ø°Ø§ ØªÙØ¹Ù„ØŸ", "options":["ØªØ¯Ø®Ù„ Ø§Ù„Ø®ÙŠÙ…Ø©","ØªØ³ÙŠØ± Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø·Ø¦","ØªØ¨Ø­Ø« Ø¹Ù† Ø·Ø¹Ø§Ù…","ØªØ¬Ù„Ø³ Ù„Ù„Ø±Ø§Ø­Ø©"]},
        {"q":"ÙˆØ¬Ø¯Øª Ù‚Ø§Ø±ÙˆØ±Ø© ØªØ­ØªÙˆÙŠ Ø±Ø³Ø§Ù„Ø©. Ù…Ø§Ø°Ø§ ØªØ®ØªØ§Ø±ØŸ", "options":["ØªÙØªØ­Ù‡Ø§","ØªØªØ±ÙƒÙ‡Ø§","ØªØ£Ø®Ø°Ù‡Ø§ Ù…Ø¹Ùƒ","ØªØ¨Ø­Ø« Ø¹Ù† ØµØ§Ø­Ø¨Ù‡Ø§"]},
        {"q":"Ø±Ø£ÙŠØª Ù‚Ø§Ø±Ø¨ ØµØºÙŠØ± Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø·Ø¦. Ù…Ø§Ø°Ø§ ØªÙØ¹Ù„ØŸ", "options":["ØªØ³ØªØ¹Ù…Ù„Ù‡","ØªØªØ±ÙƒÙ‡","ØªØªÙÙ‚Ø¯Ù‡","ØªØ¯Ù…Ø±Ù‡"]},
        {"q":"ØªØ³Ù…Ø¹ Ø£ØµÙˆØ§Øª ØºØ±ÙŠØ¨Ø© Ù…Ù† Ø§Ù„ØºØ§Ø¨Ø©. Ù…Ø§Ø°Ø§ ØªØ®ØªØ§Ø±ØŸ", "options":["ØªØ°Ù‡Ø¨ Ù„Ù„ØªØ­Ù‚Ù‚","ØªØªØ¬Ø§Ù‡Ù„Ù‡Ø§","ØªØµØ±Ø®","ØªØ®ØªØ¨Ø¦"]},
        {"q":"ÙˆØ¬Ø¯Øª ÙØ§ÙƒÙ‡Ø© Ù†Ø§Ø¯Ø±Ø©. Ù…Ø§Ø°Ø§ ØªÙØ¹Ù„ØŸ", "options":["ØªØ£ÙƒÙ„Ù‡Ø§","ØªØªØ±ÙƒÙ‡Ø§","ØªØ¬Ù…Ø¹Ù‡Ø§","ØªØ¯Ø±Ø³Ù‡Ø§"]},
        {"q":"Ø¨Ø¯Ø£Øª Ø§Ù„Ø³Ù…Ø§Ø¡ ØªÙ…Ø·Ø± ÙØ¬Ø£Ø©. Ù…Ø§Ø°Ø§ ØªÙØ¹Ù„ØŸ", "options":["ØªØ¨Ø­Ø« Ø¹Ù† Ù…Ø£ÙˆÙ‰","ØªØ³ØªÙ…Ø± ÙÙŠ Ø§Ù„ØªØ¬ÙˆØ§Ù„","ØªØ¬Ù…Ø¹ Ù…ÙŠØ§Ù‡ Ø§Ù„Ù…Ø·Ø±","ØªØ¹ÙˆØ¯ Ù„Ù„Ø´Ø§Ø·Ø¦"]},
        {"q":"ÙˆØ¬Ø¯Øª ÙƒÙ‡Ù Ù…Ø¸Ù„Ù…. Ù…Ø§Ø°Ø§ ØªØ®ØªØ§Ø±ØŸ", "options":["ØªØ¯Ø®Ù„","ØªØ¨ØªØ¹Ø¯","ØªØ±Ø§Ù‚Ø¨ Ù…Ù† Ø§Ù„Ø®Ø§Ø±Ø¬","ØªØ¶ÙŠØ¡ Ø¨Ø§Ù„ÙƒØ´Ø§Ù"]},
        {"q":"Ø±Ø£ÙŠØª Ø¹Ù„Ø§Ù…Ø© ØºØ±ÙŠØ¨Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø±Ø¶. Ù…Ø§Ø°Ø§ ØªÙØ¹Ù„ØŸ", "options":["ØªØªØ¨Ø¹Ù‡Ø§","ØªØªØ¬Ø§Ù‡Ù„Ù‡Ø§","ØªØµÙˆØ±Ù‡Ø§","ØªØ­Ù„Ù„Ù‡Ø§"]},
        {"q":"ÙˆØ¬Ø¯Øª Ø¬Ø³Ø± Ù…Ù‡Ø¬ÙˆØ±. Ù…Ø§Ø°Ø§ ØªØ®ØªØ§Ø±ØŸ", "options":["ØªØ¹Ø¨Ø±Ù‡","ØªØ¹ÙˆØ¯","ØªÙØ­ØµÙ‡","ØªØµÙˆØ±Ù‡"]},
        {"q":"ÙˆØµÙ„Øª Ø¥Ù„Ù‰ Ø´Ø§Ø·Ø¦ Ø¢Ø®Ø±. Ù…Ø§Ø°Ø§ ØªÙØ¹Ù„ØŸ", "options":["ØªØ³ØªØ±ÙŠØ­","ØªØ³Ø¨Ø­","ØªØ¨Ø­Ø« Ø¹Ù† Ù…ÙˆØ±Ø¯","ØªØµÙˆØ± Ø§Ù„Ù…Ù†Ø¸Ø±"]},
    ]},
    "3": {"name": "Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©", "questions":[
        {"q":"ÙÙŠ Ù…Ø¯ÙŠÙ†Ø© ÙƒØ¨ÙŠØ±Ø©ØŒ ØªØ¬Ø¯ Ø®Ø±ÙŠØ·Ø© ØºØ§Ù…Ø¶Ø©. Ù…Ø§Ø°Ø§ ØªØ®ØªØ§Ø±ØŸ", "options":["ØªØªØ¨Ø¹ Ø§Ù„Ø®Ø±ÙŠØ·Ø©","ØªØ³Ø£Ù„ Ø§Ù„Ø³ÙƒØ§Ù†","ØªØªØ¬Ø§Ù‡Ù„Ù‡Ø§","ØªØ£Ø®Ø° ØµÙˆØ±Ø©"]},
        {"q":"Ø±Ø£ÙŠØª Ù…ØªØ¬Ø± Ù…ØºÙ„Ù‚ ØºØ±ÙŠØ¨. Ù…Ø§Ø°Ø§ ØªÙØ¹Ù„ØŸ", "options":["ØªÙØªØ­Ù‡","ØªØ³Ø£Ù„ Ø¹Ù† Ø§Ù„Ø³Ø¨Ø¨","ØªØªØ¬Ø§Ù‡Ù„Ù‡","ØªØµÙˆØ± ÙˆØ§Ø¬Ù‡ØªÙ‡"]},
        {"q":"ÙˆØ¬Ø¯Øª ØµÙ†Ø¯ÙˆÙ‚ ØºØ§Ù…Ø¶ ÙÙŠ Ø§Ù„Ø´Ø§Ø±Ø¹. Ù…Ø§Ø°Ø§ ØªØ®ØªØ§Ø±ØŸ", "options":["ØªÙØªØ­Ù‡","ØªØªØ±ÙƒÙ‡","ØªØ£Ø®Ø°Ù‡ Ù…Ø¹Ùƒ","ØªØµÙˆØ±Ù‡"]},
        {"q":"Ø±Ø£ÙŠØª Ø³Ø§Ø­Ø© Ù…Ø²Ø¯Ø­Ù…Ø©. Ù…Ø§Ø°Ø§ ØªÙØ¹Ù„ØŸ", "options":["ØªØ¯Ø®Ù„ Ø§Ù„Ø³Ø§Ø­Ø©","ØªØªØ¬Ù†Ø¨Ù‡Ø§","ØªØµÙˆØ± Ø§Ù„Ù…Ø´Ù‡Ø¯","ØªØ³Ø£Ù„ Ø£Ø­Ø¯"]},
        {"q":"ÙˆØ¬Ø¯Øª Ø­Ø¯ÙŠÙ‚Ø© ØµØºÙŠØ±Ø© Ù‡Ø§Ø¯Ø¦Ø©. Ù…Ø§Ø°Ø§ ØªØ®ØªØ§Ø±ØŸ", "options":["ØªØ¬Ù„Ø³ ÙÙŠÙ‡Ø§","ØªØ¬Ø±ÙŠ","ØªØµÙˆØ± Ø§Ù„Ø·Ø¨ÙŠØ¹Ø©","ØªØ¨Ø­Ø« Ø¹Ù† Ø­ÙŠÙˆØ§Ù†"]},
        {"q":"Ø´Ø§Ù‡Ø¯Øª Ø¬Ø³Ø± Ù‚Ø¯ÙŠÙ…. Ù…Ø§Ø°Ø§ ØªÙØ¹Ù„ØŸ", "options":["ØªØ¹Ø¨Ø±Ù‡","ØªØ¬Ù„Ø³ Ø¨Ø¬Ø§Ù†Ø¨Ù‡","ØªØµÙˆØ±Ù‡","ØªØ³ØªÙƒØ´Ù Ø§Ù„Ù…Ù†Ø·Ù‚Ø©"]},
        {"q":"Ø±Ø£ÙŠØª Ù†Ø§ÙÙˆØ±Ø© Ù‚Ø¯ÙŠÙ…Ø©. Ù…Ø§Ø°Ø§ ØªØ®ØªØ§Ø±ØŸ", "options":["ØªØµÙˆØ±Ù‡Ø§","ØªØ¬Ù„Ø³ Ø¨Ø¬Ø§Ù†Ø¨Ù‡Ø§","ØªØ¨Ø­Ø« Ø¹Ù† ØªØ§Ø±ÙŠØ®Ù‡Ø§","ØªØªØ¬Ø§Ù‡Ù„Ù‡Ø§"]},
        {"q":"ÙˆØ¬Ø¯Øª Ù…ÙƒØªØ¨Ø© Ù…Ù‡Ø¬ÙˆØ±Ø©. Ù…Ø§Ø°Ø§ ØªÙØ¹Ù„ØŸ", "options":["ØªØ¯Ø®Ù„Ù‡Ø§","ØªØ¨Ø­Ø« Ø­ÙˆÙ„Ù‡Ø§","ØªØµÙˆØ±Ù‡Ø§","ØªØªØ¬Ø§Ù‡Ù„Ù‡Ø§"]},
        {"q":"Ø±Ø£ÙŠØª Ù„ÙˆØ­Ø© Ø¬Ø¯Ø§Ø±ÙŠØ© ØºØ±ÙŠØ¨Ø©. Ù…Ø§Ø°Ø§ ØªØ®ØªØ§Ø±ØŸ", "options":["ØªØµÙˆØ±Ù‡Ø§","ØªÙØ³Ø±Ù‡Ø§","ØªØªØ¬Ø§Ù‡Ù„Ù‡Ø§","ØªØ³Ø£Ù„ Ø§Ù„Ø³ÙƒØ§Ù†"]},
        {"q":"ÙˆØµÙ„Øª Ø¥Ù„Ù‰ Ø´Ø§Ø±Ø¹ Ø±Ø¦ÙŠØ³ÙŠ Ù…Ø²Ø¯Ø­Ù…. Ù…Ø§Ø°Ø§ ØªÙØ¹Ù„ØŸ", "options":["ØªØ³ÙŠØ± ÙÙŠ Ø§Ù„Ø´Ø§Ø±Ø¹","ØªØ¨Ø­Ø« Ø¹Ù† Ù…Ø·Ø¹Ù…","ØªØµÙˆØ± Ø§Ù„Ù…Ø´Ù‡Ø¯","ØªØªÙˆÙ‚Ù Ù„Ù„Ø±Ø§Ø­Ø©"]},
    ]}
}

# ------------------ Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ------------------
user_asked_questions = {}
user_sessions = {}      # ÙØ±Ø¯ÙŠ
group_sessions = {}     # Ø¬Ù…Ø§Ø¹ÙŠ

# ------------------ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø´Ø®ØµÙŠØ© ------------------
def analyze_personality(answers, name):
    score_active = 0
    score_calm = 0
    score_love = 0
    for a in answers:
        t = str(a).strip().lower()
        if any(x in t for x in ["1","Ø£","ØªØ¯Ø®Ù„","ØªØ³ÙŠØ±","ØªØ¨Ø­Ø«","ØªØªØ¨Ø¹","Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ","Ù‚Ø§Ø¦Ø¯","Ø¹ÙÙˆÙŠ"]):
            score_active +=1
        if any(x in t for x in ["2","Ø¨","ØªÙ†ØªØ¸Ø±","ØªØ¬Ù„Ø³","ØªØ®ØªØ¨Ø¦","Ù‡Ø¯ÙˆØ¡","ÙˆØ­Ø¯ÙŠ","Ø³ÙƒÙˆØª"]):
            score_calm +=1
        if any(x in t for x in ["3","Ø¬","Øµ","Ù…Ø´Ø§Ø¹Ø±","Ø­Ø¨","Ø¹Ø§Ø·ÙÙŠ","Ù‚Ù„Ø¨"]):
            score_love +=1

    analysis_text = f"ğŸ” ØªØ­Ù„ÙŠÙ„ Ø´Ø®ØµÙŠØ© {name}:\n"
    if score_love > max(score_active, score_calm):
        analysis_text += "Ø´Ø®ØµÙŠØ© Ø¹Ø§Ø·ÙÙŠØ© Ø­Ø³Ø§Ø³Ø©ØŒ Ù…Ø´Ø§Ø¹Ø±Ùƒ Ø¹Ù…ÙŠÙ‚Ø© ÙˆØªØ­Ø¨ ØªÙ‡ØªÙ… Ø¨Ø§Ù„Ù†Ø§Ø³ ÙˆØªÙ‚Ø¯Ù‘Ø± Ø§Ù„ØªÙØ§ØµÙŠÙ„ ğŸ’—"
    elif score_active > score_calm:
        analysis_text += "Ø´Ø®ØµÙŠØ© Ù…Ù†ÙØªØ­Ø© ÙˆÙ†Ø´ÙŠØ·Ø©ØŒ ØªØ­Ø¨ Ø§Ù„Ø­ÙŠØ§Ø© ÙˆØ§Ù„ØªØ¬Ø§Ø±Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙˆÙ…Ù„ÙŠØ§Ù† Ø·Ø§Ù‚Ø© ğŸ”¥"
    elif score_calm > score_active:
        analysis_text += "Ø´Ø®ØµÙŠØ© Ù‡Ø§Ø¯Ø¦Ø© ÙˆÙ…ØªØ²Ù†Ø©ØŒ ØªÙÙƒØ± Ù‚Ø¨Ù„ Ù…Ø§ ØªØªÙƒÙ„Ù… ÙˆØªØ­Ø¨ Ø§Ù„Ø£Ù…Ø§Ù† ÙˆØ§Ù„Ø§Ø³ØªÙ‚Ø±Ø§Ø± ğŸŒ¿"
    else:
        analysis_text += "Ø´Ø®ØµÙŠØ© Ù…ØªÙˆØ§Ø²Ù†Ø©ØŒ ØªØ¹Ø±Ù Ù…ØªÙ‰ ØªÙƒÙˆÙ† Ù‡Ø§Ø¯ÙŠ ÙˆÙ…ØªÙ‰ ØªÙƒÙˆÙ† Ø¬Ø±ÙŠØ¡ ğŸ‘Œ"
    return analysis_text

# ------------------ Webhook ------------------
@app.route("/callback", methods=['POST'])
def callback():
    signature = request.headers.get('X-Line-Signature','')
    body = request.get_data(as_text=True)
    try:
        handler.handle(body, signature)
    except InvalidSignatureError:
        abort(400)
    return 'OK'

# ------------------ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ------------------
@handler.add(MessageEvent, message=TextMessage)
def handle_message(event):
    text = event.message.text.strip()
    user_id = event.source.user_id
    group_id = getattr(event.source,"group_id",None)

    text_lower = text.lower()

    # Ù…Ø³Ø§Ø¹Ø¯Ø©
    if text_lower=="Ù…Ø³Ø§Ø¹Ø¯Ø©":
        help_text = (
            "â¤ï¸ Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¨ÙˆØª:\n"
            "- 'Ø³Ø¤Ø§Ù„' â†’ Ø³Ø¤Ø§Ù„ Ø­Ø¨/ØµØ±Ø§Ø­Ø©.\n"
            "- 'ØªØ­Ø¯ÙŠ' â†’ ØªØ­Ø¯ÙŠ Ø­Ø¨.\n"
            "- 'Ø§Ø¹ØªØ±Ø§Ù' â†’ Ø§Ø¹ØªØ±Ø§Ù.\n"
            "- 'Ù„Ø¹Ø¨Ù‡ 1' â†’ ØªØ¨Ø¯Ø£ Ù„Ø¹Ø¨Ø© Ø§Ù„ØºØ§Ø¨Ø©.\n"
            "- 'Ù„Ø¹Ø¨Ù‡ 2' â†’ ØªØ¨Ø¯Ø£ Ù„Ø¹Ø¨Ø© Ø§Ù„Ø¬Ø²ÙŠØ±Ø©.\n"
            "- 'Ù„Ø¹Ø¨Ù‡ 3' â†’ ØªØ¨Ø¯Ø£ Ù„Ø¹Ø¨Ø© Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©.\n"
            "- 'Ø­Ù„Ù„ Ø´Ø®ØµÙŠØªÙŠ' â†’ ÙŠØ¹Ø·ÙŠÙƒ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨.\n"
        )
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text=help_text))
        return

    # Ø£Ø³Ø¦Ù„Ø© Ø­Ø¨/ØµØ±Ø§Ø­Ø©
    if text_lower in ["Ø³Ø¤Ø§Ù„","Ø³ÙˆØ§Ù„"]:
        asked = user_asked_questions.get(user_id,set())
        available = [q for q in questions if q not in asked]
        if not available:
            user_asked_questions[user_id] = set()
            available = questions.copy()
        q = random.choice(available)
        user_asked_questions.setdefault(user_id,set()).add(q)
        line_bot_api.reply_message(event.reply_token,TextSendMessage(text=q))
        return

    # ØªØ­Ø¯ÙŠ
    if text_lower=="ØªØ­Ø¯ÙŠ":
        c = random.choice(love_challenges)
        line_bot_api.reply_message(event.reply_token,TextSendMessage(text=f"ğŸ’Œ {c}"))
        return

    # Ø§Ø¹ØªØ±Ø§Ù
    if text_lower=="Ø§Ø¹ØªØ±Ø§Ù":
        conf = random.choice(confessions)
        line_bot_api.reply_message(event.reply_token,TextSendMessage(text=f"ğŸ©· {conf}"))
        return

    # Ø¨Ø¯Ø¡ Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨
    if text_lower in ["Ù„Ø¹Ø¨Ù‡ 1","Ù„Ø¹Ø¨Ù‡ 2","Ù„Ø¹Ø¨Ù‡ 3"]:
        game_id = text_lower[-1]
        session = {"game":game_id,"step":0,"answers":[],"answers_map":{}}
        if group_id:
            group_sessions.setdefault(group_id,{})
            group_sessions[group_id][user_id] = session
        else:
            user_sessions[user_id] = session
        first_q = games[game_id]["questions"][0]
        opts = "\n".join([f"{i+1}. {o}" for i,o in enumerate(first_q["options"])])
        line_bot_api.reply_message(event.reply_token,TextSendMessage(
            text=f"ğŸ® Ù„Ø¹Ø¨Ø© {games[game_id]['name']} - Ø³Ø¤Ø§Ù„ 1:\n{first_q['q']}\n{opts}"))
        return

    # Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø¬Ù„Ø³Ø©
    if group_id in group_sessions and user_id in group_sessions[group_id]:
        session = group_sessions[group_id][user_id]
    elif user_id in user_sessions:
        session = user_sessions[user_id]
    else:
        line_bot_api.reply_message(event.reply_token,TextSendMessage(
            text="âš ï¸ Ù„Ù… Ø£ÙÙ‡Ù…. Ø§ÙƒØªØ¨ 'Ù…Ø³Ø§Ø¹Ø¯Ø©' Ù„Ø±Ø¤ÙŠØ© Ø§Ù„Ø£ÙˆØ§Ù…Ø±."))
        return

    # ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©
    session["answers"].append(text)
    session["answers_map"][session["step"]] = text
    session["step"] +=1

    # Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
    game_id = session["game"]
    if session["step"] < len(games[game_id]["questions"]):
        q = games[game_id]["questions"][session["step"]]
        opts = "\n".join([f"{i+1}. {o}" for i,o in enumerate(q["options"])])
        line_bot_api.reply_message(event.reply_token,TextSendMessage(
            text=f"ğŸ® Ø³Ø¤Ø§Ù„ {session['step']+1}:\n{q['q']}\n{opts}"))
    else:
        # Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù„Ø¹Ø¨Ø© â†’ Ø§Ù„ØªØ­Ù„ÙŠÙ„
        try:
            name = line_bot_api.get_profile(user_id).display_name
        except:
            name = "Ù…Ø´Ø§Ø±Ùƒ"
        analysis = analyze_personality(session["answers"],name)
        if group_id:
            mention_text = f"@{name}\n{analysis}"
            line_bot_api.push_message(group_id,TextSendMessage(text=mention_text))
            del group_sessions[group_id][user_id]
        else:
            line_bot_api.reply_message(event.reply_token,TextSendMessage(text=analysis))
            del user_sessions[user_id]

if __name__=="__main__":
    port = int(os.environ.get("PORT",5000))
    app.run(host="0.0.0.0",port=port)
