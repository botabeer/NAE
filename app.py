from flask import Flask, request, abort
from linebot import LineBotApi, WebhookHandler
from linebot.exceptions import InvalidSignatureError
from linebot.models import MessageEvent, TextMessage, TextSendMessage
import os, random, typing, re

app = Flask(__name__)

# LINE credentials from environment
LINE_CHANNEL_ACCESS_TOKEN = os.getenv("LINE_CHANNEL_ACCESS_TOKEN")
LINE_CHANNEL_SECRET = os.getenv("LINE_CHANNEL_SECRET")
if not LINE_CHANNEL_ACCESS_TOKEN or not LINE_CHANNEL_SECRET:
    raise RuntimeError("Set LINE_CHANNEL_ACCESS_TOKEN and LINE_CHANNEL_SECRET environment variables")

line_bot_api = LineBotApi(LINE_CHANNEL_ACCESS_TOKEN)
handler = WebhookHandler(LINE_CHANNEL_SECRET)

# -------------------------
# الألعاب العشر الأخيرة (كل لعبة 5 أسئلة)
# -------------------------
games: typing.Dict[str, typing.List[str]] = {
    "لعبه1":[
        "سؤال 1:\nأنت تمشي في غابة مظلمة وهادئة، فجأة تسمع صوت خطوات خلفك. ماذا تفعل؟\n1. تلتفت فورًا\n2. تسرع بخطواتك\n3. تتجاهل وتواصل طريقك\n4. تختبئ خلف شجرة",
        "سؤال 2:\nوجدت نهرًا سريع الجريان، كيف تعبره؟\n1. أبحث عن جسر\n2. أسبح عبره\n3. أنتظر حتى يهدأ\n4. أعود للوراء",
        "سؤال 3:\nرأيت كوخًا صغيرًا، ماذا تفعل؟\n1. أطرق الباب\n2. أدخل دون تردد\n3. أراقبه من بعيد\n4. أتركه وأكمل طريقك",
        "سؤال 4:\nداخل الكوخ وجدت مفتاحًا وورقة، ماذا تأخذ؟\n1. المفتاح\n2. الورقة\n3. كلاهما\n4. لا شيء",
        "سؤال 5:\nخرجت ووجدت طريقين، أي تختار؟\n1. مضيء\n2. مظلم\n3. مليء بالأزهار\n4. وعر وآمن"
    ],
    "لعبه2":[
        "سؤال 1:\nاستيقظت على جزيرة غامضة، ما أول ما تفعله؟\n1. أستكشف المكان\n2. أبحث عن ماء\n3. أصرخ طلبًا للمساعدة\n4. أجلس للتفكير",
        "سؤال 2:\nرأيت أثر أقدام على الرمل، ماذا تفعل؟\n1. أتابعها\n2. أتجاهلها\n3. أراقبها من بعيد\n4. أغطيها بالرمل",
        "سؤال 3:\nوجدت ثمرة غريبة، هل تأكلها؟\n1. نعم فورًا\n2. لا أقترب\n3. أختبرها أولًا\n4. أحفظها",
        "سؤال 4:\nاقترب الليل ولا مأوى، ماذا تفعل؟\n1. أبني مأوى بسيط\n2. أصعد شجرة\n3. أشعل نارًا\n4. أبقى مستيقظًا",
        "سؤال 5:\nسمعت أصوات غريبة، كيف تتصرف؟\n1. أقترب منها\n2. أبتعد فورًا\n3. أراقب من بعيد\n4. أصيح"
    ],
    "لعبه3":[
        "سؤال 1:\nأنت في مدينة جديدة، أول شيء تفعله؟\n1. أستكشف\n2. أبحث عن مطعم\n3. أبحث عن فندق\n4. أسأل الناس",
        "سؤال 2:\nرأيت إعلانًا غريبًا، هل تتابعه؟\n1. نعم بحماس\n2. لا أهتم\n3. أصور الإعلان\n4. أتجاهله",
        "سؤال 3:\nعرض عليك شخص عملًا غريبًا، هل تقبله؟\n1. نعم\n2. لا\n3. أسأله التفاصيل\n4. أؤجل القرار",
        "سؤال 4:\nضاع طفل، ماذا تفعل؟\n1. أساعده فورًا\n2. أبحث عن والديه\n3. أتصل بالشرطة\n4. أتجاهله",
        "سؤال 5:\nانقطعت الكهرباء، ماذا تفعل؟\n1. أشعل شمعة\n2. أستخدم الهاتف\n3. أتمشى\n4. أنام"
    ],
    "لعبه4":[
        "سؤال 1:\nأنت تمشي في شارع مهجور ليلاً، فجأة تسمع صوت غريب، ماذا تفعل؟\n1. تسرع للبحث عن مصدر الصوت\n2. تختبئ في أقرب مكان\n3. تتصل بشخص موثوق\n4. تواصل السير بهدوء",
        "سؤال 2:\nوجدت حقيبة غريبة على الأرض، ماذا تفعل؟\n1. تفتحها لتعرف ما بداخلها\n2. تتركها وتبتعد\n3. تنقلها إلى مكان آمن\n4. تتصل بالشرطة",
        "سؤال 3:\nشخص غريب يقترب منك، كيف تتصرف؟\n1. تحاول التحدث معه بلطف\n2. تبتعد فورًا\n3. تراقبه بهدوء\n4. تبحث عن مساعد",
        "سؤال 4:\nأنت في موقف صعب مع أصدقاءك، ماذا تفعل؟\n1. تواجه الموقف مباشرة\n2. تتفاوض لحل المشكلة\n3. تبتعد مؤقتًا\n4. تطلب المساعدة من شخص موثوق",
        "سؤال 5:\nتجد بابًا غامضًا في مكان مهجور، هل تفتحه؟\n1. نعم وأدخل\n2. تراقبه أولًا\n3. لا تفتحه\n4. تبحث عن معلومات عنه"
    ],
    "لعبه5":[
        "سؤال 1:\nاستيقظت على كوكب جديد، أول ما تفعله؟\n1. أستكشف\n2. أبحث عن مأوى\n3. أجمع عينات\n4. أنتظر إشارات",
        "سؤال 2:\nوجدت نباتًا غريبًا، ماذا تفعل؟\n1. ألمسه\n2. أصور\n3. أتجنبه\n4. آخذ منه عينة",
        "سؤال 3:\nرأيت مخلوقًا صغيرًا، كيف تتصرف؟\n1. أقترب بحذر\n2. أبتعد\n3. أراقبه من بعيد\n4. أتواصل معه",
        "سؤال 4:\nتواجه فصل ليل غريب، ماذا تفعل؟\n1. أبني مأوى\n2. أشعل نارًا\n3. أواصل السير\n4. أستكشف المكان",
        "سؤال 5:\nوجدت بوابة، تدخل؟\n1. أدخل\n2. لا\n3. أنتظر\n4. أبحث عن معلومات"
    ],
    "لعبه6":[
        "سؤال 1:\nشخص غريب يطلب مساعدتك، ماذا تفعل؟\n1. تساعد فورًا\n2. تسأله عن التفاصيل أولًا\n3. تقدم نصيحة فقط\n4. ترفض بلطف",
        "سؤال 2:\nشخص غريب يحاول التحدث معك، كيف تتصرف؟\n1. تتفاعل معه بحرارة\n2. تستمع بحذر\n3. تتحدث قليلًا\n4. تتجنب الحديث",
        "سؤال 3:\nتشاهد موقفًا يحتاج لتدخل، ماذا تفعل؟\n1. تتدخل فورًا\n2. تراقب الوضع أولًا\n3. تبحث عن مساعدة\n4. تترك الأمر",
        "سؤال 4:\nشخص غريب يراقبك في مكان عام، ماذا تفعل؟\n1. تواجهه\n2. تتحرك بعيدًا\n3. تراقبه\n4. تتجاهل",
        "سؤال 5:\nشخص غريب يعطيك هدية مفاجئة، ماذا تفعل؟\n1. تشكره وتقبل\n2. تسأله عن السبب\n3. ترفض بلطف\n4. تبتعد"
    ],
    "لعبه7":[
        "سؤال 1:\nشخص معجب بك يرسل رسالة، كيف تتصرف؟\n1. ترد بسرعة وباهتمام\n2. تفكر قبل الرد\n3. ترد بشكل عام\n4. تتجاهل",
        "سؤال 2:\nشخص معجب بك يريد لقاءك، ماذا تفعل؟\n1. توافق فورًا\n2. تحدد وقت مناسب\n3. تؤجل اللقاء\n4. ترفض",
        "سؤال 3:\nشخص معجب بك يقدم لك هدية، ماذا تفعل؟\n1. تشكره بحرارة\n2. تفكر في رد فعل مناسب\n3. تتقبل بلطف\n4. ترفض",
        "سؤال 4:\nيعبر عن مشاعره أمام الآخرين، ماذا تفعل؟\n1. تتفاعل معه مباشرة\n2. تتصرف ببرود قليلًا\n3. تحاول فهم الموقف\n4. تتجاهل",
        "سؤال 5:\nتريد معرفة مشاعره الحقيقية، ماذا تفعل؟\n1. تسأله بصراحة\n2. تراقب تصرفاته\n3. تطلب من الآخرين مساعدتك\n4. تترك الأمور واضحة للوقت"
    ],
    "لعبه8":[
        "سؤال 1:\nأنت في عالم جديد، ماذا تفعل؟\n1. تستكشفه بحماس\n2. تحلل مكوناته\n3. تراقب من بعيد\n4. تحلم فقط دون فعل",
        "سؤال 2:\nمخلوق غريب يطلب مساعدتك، ماذا تفعل؟\n1. تساعد فورًا\n2. تستفسر أولًا\n3. تراقبه\n4. تبتعد",
        "سؤال 3:\nتجد بابًا سريًا، ماذا تفعل؟\n1. تفتحه وتدخل\n2. تفكر قبل الدخول\n3. تراقبه\n4. تتركه",
        "سؤال 4:\nشخص غامض يعرض صفقة، ماذا تفعل؟\n1. توافق بحذر\n2. تدرس العرض جيدًا\n3. ترفض\n4. تنتظر",
        "سؤال 5:\nتتعرض لموقف خطر في الخيال، ماذا تفعل؟\n1. تواجهه مباشرة\n2. تخطط للخروج\n3. تبحث عن مساعدة\n4. تهرب"
    ],
    "لعبه9":[
        "سؤال 1:\nلديك مشروع صعب، كيف تتصرف؟\n1. تبدأ فورًا\n2. تخطط بدقة\n3. تطلب مساعدة\n4. تؤجل",
        "سؤال 2:\nزميل يطلب مساعدتك، ماذا تفعل؟\n1. تساعد فورًا\n2. تستفسر أولًا\n3. تقدم نصيحة فقط\n4. ترفض",
        "سؤال 3:\nمدير يطلب تقرير عاجل، ماذا تفعل؟\n1. تنجزه فورًا\n2. تخطط لإنجازه\n3. تطلب وقت إضافي\n4. تؤجل",
        "سؤال 4:\nفريقك يخطئ في المشروع، ماذا تفعل؟\n1. تواجه الفريق\n2. تناقش الأخطاء بهدوء\n3. تراقب الوضع\n4. تتركهم يصلحون بأنفسهم",
        "سؤال 5:\nلديك فكرة جديدة، كيف تعرضها؟\n1. تقدمها بحماس\n2. تدرس الطريقة الأفضل\n3. تناقشها مع شخص موثوق\n4. تؤجل"
    ],
    "لعبه10":[
        "سؤال 1:\nتواجه موقف صعب، كيف تتصرف؟\n1. تواجهه فورًا\n2. تخطط للتعامل معه\n3. تطلب نصيحة\n4. تبتعد",
        "سؤال 2:\nخيار مهم يتطلب قرار سريع، ماذا تفعل؟\n1. تتخذ القرار مباشرة\n2. تزن الخيارات بعناية\n3. تطلب رأي شخص موثوق\n4. تؤجل",
        "سؤال 3:\nشخص يضغط عليك، كيف تتصرف؟\n1. تواجهه بصراحة\n2. تهدأ وتفكر\n3. تتجنب المواجهة\n4. تبتعد مؤقتًا",
        "سؤال 4:\nفرصة غير متوقعة، ماذا تفعل؟\n1. تنتهزها فورًا\n2. تدرس المخاطر\n3. تسأل شخص ذو خبرة\n4. تتركها",
        "سؤال 5:\nموقف غير متوقع، كيف تتصرف؟\n1. تحل المشكلة مباشرة\n2. تخطط خطوة خطوة\n3. تبحث عن دعم\n4. تراقب الوضع"
    ]
}

# -----------------------------
# الشخصيات العشر الطويلة والمفصلة
# -----------------------------
DESCRIPTIONS = {
    "قيادية": (
        "الشخصية القيادية\n\n"
        "تمتاز هذه الشخصية بالقدرة على اتخاذ القرارات بسرعة وثقة، "
        "مع تحمل كامل للمسؤولية عن نتائج أفعالها. "
        "تميل إلى توجيه الآخرين بطريقة عملية وفعالة، وتسعى دائمًا لتحقيق أهداف واضحة وطموحة. "
        "تتمتع بمهارات تنظيمية عالية وقدرة على التخطيط الاستراتيجي، "
        "كما أنها تحب السيطرة على المواقف وتقييم الإنجازات بشكل مستمر. "
        "تتصرف بثقة حتى في المواقف المعقدة، وتعرف بقدرتها على مواجهة التحديات وإيجاد الحلول السريعة."
    ),
    "تعبيرية": (
        "الشخصية التعبيرية\n\n"
        "تتميز هذه الشخصية بقدرتها الكبيرة على التواصل والتعبير عن المشاعر بوضوح. "
        "تحب التفاعل الاجتماعي والمشاركة في الأنشطة الجماعية، وتعبر عن أفكارها ومشاعرها بحرية. "
        "تتمتع بالود والمرونة، وتستجيب بشكل حساس لمشاعر الآخرين، "
        "مما يجعلها شديدة التعاطف وقادرة على كسب قلوب من حولها بسهولة. "
        "تميل لإظهار العفوية والانفتاح على الاختلاف، وتفضل المشاركة في النقاشات والمحادثات."
    ),
    "تحليلية": (
        "الشخصية التحليلية\n\n"
        "تعتمد هذه الشخصية على التفكير المنطقي والعقلاني في جميع المواقف، "
        "وتسعى دائمًا لجمع المعلومات وتحليلها بدقة قبل اتخاذ أي قرار. "
        "تركز على التفاصيل الدقيقة، وتحب ترتيب الأمور بشكل منهجي ومنظم. "
        "تميل إلى التخطيط طويل المدى ومراجعة جميع الاحتمالات قبل التصرف، "
        "كما تتميز بالقدرة على حل المشكلات المعقدة بطريقة منظمة ومنطقية، وتقدر الحقائق والبيانات أكثر من العواطف."
    ),
    "داعمة": (
        "الشخصية الداعمة\n\n"
        "تتميز بالحرص على مساعدة الآخرين باستمرار، وتهيئة جو من الاستقرار والهدوء حولها. "
        "تهتم بمشاعر من حولها وتسعى لتقديم الدعم العاطفي والنفسي عند الحاجة. "
        "تستمتع بتقديم النصائح والمساندة، وتعتبر نفسها سندًا موثوقًا لمن يحتاج، "
        "تتصرف بحساسية كبيرة تجاه المواقف العاطفية، وتحاول خلق بيئة آمنة وداعمة للآخرين."
    ),
    "اجتماعية": (
        "الشخصية الاجتماعية\n\n"
        "تحب التواصل المستمر مع الناس وتكوين علاقات جديدة، "
        "وتشارك الآخرين أفراحهم وأحزانهم بصدق وود. "
        "تتمتع بطاقة إيجابية وتفاؤل، ولديها قدرة كبيرة على التكيف مع المواقف المختلفة. "
        "تميل للمبادرة في الأنشطة الجماعية، وتحب التفاعل مع الآخرين في النقاشات والأحداث، "
        "كما تتميز بالقدرة على كسب الثقة والمحبة بسرعة بين أصدقائها."
    ),
    "مغامرة": (
        "الشخصية المغامرة\n\n"
        "تحب استكشاف المجهول وتجربة أشياء جديدة، وتفضل المخاطرة المحسوبة لتحقيق التجارب المثيرة. "
        "تمتاز بالشجاعة وحب التحدي، وتبحث دائمًا عن الفرص التي تزيد من إثارة حياتها. "
        "تتصرف بسرعة عند مواجهة المواقف الجديدة، وتفضل التجربة على الانتظار. "
        "تتميز بالمرونة والقدرة على التعامل مع المواقف غير المتوقعة، وتسعى لتجربة كل ما هو جديد ومختلف."
    ),
    "مبتكرة": (
        "الشخصية المبتكرة\n\n"
        "تمتاز بقدرتها على التفكير خارج الصندوق، وابتكار الحلول الإبداعية للمشكلات اليومية والمعقدة. "
        "تحب التجريب والتطوير المستمر، وتسعى لتقديم أفكار جديدة وغير تقليدية. "
        "تمتلك رؤية واضحة للتغيير والتحسين، وتفضل الابتكار على التكرار، "
        "كما أنها تتحلى بالصبر في تطوير أفكارها وتحويلها إلى واقع ملموس."
    ),
    "محللة": (
        "الشخصية المحللة\n\n"
        "تركز على دراسة الأمور بعمق، وتبحث دائمًا عن التفاصيل الصغيرة لفهم الصورة الكاملة. "
        "تعتمد على المنطق والتفكير النقدي في اتخاذ القرارات، وتستمتع بحل المشكلات المعقدة بشكل دقيق. "
        "تتميز بالموضوعية والحياد، وتبتعد عن التسرع في الحكم على الأمور. "
        "تفضل التحقق من الحقائق قبل اتخاذ أي خطوة، وتحب العمل بطريقة منهجية."
    ),
    "مستقلة": (
        "الشخصية المستقلة\n\n"
        "تعتمد على نفسها في جميع شؤون حياتها، وتفضل اتخاذ القرارات بنفسها دون تدخل الآخرين. "
        "تمتلك إرادة قوية وتتحمل المسؤولية بثقة، وتعرف بقدرتها على العمل الفردي بفعالية. "
        "تحب التخطيط لأهدافها وتحقيقها بأسلوبها الخاص، وتستمتع بتحقيق النجاحات بمجهودها الشخصي. "
        "تتمتع بالثقة بالنفس والقدرة على مواجهة التحديات دون الاعتماد على الآخرين."
    ),
    "حساسة": (
        "الشخصية الحساسة\n\n"
        "تتأثر بالأحداث والمواقف بسرعة، وتولي اهتمامًا كبيرًا لمشاعر من حولها. "
        "تتصرف بتعاطف وتفكير عميق قبل اتخاذ أي خطوة، وتسعى دائمًا لتجنب إيذاء الآخرين. "
        "تميل للهدوء والتأمل، وتدرك التفاصيل الدقيقة في سلوكيات الآخرين ومشاعرهم. "
        "تتميز بالقدرة على فهم مشاعر الناس بسهولة، وتسعى لإيجاد التوازن بين احتياجاتها واحتياجات الآخرين."
    )
}

# -----------------------------
# أسئلة إضافية
# -----------------------------
questions_file = [
    "ما أكثر صفة تحبها في شريك حياتك؟",
    "ما أول شعور جاءك لما شفته لأول مرة؟",
    "لو تقدر تغير شيء في علاقتك، وش هو؟"
]
challenges_file = [
    "اكتب رسالة قصيرة تبدأ بـ: أحبك لأن...",
    "ارسل له صورة تمثل أجمل ذكرى عندك معه."
]
confessions_file = [
    "اعترف بأول شخص جذبك في حياتك.",
    "اعترف بأكثر عادة سيئة عندك."
]
personal_file = [
    "تحب تبدأ يومك بالنشاط ولا بالهدوء؟",
    "هل تعتبر نفسك اجتماعي أم انطوائي؟"
]

# -----------------------------
# إدارة الجلسات
# -----------------------------
group_sessions: typing.Dict[str, typing.Dict] = {}

# -----------------------------
# Helpers
# -----------------------------
def extract_option_text(game_key: str, q_index: int, chosen: int) -> str:
    try:
        q = games[game_key][q_index]
    except Exception:
        return ""
    lines = q.splitlines()
    opts = re.findall(r"\n\s*\d+\s*[\.\)\-:]\s*([^\n]+)", q)
    if opts and 1 <= chosen <= len(opts):
        return opts[chosen-1].strip()
    return ""

def score_answers_to_personality(answers: typing.List[typing.Tuple[int,int,str]]) -> str:
    scores = {k:0 for k in DESCRIPTIONS.keys()}
    for q_index, chosen_num, chosen_text in answers:
        if chosen_num == 1:
            scores["قيادية"] += 1
        elif chosen_num == 2:
            scores["تحليلية"] += 1
        elif chosen_num == 3:
            scores["تعبيرية"] += 1
        elif chosen_num == 4:
            scores["داعمة"] += 1
    sorted_scores = sorted(scores.items(), key=lambda x: -x[1])
    return sorted_scores[0][0] if sorted_scores else "تعبيرية"

def build_final_analysis_text(name: str, trait_key: str) -> str:
    desc = DESCRIPTIONS.get(trait_key, "")
    return f"{name}\n\n{desc}"

# -----------------------------
# Webhook
# -----------------------------
@app.route("/callback", methods=["POST"])
def callback():
    signature = request.headers.get("X-Line-Signature", "")
    body = request.get_data(as_text=True)
    try:
        handler.handle(body, signature)
    except InvalidSignatureError:
        abort(400)
    return "OK"

# -----------------------------
# Message handler
# -----------------------------
@handler.add(MessageEvent, message=TextMessage)
def handle_message(event):
    source = event.source
    user_id = source.user_id
    group_id = getattr(source, "group_id", None)
    text_raw = event.message.text.strip()
    text = text_raw.strip()

    # ---- basic commands ----
    if text == "مساعدة":
        help_text = (
            "أوامر البوت:\n"
            "- سؤال → سؤال.\n"
            "- تحدي → تحدي.\n"
            "- اعتراف → اعتراف.\n"
            "- شخصي → سؤال شخصي عشوائي.\n"
            "- لعبه (مثال: لعبه1) → يبدأ جلسة لعبة جماعية.\n"
            "  بعد بدء اللعبة: كل عضو يكتب 'ابدأ' للانضمام ثم يجيب بالأرقام 1-4.\n"
            "- البوت يتجاهل أي رسائل خارج الأوامر أو الجلسات."
        )
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text=help_text))
        return
    if text == "سؤال":
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text=random.choice(questions_file)))
        return
    if text == "تحدي":
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text=random.choice(challenges_file)))
        return
    if text == "اعتراف":
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text=random.choice(confessions_file)))
        return
    if text == "شخصي":
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text=random.choice(personal_file)))
        return

    # ---- start group game ----
    if group_id and text.startswith("لعبه"):
        if text not in games:
            line_bot_api.reply_message(event.reply_token, TextSendMessage(text="اكتب لعبه1 حتى لعبه10 لبدء لعبة."))
            return
        group_sessions[group_id] = {"game": text, "players": {}, "state": "joining"}
        line_bot_api.reply_message(event.reply_token, TextSendMessage(
            text=(f"تم بدء الجلسة: {text}\n"
                  "كل عضو يرسل 'ابدأ' للانضمام. بعد الانضمام أجب بالأرقام 1-4 على كل سؤال.\n"
                  "البوت سيعطي تحليل مفصّل باسم كل لاعب مباشرة بعد إكماله للأسئلة.")
        ))
        return

# ---- باقي التعامل مع الانضمام والإجابة كما في الكود القديم ----

if __name__ == "__main__":
    port = int(os.getenv("PORT", 5000))
    app.run(host="0.0.0.0", port=port)
