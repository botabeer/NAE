from flask import Flask, request, abort
from linebot import LineBotApi, WebhookHandler
from linebot.exceptions import InvalidSignatureError
from linebot.models import MessageEvent, TextMessage, TextSendMessage
import random, os

app = Flask(__name__)

LINE_CHANNEL_ACCESS_TOKEN = os.environ.get('LINE_CHANNEL_ACCESS_TOKEN')
LINE_CHANNEL_SECRET = os.environ.get('LINE_CHANNEL_SECRET')

line_bot_api = LineBotApi(LINE_CHANNEL_ACCESS_TOKEN)
handler = WebhookHandler(LINE_CHANNEL_SECRET)

# -------------------------------------------------------
# الأسئلة (حب + صراحة + رومانسية) - أكثر من 200 سؤال
# -------------------------------------------------------
questions = [
"ما أكثر شيء تحبه في شريك حياتك؟",
"اعترف بشيء تخفيه عنه.",
"هل سبق وندمت على تصرف مع شريكك؟",
"هل تغار عليه كثير؟",
"هل تشعر أنه يفهمك بدون كلام؟",
"ما أول شيء جذبك فيه؟",
"هل تعتبر نفسك الطرف الأكثر حباً؟",
"هل تحب المفاجآت الرومانسية؟",
"ما أكثر شيء يجعلك تبتسم معه؟",
"ما أجمل ذكرى بينكما؟",
"هل تثق به ثقة كاملة؟",
"هل تحب تبدأ بالمصالحة أم تنتظر؟",
"ما أول شعور حسّيته لما شفته أول مرة؟",
"ما أكثر تصرف يخليه يكسب رضاك بسرعة؟",
"هل تفضل المكالمات الطويلة أم الرسائل القصيرة؟",
"هل سبق بكيت من شوقك له؟",
"هل تتخيل المستقبل معه؟",
"ما أكثر كلمة تحب تسمعها منه؟",
"هل تحب المفاجآت البسيطة؟",
"ما أكثر شيء يذكرك فيه عندما يغيب؟",
"اعترف بأغرب شعور شعرت به تجاه شريكك.",
"اعترف بأكبر خطأ ارتكبته في العلاقة.",
"ما أكثر موقف خلاك تقول (أنا محظوظ فيه).",
"ما أكثر لحظة رومانسية حلمت بها معه؟",
"هل تفضل الكلام أم الأفعال في الحب؟",
"ما أكثر صفة تجعلك تحبه أكثر؟",
"هل سبق وقلت أحبك أول؟",
"هل تحب أن يسمعك دايمًا كلمات حب؟",
"هل سبق وكتبت له رسالة حب؟",
"هل تتوقع أن حبكم يكبر مع الوقت؟",
"هل تثق فيه وقت الغياب؟",
"هل تعتقد أن الحب تضحية؟",
"ما أكثر شيء يجعلك تشتاق له؟",
"هل تحب تبدأ بالمصالحة أم تنتظر؟",
"ما أكثر كلمة يقولها وتؤثر فيك؟",
"ما أكثر شيء يجعلك تحس بالأمان معه؟",
"ما أكثر تصرف يغيظك منه؟",
"هل تغار عليه من الناس؟",
"ما أكثر لحظة حسّيت أنه فعلاً يحبك؟",
"هل تتمنى يعيش نفس مشاعرك؟",
"ما أكثر شيء يذكرك فيه لما تسمع أغنية؟",
"هل سبق وفاجأك بشيء جميل؟",
"هل تحب المفاجآت أو الهدايا الرمزية؟",
"ما أكثر شيء تخاف تفقده فيه؟",
"هل سبق ونمتوا وأنتم زعلانين؟",
"هل تسامح بسهولة؟",
"هل تحب العتاب الطويل أم القصير؟",
"ما أكثر شيء يحسسّك بقيمتك؟",
"ما أكثر شيء ودك تغيره فيك عشانه؟",
"ما أكثر تصرف يخليك تذوب حب؟",
"هل سبق وشعرت إنك تحبه أكثر؟",
"ما أكثر مكان يذكّرك فيه؟",
"هل تفتقده لما يختفي؟",
"ما أكثر شيء يخليه يضحكك؟",
"هل تعتبره صديقك قبل حبيبك؟",
"ما أكثر موقف خلاك تحبه أكثر؟",
"ما أكثر شيء تخاف تقوله له؟",
"هل سبق وخبيّت عنه شيء؟",
"هل تشوف نفسك تبادر بالحب أكثر؟",
"هل تعتقد إن الصدق أهم من المشاعر؟",
"هل تتمنى لو يرجع يوم من أيامكم القديمة؟",
"ما أكثر عادة غريبة فيه تحبها؟",
"هل سبق وصار بينكم سوء تفاهم مضحك؟",
"ما أكثر وقت تحب تتكلمون فيه؟",
"هل تحب المكالمات الليلية؟",
"ما أكثر كلمة تذكّرك فيه؟",
"هل تحب التمسك ولا المساحة في العلاقة؟",
"هل تشعر أنه يغار عليك كثير؟",
"هل سبق وشعرت إنه يخاف عليك أكثر من نفسك؟",
"ما أكثر تصرف بسيط خلاك تحبه أكثر؟",
"هل تحب الرسائل الصباحية؟",
"ما أكثر لحظة ودك تعيشها معه من جديد؟",
"هل تعتبر العلاقة بينكم قوية؟",
"هل تشوف الحب كفاية بدون اهتمام؟",
"ما أكثر موقف مضحك صار بينكم؟",
"هل سبق وفاجأك بمكالمة فجأة؟",
"هل تتذكر أول هدية منه؟",
"هل تحب الرسائل الطويلة أو القصيرة؟",
"ما أكثر صوت تحبه منه؟",
"هل تحب لما يغار عليك؟",
"ما أكثر كلمة تقولها له دائم؟",
"هل سبق وقلت له أحبك بدون سبب؟",
"هل تتخيله شريك حياتك للأبد؟",
"هل سبق وبكيت عشانه؟",
"هل تحب الصمت معه؟",
"هل شعرت إنك تتعلم منه أشياء؟",
"هل تعتبر العلاقة قدر؟",
"هل تحب الهدايا أم الكلمات؟",
"هل تعتبره نصك الثاني؟",
"ما أكثر تصرف يخليك تقول (ما أقدر أزعل منه)؟",
"هل شعرت إنه الشخص المناسب فعلاً؟",
"هل سبق وتخيلت حياتك بدونه؟",
"هل سبق وقلت له شي وندمت؟",
"ما أكثر وقت تحس فيه بالحب؟",
"هل تحب تعبر بالكلام أو بالأفعال؟",
"هل تحب المفاجآت؟",
"هل سبق وكتبت له رسالة طويلة؟",
"هل تحب المكالمات المفاجئة؟",
"هل تفتقده بسرعة؟",
"ما أكثر شيء تخاف تفقده فيه؟",
"هل تحب الاهتمام الزايد؟",
"هل تغار بسهولة؟",
"ما أكثر موقف خلاك تثق فيه أكثر؟",
"هل تشعر إنه يشبهك كثير؟",
"هل تحب الجلسات الطويلة معه؟",
"ما أكثر لحظة تتمنى ترجعها؟",
"هل تحس بالراحة لما تسمع صوته؟",
"هل تحب المفاجآت الصغيرة؟",
"هل تفضل الصراحة حتى لو جرحت؟",
"ما أكثر كلمة تحب تسمعها منه؟",
"هل شعرت بالحب الحقيقي معه؟",
"هل تعتبر العلاقة اختبار للمشاعر؟",
"هل تحب تعيش اللحظة ولا تخطط؟",
"هل تشوف نفسك شخص عاطفي؟",
"هل تحب الرسائل اليومية؟",
"هل تفضل التعبير بالموسيقى؟",
"هل تحب الرسائل الليلية الطويلة؟",
"ما أكثر شيء يجعلك تبتسم لما تتذكره؟",
"هل تقدر تنسى موقف زعلك منه بسهولة؟",
"هل تحس إن الحب يحتاج كلام كثير؟",
"هل تفضل كلمة أحبك أو لمسة حنان؟",
"هل تحس الحب خوف أم شغف؟",
"هل تحب العلاقة الهادية ولا المجنونة؟",
"هل تعتبر نفسك الطرف الحساس أكثر؟",
"هل تحب المفاجآت في المناسبات؟",
"هل سبق وقلت أحبك وانت زعلان؟",
"هل تحب الإشارات الصغيرة اللي تدل على حب؟",
"هل تعتبر الغيرة دليل حب؟",
"ما أكثر موقف خلاك تقول (أنا فعلاً أحبه).",
"هل تحب لما يقولك (اشتقت لك)؟",
"هل تحب الرسائل اللي تبدأ بدون سبب؟",
"هل تفضل العلاقة الغامضة أو الصريحة؟",
"هل تحب التفاصيل الصغيرة؟",
"هل تحس الحب يبين في النظرات؟",
"هل تفضل اللقاءات القصيرة أم الطويلة؟",
"هل تحس إن العلاقة بينكم ناضجة؟",
"هل تعتبر الحب صبر؟",
"هل سبق وقلت له سر ما قلته لأحد؟",
"هل تفضل الرسائل العشوائية؟",
"هل تحب لما يسأل عنك بدون سبب؟",
"هل تحس الحب لازم إعلان؟",
"هل تعتبر العلاقة بينكم مميزة؟",
"هل تشوف الحب قرار أو إحساس؟",
"هل تحس العلاقة خلتك أقوى؟",
"هل تحب لما يهتم بتفاصيلك؟",
"هل تعتبر الاهتمام أهم من الحب؟",
"هل تحس العلاقة علمتك الصبر؟",
"هل تحب تطمّن عليه كل يوم؟",
"هل تعتبر الغياب يقتل الحب؟",
"هل تحب اللقاءات المفاجئة؟",
"هل تشوف الحب يكبر مع الوقت؟",
"هل تعتبر الحب صداقة قبل كل شيء؟",
"هل تحس نفسك تتغير عشانه؟",
"هل تحب تعيشون مغامرات جديدة؟",
"هل تعتبر نفسك شخص يغار كثير؟",
"هل تحب تسمع كلمة (وحشتني)؟",
"هل تعتبر نفسك الطرف الرومانسي؟",
"هل تحب لما يقولك (دوم تضحك)؟",
"هل تحس العلاقة بينكم مريحة؟"
]

# -------------------------------------------------------
# ألعاب إضافية
# -------------------------------------------------------

# تحدي الحب
love_challenges = [
    "اكتب له رسالة تبدأ بكلمة (أحبك لأن...).",
    "شارك معه ذكرى ما تنساها.",
    "قل له شي تحبه فيه ما قد قلته.",
    "ارسله صورة قديمة تجمعكم.",
    "احكي له أول لحظة خفق فيها قلبك له.",
    "اكتب له رسالة صوتية قصيرة.",
    "خطط لمفاجأة بسيطة له اليوم.",
    "ارسل له رسالة حب في وقت غير متوقع.",
    "اكتب له سبب يخليك تبتسم لما تتذكره.",
    "اذكر له عادة بسيطة تحبها فيه."
]

# لعبة الاعترافات
confessions = [
    "اعترف بأول شخص جذبك في حياتك.",
    "اعترف بأكثر عادة سيئة عندك.",
    "اعترف بشي ندمت عليه.",
    "اعترف باسم أول حب في حياتك.",
    "اعترف بأكثر شيء تخاف منه.",
    "اعترف بسر ما قلته لأحد.",
    "اعترف بموقف محرج صار لك.",
    "اعترف بشي جميل فيك ما تقوله كثير.",
    "اعترف بشخص تتمنى تعتذر له.",
    "اعترف بأكثر موقف أثر فيك."
]

user_asked_questions = {}

# -------------------------------------------------------
# الردود الرئيسية
# -------------------------------------------------------
@app.route("/callback", methods=['POST'])
def callback():
    signature = request.headers.get('X-Line-Signature', '')
    body = request.get_data(as_text=True)
    try:
        handler.handle(body, signature)
    except InvalidSignatureError:
        abort(400)
    return 'OK'


@handler.add(MessageEvent, message=TextMessage)
def handle_message(event):
    user_id = event.source.user_id
    text = event.message.text.strip().lower()

    if "سؤال" in text or "سوال" in text:
        asked = user_asked_questions.get(user_id, set())
        available = [q for q in questions if q not in asked]
        if not available:
            user_asked_questions[user_id] = set()
            available = questions.copy()
        q = random.choice(available)
        user_asked_questions.setdefault(user_id, set()).add(q)
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text=q))
        return

    elif "تحدي" in text:
        c = random.choice(love_challenges)
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text=f"💌 {c}"))
        return

    elif "اعتراف" in text:
        conf = random.choice(confessions)
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text=f"🩷 {conf}"))
        return

    elif "مساعدة" in text:
        help_text = (
            "❤️ أوامر البوت:\n"
            "- 'سؤال' أو 'سوال' → سؤال حب أو صراحة عشوائي.\n"
            "- 'تحدي' → تحدي حب رومانسي.\n"
            "- 'اعتراف' → سؤال اعتراف صريح.\n"
            "- 'مساعدة' → عرض الأوامر.\n"
            "كل مرة الأسئلة والتحديات تتغير تلقائيًا 💫"
        )
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text=help_text))
        return

    # لا يرد على أي شيء آخر
    return


if __name__ == "__main__":
    port = int(os.environ.get('PORT', 5000))
    app.run(host='0.0.0.0', port=port)
