# app.py
from flask import Flask, request, abort
from linebot import LineBotApi, WebhookHandler
from linebot.exceptions import InvalidSignatureError
from linebot.models import (
    MessageEvent, TextMessage, TextSendMessage,
    TemplateSendMessage, ButtonsTemplate, MessageAction,
    PostbackEvent, PostbackAction
)
import random, os, urllib.parse

app = Flask(__name__)

# ------------------ ุถุจุท ููุงุชูุญ LINE ูู ูุชุบูุฑุงุช ุงูุจูุฆุฉ ------------------
LINE_CHANNEL_ACCESS_TOKEN = os.environ.get('LINE_CHANNEL_ACCESS_TOKEN')
LINE_CHANNEL_SECRET = os.environ.get('LINE_CHANNEL_SECRET')

if not LINE_CHANNEL_ACCESS_TOKEN or not LINE_CHANNEL_SECRET:
    print("โ ุญุท ูุชุบูุฑุงุช ุงูุจูุฆุฉ LINE_CHANNEL_ACCESS_TOKEN ู LINE_CHANNEL_SECRET")
    exit(1)

line_bot_api = LineBotApi(LINE_CHANNEL_ACCESS_TOKEN)
handler = WebhookHandler(LINE_CHANNEL_SECRET)

# ------------------ ุฐุงูุฑุงุช ูุคูุชุฉ ูุชุชุจุน ุงููุณุชุฎุฏููู ------------------
user_asked_questions = {}    # user_id -> set()  (ุตุฑุงุญุฉ)
user_asked_confessions = {}  # user_id -> set()  (ุงุนุชุฑุงู)
user_asked_challenges = {}   # user_id -> set()  (ุชุญุฏู)

# ุชุญููู ุงูุดุฎุตูุฉ: ุญุงูุฉ ูู ูุณุชุฎุฏู ุฃุซูุงุก ุงูุงุฎุชุจุงุฑ
# user_analysis_progress[user_id] = {"questions": [indices], "current": int, "scores": {trait:count}}
user_analysis_progress = {}

# ------------------ ููุงุฆู ุงูุฃุณุฆูุฉ (ุนุงููุฉ ุณุนูุฏูุฉ) ------------------
# ==== 100 ุณุคุงู ุตุฑุงุญุฉ/ุฌุฑุฃุฉ
truth_questions = [
"ูุด ุฃูุซุฑ ุดู ุชุฎุงู ุชุฎุณุฑูุ",
"ูุด ุขุฎุฑ ูุฐุจุฉ ููุชูุงุ",
"ุงุนุชุฑู ุจุดู ููุง ุฃุญุฏ ูู ููุฌูุฏ",
"ูู ุนูุฑู ุบุฑูุช ูู ุดุฎุต ุจุฏูู ุณุจุจ ูุงุถุญุ",
"ูุด ุฃูุซุฑ ุดู ูุฒุนุฌู ูู ุงูุนูุงูุฉุ",
"ูู ุชุฑุงูุจ ุฌูุงูู ูู ูุฌูุณ ุจุนูุฏุ",
"ูู ูููู ุชูุฐุจ ุนุดุงู ุชููู ููููุ",
"ูุด ุฃูุซุฑ ูููู ูุญุฑุฌ ุตุงุฑ ูู ูุน ุดุฑูููุ",
"ูู ุณุจู ุชุนุจุงู ูู ุงูุนูุงูุฉุ",
"ูุด ุฃูุซุฑ ุดูุก ุชุจุบุงู ูู ุดุฑูููุ",
"ูู ุชุจู ุชูุฌุฑ ุงูุดุฎุต ุงููู ุชุญุจู ูู ุฒุนูุชุ",
"ูู ููุฑุช ุชุทูู ูุฌุฑุฏ ุชูููุฑุ",
"ูู ุชุญุจ ุชูุงุฌุฆู ุจุฑุณุงูุฉ ุญุจ ูุฌุฃุฉุ",
"ูู ูุฑุฉ ุฎููุชู ููุชุธุฑ ูุงูุช ูุชุนูุฏุ",
"ูุด ุฃุณูุง ุชุตุฑู ุณููุชูู ูุน ุจุนุถุ",
"ูู ุณููุช ูููุจ ูุฒุญ ููู ุนูู ุดุฑูููุ",
"ูู ุชูุถูู ุชุตุงุฑุญู ุฃู ุชูุชู ูุดุงุนุฑูุ",
"ูู ุชุนููู ุจุณุฑุนุฉ ุนูู ูุงุณ ุฌุฏุงุฏุ",
"ูู ุณุจู ูููุช ูู ุฃูููุฉ ูุดุงุนุฑูุ",
"ูู ุชุนุชูุฏ ุฅู ุงูุญุจ ูุญุชุงุฌ ุชุถุญูุงุช ูุจูุฑุฉุ",
"ูู ุชุญุจ ุฅููู ุชุชููููู ูู ูููุ",
"ูู ุชุชุถุงูู ูู ุชูุฑุฑ ููุณ ุงูููุงูุ",
"ูู ุชูุฏุฑ ุชุนูุด ุจุฏูู ุงูุชูุงู ูููููุ",
"ูู ุชุญุจ ุงูููุงุฌุขุช ุงููุจูุฑุฉ ููุง ุงูุจุณูุทุฉุ",
"ูู ุชุญุจ ุชูุฏู ูุฏูุฉ ููุง ููุงู ุฑููุงูุณูุ",
"ูู ุณุจู ุญุงููุช ุชุบูุฑ ููุณู ุนุดุงู ุฃุญุฏุ",
"ูู ุชุญุจ ุชุนุจุฑ ุจุงูููุงูู ููุง ุจุงูููุงูุ",
"ูู ุชุจูู ูุดุงุนุฑู ุจุณุฑุนุฉุ",
"ูู ุชุญุจ ุชุจุงุฏุฑ ูู ุงููุตุงูุญุฉ ููุง ุชูุชุธุฑุ",
"ูู ุชููู ูููุจุช ููุง ููุชูุฑูุบุ",
"ูู ุชูุถูู ุงูุฃูุดุทุฉ ุงููุงุฏูุฉ ููุง ุงููุบุงูุฑุงุชุ",
"ูู ุชูุชู ุจุฑุฃู ุฃููู ูู ุดุฑูููุ",
"ูู ุชุญุจ ุชุนุฑู ูู ุชูุงุตูู ููููุ",
"ูู ุชูุฏุฑ ุชูุณู ุฒุนู ุจุณูููุฉุ",
"ูู ุชุญุจ ุงูุฅูุชูุงู ุงููููู ููุง ุงูููุงุณุจุงุชุ",
"ูู ุชุชุถุงูู ูู ุงูุฌุฏู ุงูุทูููุ",
"ูู ุชูุถูู ุงูููุงู ุงูุตุฑูุญ ุญุชู ูู ุฌุงุฑุญุ",
"ูู ุชุนูู ููุง ููุงุฌุขุช ุจุฏูู ููุงุณุจุฉุ",
"ูู ุชุญุจ ุฅููู ุชุดุงูุฏูู ููุณ ุงูุฃููุงูุ",
"ูู ุชูุถูู ุงููุฏุงูุง ุงููููุฏุฉ ููุง ุงูุบุฑูุจุฉุ",
"ูู ุชุญุจ ุชุฌูุฒ ูู ุดู ุจููุณูุ",
"ูู ุชุญุจ ุชุบูุฑ ุฑูุชูููู ูู ููุช ูููุชุ",
"ูู ุชุญุจ ุงูุฅููุงุกุงุช ุงูุตุบูุฑุฉ ุฃูุซุฑ ูู ุงูููุงูุ",
"ูู ุชูุงู ูุชุจูู ุฒุนูุงูุ",
"ูู ุชุญุจ ุชุฏุงูู ุนูู ุนุจุงุฑุงุช ุงูุญุจุ",
"ูู ูู ูููุฉ ุฃูุซุฑ ูู ุจุนุถ ุงูุดูุ",
"ูู ูููู ุชุนุทู ูุฑุตุฉ ุจุนุฏ ุบูุท ูุจูุฑุ",
"ูู ุชุญุจ ุชุดุงุฑู ูุฎุทุทุงุชู ูุนูุ",
"ูู ุชูุงุจ ุงูุงุนุชุฐุงุฑ ููุฑุงูุชูุ",
"ูู ุชุณุชุดูุฑ ูุจู ุงุชุฎุงุฐ ูุฑุงุฑุงุช ูุจูุฑุฉุ",
"ูู ุชุฏู ุญุฏูุฏ ููุนูุงูุงุช ุงูุซุงููุฉุ",
"ูู ุชุธู ุฅู ุงูุบูุฑุฉ ุฏููู ุงูุชูุงูุ",
"ูู ุชูุฏุฑ ุชุชุฎูู ุนู ุดูุก ููู ุนุดุงููุงุ",
"ูู ุชุญุจ ุชุณุชูู ูุฏุงูุงุ",
"ูู ุชูุถูู ุงูููุงููุงุช ุงูุทูููุฉ ููุง ุงูุฑุณุงุฆูุ",
"ูู ุนูุฏู ุนุงุฏุฉ ุบุฑูุจุฉ ูุญุจูุงุ",
"ูู ุชุดุงูุฏ ูุญุงุฏุซุงุชู ูู ุชูุฏุฑุ",
"ูู ุชุญุจ ุงูุชูุงุตู ุงููุณุงุฆู ุฃูุซุฑ ูู ุงูุตุจุงุญุ",
"ูู ุชุญุจ ุงูุงุญุชูุงู ุจุฃุดูุงุก ุจุณูุทุฉุ",
"ูู ุชุญุจ ุชุฎุทุท ููุณุชูุจูู ูุนุงูุ",
"ูู ุชูุฏู ุนูู ุฃูู ุนูุงูุฉ ููุ",
"ูู ุชุคูู ุจุงูุญุจ ูู ุฃูู ูุธุฑุฉุ",
"ูู ุชุธู ุชููุจ ุงููุฒุงุฌ ูุคุซุฑ ุจุงูุนูุงูุฉุ",
"ูู ุชุญุจ ุชููู ุงูุชูุงูู ุจุณุฑุนุฉุ",
"ูู ุชูุฑู ุงููุจุงูุบุฉ ุจุงูุญุจุ",
"ูู ุชุญุจ ุชูุชุจ ุฑุณุงูุฉ ุทูููุฉ ููุ",
"ูู ุชุญุจ ุงูููุงุฌุขุช ุจุงูููู ููุง ุงูุตุจุงุญุ",
"ูู ุชุดุนุฑ ุฃูู ููุฑุฃ ุฃููุงุฑูุ",
"ูู ุชุชููุน ููู ููุงูู ุฑููุงูุณูุฉ ุฏุงููุ",
"ูู ุชุฑุฏ ุจุณุฑุนุฉ ุนูู ุฑุณุงูุชูุ",
"ูู ุชุญุจ ุชุจุชุณู ูุฏุงู ุงููุงุณ ุนุดุงู ููุฑุญุ",
"ูู ุชูุฏูุฑ ุงูุฃุดูุงุก ุงูุตุบูุฑุฉุ",
"ูู ุชุธู ุฅู ุงูุญุจ ูุชุบุณู ุจุงูุบุถุจุ",
"ูู ุชุญุจ ุชุดุงุฑูู ููุชู ูู ุชุนุจุ",
"ูู ุชูุถู ูุฒูุฉ ุจุณูุทุฉ ููุง ุณูุฑุ",
"ูู ุชุญุจ ุชุฌุฑูุจ ุฃุดูุงุก ุฌุฏูุฏุฉ ูุนูุ",
"ูู ุชุจู ูููู ุนูุฏู ูุณุงุญุฉ ุดุฎุตูุฉุ",
"ูู ุชุญุจ ุชูุงุจูู ูู ูููุ",
"ูู ุชูุชู ุจุชุฑุจูุชู ุฃู ุดุฎุตูุชูุ",
"ูู ุชุญุจ ุงูู ุชููู ุฏุงูููุง ุฌูุจ ุงููู ุชุญุจูุ",
"ูู ุชุจุฏู ุญุจู ุจููุงู ูุฎุชุตุฑ ููุง ุชูุงุตููุ",
"ูู ุชุญุจ ุชุจูู ุงูุชูุงูู ูุฏุงู ุฃูููุ",
"ูู ุชูุถู ูุญู ุงููุดููุฉ ููุง ูุนุงุชุจูุ",
"ูู ุชุชุฃุซุฑ ุจุฃูู ูููุฉ ุชูุงูุ",
"ูู ุชุธู ุฅู ุงูููุช ูุบูุฑ ุงููุดุงุนุฑุ",
"ูู ุชุจู ุชููู ุจุฏุงูู ุนูุงูุชูู ูุตุฉ ุชุญุจ ุชุฐูุฑูุงุ",
"ูู ุชุญุจ ุชุฎูู ุงูุนูุงูุฉ ุทุจูุนูุฉ ููุง ุนุฑุถุ",
"ูู ุชูุถูู ููุงุด ููุทูู ููุง ุดุนูุฑูุ",
"ูู ูููู ุชุซู ุจุณุฑุนุฉุ",
"ูู ุชุญุจ ุฅููู ุชุชููููู ุจุตุฑุงุญุฉ ุนู ุงููุงูุ",
"ูู ุชุธู ุฅู ุงูุตุฑุงุญุฉ ุนููุงู ููู ุดูุกุ"
]

# ==== 100 ุงุนุชุฑุงู
confession_questions = [
"ุงุนุชุฑู ุจุฃูู ุญุจ ูู ุญูุงุชู",
"ุงุนุชุฑู ุจุดู ุณููุชูู ูุงูุช ุตุบุฑ ูุฎุฌูุงู ููู",
"ุงุนุชุฑู ุจุญุงุฌุฉ ูุฎููู ููุญูู",
"ุงุนุชุฑู ุจุฃูุซุฑ ูุฑุฉ ุจูุช ูู ุงููุฑุญ",
"ุงุนุชุฑู ุจุญุงุฌุฉ ุฌุฑูุจุชูุง ููุง ููุชูุง ูุฃุญุฏ",
"ุงุนุชุฑู ุจุงูุชุตุฑู ุงููู ูุฏูุช ุนููู",
"ุงุนุชุฑู ุจุฃูุฑุจ ุดุฎุต ุฃุซูุฑ ููู",
"ุงุนุชุฑู ุจุญุงุฌุฉ ุบุฑูุจุฉ ุชุญุจูุง",
"ุงุนุชุฑู ุจุฃูู ูููุฉ ุญุจ ููุชูุง",
"ุงุนุชุฑู ุจุญุงุฌุฉ ุชูุชุฎุฑ ูููุง ุจุณ ูููู ูุนุฑู",
"ุงุนุชุฑู ุจุฃุบุฑุจ ุญูู ุตุงุฑ ูู ุนู ุญุจ",
"ุงุนุชุฑู ุจุฃูู ูุฑุฉ ุญุณุช ูููุง ุจุงูุฎุฌู ูุฏุงู ุญุฏ",
"ุงุนุชุฑู ุจุญุงุฌุฉ ุชููุช ูู ุชุฑุฌุน",
"ุงุนุชุฑู ุจุญุงุฌุฉ ุบุฑุชูุง ุนุจุซุฉ",
"ุงุนุชุฑู ุจุญุงุฌุฉ ุชุจ ุชุนุชุฐุฑ ููุง",
"ุงุนุชุฑู ุจุญุงุฌุฉ ูุง ฺฉูุช ูุณุชุนุฏ ุฃุญููููุง",
"ุงุนุชุฑู ุจุญุงุฌุฉ ุชุญุณูุง ุถุนู ุนูุฏู",
"ุงุนุชุฑู ุจุญุงุฌุฉ ุณูุช ูู ุชุฃุซุฑ ุดุฏุฏ",
"ุงุนุชุฑู ุจุญุงุฌุฉ ุบุฑุช ูุฑุงุฑู ู ุงูุญุงุฉ",
"ุงุนุชุฑู ุจุญุงุฌุฉ ุชุดุชุงู ููุง ูุญุฏ ุงูุญูู",
"ุงุนุชุฑู ุจุญุงุฌุฉ ูุงุฏุฉ ุชููุช ุจุจุงูู ุฏุงูู",
"ุงุนุชุฑู ุจุญุงุฌุฉ ููุช ุชุฎุจ ุนู ุนุงุฆูุชู",
"ุงุนุชุฑู ุจุญุงุฌุฉ ุณููุชฺพุง ุจุงูุฏูุงุน",
"ุงุนุชุฑู ุจุญุงุฌุฉ ูุง ุชูุฏุฑ ุชูุตููุง ุจูููุงุช",
"ุงุนุชุฑู ุจุญุงุฌุฉ ุชุฎุงู ูู ุงููุงุณ ุนุฑูููุง",
"ุงุนุชุฑู ุจุญุงุฌุฉ ููุช ุชุจ ุชููููุง ููุชูุง",
"ุงุนุชุฑู ุจุญุงุฌุฉ ุบุฑุช ูู ููุธูุฑุชู ููุญุจ",
"ุงุนุชุฑู ุจุญุงุฌุฉ ุชุถุญู ููุง ุชุชุฐูุฑูุง",
"ุงุนุชุฑู ุจุญุงุฌุฉ ุฌุฑูุจุชูุง ูุฎูุช ูููุง",
"ุงุนุชุฑู ุจุญุงุฌุฉ ุชุดูููุง ุนูุงูุฉ ูู ุญูุงุชู",
"ุงุนุชุฑู ุจุญุงุฌุฉ ุชุฎุงู ุชุนุชุฑู ุจูุง",
"ุงุนุชุฑู ุจุญุงุฌุฉ ูุง ูุฏ ุญูุชูุง ูุญุฏ",
"ุงุนุชุฑู ุจุญุงุฌุฉ ุฎููุฉ ูู ุทูููุชู",
"ุงุนุชุฑู ุจุญุงุฌุฉ ุบุฑุช ูุนูู ุงูุญุงุฉ",
"ุงุนุชุฑู ุจุญุงุฌุฉ ููุฉ ูุง ุชููุนุชูุง",
"ุงุนุชุฑู ุจุญุงุฌุฉ ูููุชู ุชุนุชูุฏูุง ููููุฉ",
"ุงุนุชุฑู ุจุญุงุฌุฉ ุชุนุชุจุฑูุง ููุทุฉ ุชุญููู",
"ุงุนุชุฑู ุจุญุงุฌุฉ ุชููุช ูู ุชุนูู ุงููุงุณ ูููุง",
"ุงุนุชุฑู ุจุญุงุฌุฉ ุฎููุช ุนูุฏู ุฃุซุฑ ุฏุงุฆู",
"ุงุนุชุฑู ุจุญุงุฌุฉ ุชุนุชูุฏ ุงููุง ุชุณุงุนุฏ ุงููุงุณ",
"ุงุนุชุฑู ุจุญุงุฌุฉ ููุช ุชุชููู ุงุนุงุฏุฉ ุงูุฒูู",
"ุงุนุชุฑู ุจุญุงุฌุฉ ุณุจุจุช ูู ุงูุฏูุงุด",
"ุงุนุชุฑู ุจุญุงุฌุฉ ูุดุชุงู ุชุฑุฌุน ููุง",
"ุงุนุชุฑู ุจุญุงุฌุฉ ุญุณูุชูุง ุถุนู ูุงูุชูุช ูุตุงูุญู",
"ุงุนุชุฑู ุจุญุงุฌุฉ ุชุธููุง ุบูุทุฉ ููู ุชุนููุช ูููุง",
"ุงุนุชุฑู ุจุญุงุฌุฉ ุชููุช ูู ููุชูุง ููุจููุง",
"ุงุนุชุฑู ุจุญุงุฌุฉ ุชููุช ูู ุงุฏูุช ููุง ุญููุง",
"ุงุนุชุฑู ุจุญุงุฌุฉ ุณุฑูุฉ ูุญุฏ ุงูุขู",
"ุงุนุชุฑู ุจุญุงุฌุฉ ุจุชุถุญู ุงููุงุณ ูู ุนุฑูููุง",
"ุงุนุชุฑู ุจุญุงุฌุฉ ูุงูุช ุจุฏุงูุฉ ูุตุฉ ุฌุฏูุฏุฉ",
"ุงุนุชุฑู ุจุญุงุฌุฉ ุฌุฑูุจุช ุชุฎูููุง ุจุงูุถุญู",
"ุงุนุชุฑู ุจุญุงุฌุฉ ุชููุช ูู ูุงู ุญุฏ ุฌูุจู ููุชูุง",
"ุงุนุชุฑู ุจุญุงุฌุฉ ูุงูุช ุจุฏุงูุฉ ุชุบููุฑ ุดุฎุตุชู",
"ุงุนุชุฑู ุจุญุงุฌุฉ ูุงุฑูุชู ูุนุฏุช ุณููู",
"ุงุนุชุฑู ุจุญุงุฌุฉ ุฎุงูุชู ู ูุตุญุชู",
"ุงุนุชุฑู ุจุญุงุฌุฉ ููุช ุชุชููู ุชููููุง ููุงูุฏู",
"ุงุนุชุฑู ุจุญุงุฌุฉ ุฎุฌูุงู ุชููููุง ูุตุฏููู",
"ุงุนุชุฑู ุจุญุงุฌุฉ ุชููุช ูู ุงููุงุณ ุชููููุง",
"ุงุนุชุฑู ุจุญุงุฌุฉ ูุญุฏ ุงูุขู ุชุคุซุฑ ุนููู",
"ุงุนุชุฑู ุจุญุงุฌุฉ ุญุณุช ููุชูุง ุงูู ูุญูุฏ",
"ุงุนุชุฑู ุจุญุงุฌุฉ ุณุฑูุช ุนูู ูุฎุงูู ุชูุดู",
"ุงุนุชุฑู ุจุญุงุฌุฉ ุณุงููุฉ ุจุณ ุฎูุชู ุชุชุบูุฑ",
"ุงุนุชุฑู ุจุญุงุฌุฉ ููุฑุช ุชุฑุฌุนูุง ุจุณ ูู ุชุณุชุทุน",
"ุงุนุชุฑู ุจุญุงุฌุฉ ุงูุง ูุชุฃูุฏ ุงููุง ูุงูุช ุตุงุฆุจุฉ",
"ุงุนุชุฑู ุจุญุงุฌุฉ ุตุงุฑุช ูู ุตุฏูุฉ ุนุฌุจุชู",
"ุงุนุชุฑู ุจุญุงุฌุฉ ุชููุช ุงููููุง ูู ุฒูุงู",
"ุงุนุชุฑู ุจุญุงุฌุฉ ุบูุฑุช ุทุฑููู ุจุงููุณุชูุจู",
"ุงุนุชุฑู ุจุญุงุฌุฉ ุทููุช ุชูููุฑู ูุจู ูุง ุชุณูููุง",
"ุงุนุชุฑู ุจุญุงุฌุฉ ุจุชุถุญู ููุง ุชูุชูุฑ ุฑุฏูุฉ ูุนูู",
"ุงุนุชุฑู ุจุญุงุฌุฉ ููู ุชุจุฏู ุชุญุณ ุงููุง ุทุฑููู",
"ุงุนุชุฑู ุจุญุงุฌุฉ ูุฏู ุงุนุชุฑููุง ุงูููู",
"ุงุนุชุฑู ุจุญุงุฌุฉ ูุง ุชููุนุชูุง ููู",
"ุงุนุชุฑู ุจุญุงุฌุฉ ุญุณููุช ุงููุง ุถุนู ุจุณ ุทูุนุช ููุฉ",
"ุงุนุชุฑู ุจุญุงุฌุฉ ุดูุชูุง ุนูุงูุฉ ุฑุถุง",
"ุงุนุชุฑู ุจุญุงุฌุฉ ุชููุช ูู ุชุนุฑู ุงููู ุตุงุฑ",
"ุงุนุชุฑู ุจุญุงุฌุฉ ุฎููุชูู ุงุดู ุจููุณู",
"ุงุนุชุฑู ุจุญุงุฌุฉ ุบูุฑุช ุงูุชุจุงูู ูุญูุงุฉ",
"ุงุนุชุฑู ุจุญุงุฌุฉ ุณุฑูุฉ ุจุณ ุงุจู ุงุนุชุฐุฑ ุนููุง",
"ุงุนุชุฑู ุจุญุงุฌุฉ ุชุจู ุชููููุง ูููุงุณ ุงูููููู",
"ุงุนุชุฑู ุจุญุงุฌุฉ ุตุงุฑ ููุง ูุชูุฌุฉ ุญููุฉ",
"ุงุนุชุฑู ุจุญุงุฌุฉ ุชููุช ูู ุงุนุฑููุง ูู ููุชูุง",
"ุงุนุชุฑู ุจุญุงุฌุฉ ูุฌูููุฉ ุณููุชฺพุง ูู ุญุจ",
"ุงุนุชุฑู ุจุญุงุฌุฉ ุชุฑุฏุฏ ุงูู ุงุญูููุง ุจุณ ุงุจู ุงููููุง"
]

# ==== 100 ุชุญุฏูุงุช
challenges = [
"ุงุฑุณู ูู ุฑุณุงูุฉ ุชููู ูููุง 'ููููู ุณุจุจ ุฃุญุจู' (ุตูุช ุฃู ูุต)",
"ุงูุจู ุดุฑููู ููุฏุฉ 10 ุซูุงูู ูุฏุงู ุงููุงุณ",
"ุงุตูุน ูู ูุดุฑูุจ ููุถู ูุงุตูุฑู ูุงุจุนุซู",
"ุงูุชุจ ูู ุฑุณุงูุฉ ุชุจุฏุฃ ุจูููุฉ 'ุงุดุชูุช' ูุงุฑุณููุง",
"ุงุนุทู ููุงุฌุฃุฉ ุจุณูุทุฉ ุงูููู ุจุฏูู ุณุจุจ",
"ุบูู ูู ููุทุน ูู ุฃุบููุฉ ุชุญุจูุง",
"ุณุฌู ูู ุฑุณุงูุฉ ุตูุชูุฉ ุชููู ูููุง ุตุฏู ุดุนูุฑู",
"ุงุทุจุฎ ูู ุดู ุจุณูุท ูุดุงุฑู ุตูุฑุชู",
"ุตู ุดุฑููู ุจุซูุงุซ ูููุงุช ูุฏุงู ูุงุณ",
"ุงูุชุจ ูู ูุงุฆูุฉ 5 ุฃุดูุงุก ุชุญุจูุง ููู",
"ุดุงุฑู ุฐูุฑู ูุฏููุฉ ุญููุฉ ุจูููู",
"ุณุงูุญู ุจุดูู ุธุฑูู ุฅุฐุง ูุงู ุฒุนูุงู",
"ุงุญุฌุฒ ูู ููุช ุตุบูุฑ ุงูููู ุจุณ ูู",
"ุงุจุนุซ ูู ุตูุฑุฉ ูุฏููุฉ ุชุฌูุนูู",
"ุณุฌู ููุฏูู ุชููู ููู ูููุฉ ุญุจ ุจุตุฑุงุญุฉ",
"ุฑุชุจ ูู ุฌูุณุฉ ูููู ููุนูุดุฉ ุจุณูุทุฉ",
"ุงุฑุณู ูู ููุงุญุธุฉ ุตุบูุฑุฉ ุนูู ุฎุฏู",
"ุฎุฐ ูู ูููู ุนูู ูุง ูุฌู ูู ุงูุดุบู",
"ุตููู ูู ุฑุณุงูุฉ ุจุฎุทู ูุงุจุนุซููุง",
"ูู ูู ุฃูู ุดูุก ุฎุทุฑ ูู ุจุงูู ุงูุขู",
# ููููู ุญุชู 100
]

# ูููู ุงูุชุญุฏูุงุช ุญุชู 100 ุชููุงุฆูุงู ูู ุฃูู
while len(challenges) < 100:
    i = len(challenges) + 1
    challenges.append(f"ุชุญุฏู ุฑูููุณู ุฑูู {i}: ุณูู ูู ุญุงุฌุฉ ุชุฎููู ูุถุญู")

# ==== ุชุญููู ุงูุดุฎุตูุฉ: ูุณุชุฎุฏู 20 ุณุคุงู ุจุฃุฒุฑุงุฑ (ูู ุณุคุงู 4 ุงุฎุชูุงุฑุงุช ูุฑูุฒุฉ ุจู trait)
analysis_questions = [
    {
        "q": "ูู ุฒุนูู ููููุ ูุด ุชุณููุ",
        "opts": [
            ("ุฃูุฏู ูุงููุฑ ูุจู ูุง ุฃุฑุฏ", "calm"),
            ("ุฃููุนู ูุฃุชููู ุนูู ุทูู", "strong"),
            ("ุฃุฌูุณ ูุงุทูุน ุนู ุงูููุถูุน ุดูู", "sensitive"),
            ("ุฃุญุงูู ุฃุญู ุงูููุถูุน ุนููู", "social")
        ]
    },
    {
        "q": "ููุง ุฃุญุฏ ููุฏุญูุ ูุด ุดุนูุฑูุ",
        "opts": [
            ("ุฃุณุชุญู ููู ุฃูุฑุญ", "sensitive"),
            ("ุฃุณุชุบู ุงููููู ูุงุจูู ุนููู", "strong"),
            ("ุฃุถุญู ูุฃุบูุฑ ุงูููุถูุน", "social"),
            ("ุฃุฎุฐูุง ุจูุฏูุก ููุง ุฃุจุงูุบ", "calm")
        ]
    },
    {
        "q": "ูู ุนุฒููุฉุ ูุด ุชุณูู ุฃูุซุฑุ",
        "opts": [
            ("ุงุฌูุณ ุจุฑุงุญุฉ ูุงุชูุฑุฌ", "calm"),
            ("ุงุชุญุฑู ูุน ุงููุงุณ ูุฃุชููู", "social"),
            ("ุฃุฑุงูุจ ูุจุณ ุงุชููู ูุน ูุงุณ ูุญุฏุฏุฉ", "sensitive"),
            ("ุชูุธู ูุชุฏุจุฑ ุงูุฃููุฑ", "strong")
        ]
    },
    {
        "q": "ูู ุถุงููู ุถุบุท ุงูุดุบูุ ููู ุชุฎููุ",
        "opts": [
            ("ุงูุนุฏ ูุญุงูู ูุงุณุชุฑุฌุน ุงููุงุฑู", "calm"),
            ("ุงุฎุฐ ุฑุงุญุฉ ูุน ุงููุงุณ ุงููู ุงุญุจูู", "social"),
            ("ุงูุชุจ ูุดุงุนุฑู ูุงุนุจุฑ ุนููุง", "sensitive"),
            ("ุงุนูู ุฎุทุฉ ูุงูุฌุฒ ุจุณุฑุนุฉ", "strong")
        ]
    },
    {
        "q": "ุงุฐุง ุนุทูุชู ูุฑุตุฉ ุชููุฏ ูุดุฑูุนุ ูุด ุชุณููุ",
        "opts": [
            ("ุงููุฏ ุจูู ุซูุฉ", "strong"),
            ("ุงุฌูุน ูุฑูู ูุงุนูู ุทุงูุฉ", "social"),
            ("ุงุญุจ ุงุณุชูุน ูุงููุฑ ุจุฎุทูุงุช", "calm"),
            ("ุงุจุชูุฑ ูุงููุฑ ุฎุงุฑุฌ ุงูุตูุฏูู", "sensitive")
        ]
    },
    {
        "q": "ูู ูุงุจูุช ุดุฎุต ุฌุฏูุฏุ ููู ุชุชุนุงููุ",
        "opts": [
            ("ุงุชูุชุญ ูุงุชุนุฑู ุจุณุฑุนุฉ", "social"),
            ("ุงูุชุธุฑ ูุงุชุงุจุน ุชุตุฑูุงุชู", "calm"),
            ("ุงุญุงูู ุงููู ูุดุงุนุฑู", "sensitive"),
            ("ุงุฎุฐ ุงููุจุงุฏุฑุฉ ูุงุจุฏุฃ ุงูุญุฏูุซ", "strong")
        ]
    },
    {
        "q": "ููู ุชุชุนุงูู ูุน ุงูููุฏุ",
        "opts": [
            ("ุฃุณุชูุน ูุงุชุนูู", "calm"),
            ("ุฃุฑุฏ ุจุญุฒู ูู ูุงู ุบูุฑ ููุตู", "strong"),
            ("ุฃุชุฃุซุฑ ุชูุฑูุจุงู ูุงูุฒุนุฌ", "sensitive"),
            ("ุฃุถุญู ูุฃุฎูู ุงููููู", "social")
        ]
    },
    {
        "q": "ูุด ุงุณููุจู ุจุงูุงููุงุนุ",
        "opts": [
            ("ูุฏูุก ูููุทู", "calm"),
            ("ุญูุงุณ ูููุฉ ููุงู", "strong"),
            ("ูุฑุจ ุนุงุทูู ูููู", "sensitive"),
            ("ุถู ุงููุงุณ ููุฌูุฉ ูุธุฑู", "social")
        ]
    },
    {
        "q": "ูู ุตุงุฑ ุฎูุงู ุจุณูุทุ ููู ุชููููุ",
        "opts": [
            ("ุจุชูุงูู ููุฏูุก", "calm"),
            ("ุจุชูุงุฌู ุนูู ุทูู", "strong"),
            ("ุชุญุงูู ุชููู ูุดุงุนุฑ ุงูุทุฑู ุงูุซุงูู", "sensitive"),
            ("ุชุถุญู ูุชุฎูู ุงูุฌู", "social")
        ]
    },
    {
        "q": "ูุด ุชุญุณ ูููุฒู ูู ุงูุชุนุงููุ",
        "opts": [
            ("ูุฏูุก ุงุนุตุงุจ", "calm"),
            ("ุญุฒู ููุฑุงุฑ", "strong"),
            ("ุญุณุงุณูุฉ ูููู", "sensitive"),
            ("ุทุงูุฉ ูุงุฌุชูุงุนูุฉ", "social")
        ]
    },
    {
        "q": "ูู ุนุทูุชู ููุช ูุฑุงุบุ ูุด ุชุณููุ",
        "opts": [
            ("ุงูุฑุฃ ุฃู ุงุณุชุฑุฎู", "calm"),
            ("ุงุฌุชูุน ูุน ุงูุฃูู ูุงูุฃุตุญุงุจ", "social"),
            ("ุงุนุจุฑ ุนู ูุดุงุนุฑู ุงู ุงูุชุจ", "sensitive"),
            ("ุงุจุฏุฃ ูุดุฑูุน ุงู ููุงูุฉ ุฌุฏูุฏุฉ", "strong")
        ]
    },
    {
        "q": "ูู ุญุตู ูููู ููุงุฌุฆ ูุฒุนุฌุ ุฑุฏุฉ ูุนููุ",
        "opts": [
            ("ุงูุฏู ูุงููุฑ", "calm"),
            ("ุงุชููู ุจุตุฑุงุญุฉ ูุงุทูุน ุงูุญุฒู", "strong"),
            ("ุงุจุญุซ ุนู ุงููุดุงุนุฑ ุงููู ูุฑุงู", "sensitive"),
            ("ุงูุฒุญ ูุงููู ุงููููู", "social")
        ]
    },
    {
        "q": "ุงุฐุง ุบูุทุชุ ุฃู ุฑุฏ ุชุณููุ",
        "opts": [
            ("ุงุนุชุฐุฑ ูุงุตุญุญ ุบูุทุชู", "calm"),
            ("ุงุนูู ุฎุทุฉ ูุชุตููุญ", "strong"),
            ("ุฃุจุฏู ุงุณู ุจุนูู ููุดุงุนุฑ", "sensitive"),
            ("ุงุฎูู ุฌู ูุฑุญ ูุชุฎููู ุงูุชูุชุฑ", "social")
        ]
    },
    {
        "q": "ุชุฎุชุงุฑ ุชููู ูุดููุฑ ุจูู ุงููุงุณ ููุง ูุงุฏู ููููุฒุ",
        "opts": [
            ("ุงุญุจ ุงูุดูุฑุฉ ูุงููุฑุจ ูู ุงููุงุณ", "social"),
            ("ุงุญุจ ุงูุงุฎุชูุงุก ูุงููุฏูุก", "calm"),
            ("ุงุญุจ ุงูุธููุฑ ุจุตุฏู ูุงุญุงุณูุณ", "sensitive"),
            ("ุงุญุจ ุงุซุจุงุช ููุณู ุจูุฑุงุฑุงุชู", "strong")
        ]
    },
    {
        "q": "ูู ุดูุช ุธููุ ููู ุชุชุตุฑูุ",
        "opts": [
            ("ุงุญุงูู ุฃูุฏูู ูุงุนุงูุฌ", "calm"),
            ("ุงุชุฏุฎู ูุจุญุฒู", "strong"),
            ("ุงุชุฃุซุฑ ูุงุนุทู ุฏุนู ุนุงุทูู", "sensitive"),
            ("ุงุฌูุน ุงููุงุณ ูุงุณูู ูููู", "social")
        ]
    },
    {
        "q": "ูู ุนุฑุถูุง ุนููู ุชุญุฏู ูุจูุฑุ ูููุ",
        "opts": [
            ("ุงุฏุฑุณ ุงููุฎุงุทุฑ ูุงูุดู", "calm"),
            ("ุงูุจู ูุจููุฉ", "strong"),
            ("ุงุญุณ ุจุงููุฎุงุทุฑ ูุงุจูู ุดูู", "sensitive"),
            ("ุงุจุฏุฃ ูุงุฌูุจ ุงููุงุณ ูุนู", "social")
        ]
    },
    {
        "q": "ูุด ููุน ุงูุฃุตุฏูุงุก ุงููู ุชุฑุชุงุญ ูุนููุ",
        "opts": [
            ("ุงููู ูุงุฏุฆูู ูุนูุฏูู ุนูู", "calm"),
            ("ุงููู ูุฑุญูู ูููุชุนู", "social"),
            ("ุงููู ูุญุณูู ูููู ููููููููู", "sensitive"),
            ("ุงููู ูุนุชูุฏูู ุนูู ูุงูู ุงุนุชูุฏ ุนูููู", "strong")
        ]
    },
    {
        "q": "ููู ุชุญุจ ุชูุนุจูุฑ ุนู ูุฑุญุชูุ",
        "opts": [
            ("ุจุงุจุชุณุงูุฉ ูุงุฏูุฉ", "calm"),
            ("ุจุงุญุชูุงู ูุน ุงููุงุณ", "social"),
            ("ุจุฏููุน ูุฑุญ ููุดุงุนุฑ", "sensitive"),
            ("ุจุงูุฌุงุฒ ููุชูุฌุฉ ูุงุถุญุฉ", "strong")
        ]
    },
    {
        "q": "ูู ุฎูุตุช ุงูุงุณุฆูุฉุ ุงู ุดูู ุชุจู ุงููุชูุฌุฉุ",
        "opts": [
            ("ูุตู ููุตู ุนู ูุดุงุนุฑู", "sensitive"),
            ("ูุตุงูุญ ุนูููุฉ ูุชุทููุฑ ููุณู", "strong"),
            ("ููุทุฉ ููุฉ ููุฏูุก", "calm"),
            ("ูุตุงูุญ ุชูุงุตู ูุงุฌุชูุงุนูุงุช", "social")
        ]
    }
]

# ------------------ ุฏูุงู ูุงุฌูุฉ ุงูุฃุฒุฑุงุฑ ุงูุฑุฆูุณูุฉ ------------------
def main_menu_buttons():
    buttons_template = ButtonsTemplate(
        title="ุฃุจุบุงู ุชุณุชูุชุน",
        text="ุงุฎุชุงุฑ ุงููู ุชุจู ุชุณููู ุงูุญูู:",
        actions=[
            MessageAction(label="๐ฏ ุชุญููู ุงูุดุฎุตูุฉ", text="ุชุญููู"),
            MessageAction(label="๐ฌ ุตุฑุงุญุฉ ูุฌุฑุฃุฉ", text="ุตุฑุงุญุฉ"),
            MessageAction(label="๐ฃ๏ธ ุงุนุชุฑุงูุงุช", text="ุงุนุชุฑุงู"),
            MessageAction(label="๐ฅ ุชุญุฏูุงุช", text="ุชุญุฏู"),
            MessageAction(label="โ ูุณุงุนุฏุฉ", text="ูุณุงุนุฏุฉ")
        ]
    )
    return TemplateSendMessage(alt_text="ุงููุงุฆูุฉ", template=buttons_template)

# ------------------ ูุธุงุฆู ุงูุชุญููู: ุจุฏุก ูุจูุงุก ุณุคุงู ูุญุณุงุจ ูุชูุฌุฉ ------------------
def start_analysis(user_id):
    # ูุฎุชุงุฑ 20 ุณุคุงู ุนุดูุงุฆู ูู pool (ุจุฏูู ุชูุฑุงุฑ)
    pool = list(range(len(analysis_questions)))
    chosen = random.sample(pool, k=min(20, len(pool)))
    user_analysis_progress[user_id] = {
        "questions": chosen,
        "current": 0,
        "scores": {"strong":0, "sensitive":0, "social":0, "calm":0}
    }
    qidx = user_analysis_progress[user_id]["questions"][0]
    return build_analysis_question_message(qidx, 1, len(chosen))

def build_analysis_question_message(qidx, number, total):
    item = analysis_questions[qidx]
    title = f"ุณุคุงู {number}/{total}: {item['q']}"
    actions = []
    for choice_index, (label, trait) in enumerate(item["opts"]):
        data = urllib.parse.urlencode({"action":"analysis_answer","q":str(qidx),"c":str(choice_index),"t":trait})
        actions.append(PostbackAction(label=label, data=data))
    buttons = ButtonsTemplate(title="ุชุญููู ุงูุดุฎุตูุฉ", text=title, actions=actions)
    return TemplateSendMessage(alt_text="ุณุคุงู ุชุญููู", template=buttons)

def handle_analysis_postback(user_id, qidx, choice_idx, trait):
    data = user_analysis_progress.get(user_id)
    if not data:
        return "ูุง ููู ุงุฎุชุจุงุฑ ุดุบุงู ุนูุฏูุ ุงูุชุจ 'ุชุญููู' ูุชุจุฏุฃ."
    # ุณุฌู ููุงุท
    if trait in data["scores"]:
        data["scores"][trait] += 1
    # ุชูุฏูู ููุณุคุงู ุงููุงุฏู
    data["current"] += 1
    if data["current"] >= len(data["questions"]):
        # ุงูุชูู ุงูุงุฎุชุจุงุฑ: ุงุญุณุจ ุงููุชูุฌุฉ
        scores = data["scores"]
        del user_analysis_progress[user_id]
        sorted_scores = sorted(scores.items(), key=lambda x: x[1], reverse=True)
        primary, primary_score = sorted_scores[0]
        secondary, secondary_score = sorted_scores[1]
        desc = generate_analysis_text(primary, secondary, scores)
        return desc
    else:
        next_qidx = data["questions"][data["current"]]
        return build_analysis_question_message(next_qidx, data["current"]+1, len(data["questions"]))

def generate_analysis_text(primary, secondary, scores):
    mapping = {
        "strong": ("ููู ููุงุซู", 
                   "ุฃูุช ุดุฎุต ูุงุถุญ ูุตุฑูุญุ ุชููู ุชุงุฎุฐ ุฒูุงู ุงูุฃููุฑ ููุงุชุญุจ ุงูุชุฑุฏุฏ. ุนุงุฏุฉู ุชุจุงุฏุฑ ูุชุญุจ ุชุญู ุงููุดุงูู ุจุณุฑุนุฉ. ูุงูุฃุณููุจ ูุฎููู ูุงุฆุฏ ูู ูุซูุฑ ููุงูู."),
        "sensitive": ("ุญุณุงุณ ูุนุงุทูู",
                      "ุฃูุช ุฅูุณุงู ุนููู ุจุงููุดุงุนุฑุ ุชุญุณ ูุชุชููู ุงููุงุณ ูู ุบูุฑ ูุง ุชูููุ ูุชูุฏูุฑ ุงูุชูุงุตูู ุงูุตุบูุฑุฉ ุงููู ุชุนูู ูุซูุฑ. ูููู ุชุชุฃุซุฑ ุจุณุฑุนุฉ ุจุณ ุจููุณ ุงูููุช ููุจู ูุจูุฑ."),
        "social": ("ุงุฌุชูุงุนู ููุชุญูุณ",
                   "ุชููู ุชููู ูุณุท ุงููุงุณุ ุทุงูุชู ูุนุฏูุฉ ูุชุญุจ ุชุฎูุถ ุชุฌุงุฑุจ ูุน ุงูุขุฎุฑูู. ุณูู ุชูููู ุตุฏุงูุงุช ูุชุญุจ ุชุฎูู ุฌู ุญูู ุญูุงููู."),
        "calm": ("ูุงุฏู ููุชููุฑ",
                 "ุฃุณููุจู ูุชุฃูู ูุฑุงููุ ุชุญุจ ุชููุฑ ูุจู ูุง ุชุชุตุฑู ููุง ุชูุฌุฑู ูุฑุงู ุงูุญูุงุณ. ูุงููุฏูุก ูุฎููู ุตุงุญุจ ูุฑุงุฑ ููุทูู ูู ุงููุซูุฑ ูู ุงูููุงูู.")
    }
    p_title, p_text = mapping[primary]
    s_title, s_text = mapping[secondary]
    extra = ""
    if scores[primary] - scores[secondary] >= 5:
        extra = "ูุงุถุญ ุงู ูุงูุทุงุจุน ูุณูุทุฑ ุนููู ุจุดูู ูุจูุฑุ ุชูุฏุฑ ุชุณุชุซูุฑ ูุงูุดู ูู ููุงุฏุฉ ูุดุงุฑูุนู ูุนูุงูุงุชู."
    elif scores[primary] - scores[secondary] <= 1:
        extra = "ุดูู ุดุฎุตูุชู ูุฒูุฌ ูุชูุงุฒูุ ุชูุฏุฑ ุชุชูููู ูุน ุงูููุงูู ุจุณูููุฉ ูุชุนุทู ุงููุงุณ ุงููู ุญููู."
    else:
        extra = "ุนูุฏู ุชูุงุฒู ุจูู ุงูุฌูุงูุจุ ููู ุฌุงูุจ ูุงุญุฏ ูุจุฑุฒ ุดูู ุนู ุงูุจุงูู."
    result = f"๐ฏ ุชุญูููู:\nุฃุจุฑุฒ ุทุงุจุน: {p_title}\n\n{p_text}\n\nุงูุซุงูู ุงููู ูุจูู: {s_title}\n{s_text}\n\n{extra}\n\nูุตูุญุฉ ุจุณูุทุฉ: ุญุงูู ุชุณุชุบู ููุงุท ููุชู ูุงุญุชุถู ููุงุท ุงูุถุนู ููุฑุต ุชุทููุฑ."
    return result

# ------------------ Webhook handlers ------------------
@app.route("/callback", methods=['POST'])
def callback():
    signature = request.headers.get('X-Line-Signature', '')
    body = request.get_data(as_text=True)
    try:
        handler.handle(body, signature)
    except InvalidSignatureError:
        abort(400)
    return 'OK'

# ------------------ ูุนุงูุฌุฉ ุฑุณุงุฆู ุงููุณุชุฎุฏู ------------------
@handler.add(MessageEvent, message=TextMessage)
def handle_message(event):
    user_id = event.source.user_id
    text = event.message.text.strip().lower()

    # ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ
    if text in ["ุงุจุฏุฃ", "ุงุจุฏุง", "ุจุฏุก", "start", "ูุนุจุฉ", "ุงููุงุฆูุฉ"]:
        line_bot_api.reply_message(event.reply_token, main_menu_buttons())
        return

    # ูุณุงุนุฏุฉ
    if "ูุณุงุนุฏุฉ" in text or "help" in text:
        help_text = (
            "๐ ุฃูุงูุฑ ุงูุจูุช:\n"
            "- ุงูุชุจ 'ุงุจุฏุฃ' ุนูุดุงู ุชุทูุน ูู ุงูุงุฒุฑุงุฑ.\n"
            "- ุงุถุบุท 'ุชุญููู' ุนุดุงู ุชุจุฏุฃ ุงุฎุชุจุงุฑ 20 ุณุคุงู ุจุงูุฃุฒุฑุงุฑ.\n"
            "- ุงุถุบุท 'ุตุฑุงุญุฉ' ุฃู 'ุงุนุชุฑุงู' ุฃู 'ุชุญุฏู' ุนุดุงู ุชุฌูู ุฃุณุฆูุฉ ูุชุญุฏูุงุช ุนุดูุงุฆูุฉ.\n"
            "- ูู ุณุคุงู ูุชุบูุฑ ููุง ูุชูุฑุฑ ูููุณู ุญุชู ุชุฎูุต ุงููุฌููุนุฉ.\n"
            "- ุงูุชุจ 'ุฅุนุงุฏุฉ' ูู ุชุจู ุชูุณุญ ุฌูุณุงุชู ูุชุจุฏุฃ ูู ุฌุฏูุฏ.\n\nุงุณุชูุชุน ๐"
        )
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text=help_text))
        return

    # ุฅุนุงุฏุฉ ุงูุฌูุณุฉ
    if "ุฅุนุงุฏุฉ" in text or "ุงุนุงุฏุฉ" in text or "restart" in text:
        user_asked_questions.pop(user_id, None)
        user_asked_confessions.pop(user_id, None)
        user_asked_challenges.pop(user_id, None)
        user_analysis_progress.pop(user_id, None)
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text="ุชู ุฅุนุงุฏุฉ ุงูุฅุนุฏุงุฏุ ุงูุชุจ 'ุงุจุฏุฃ' ุนูุดุงู ุชุฑุฌุน ุงููุงุฆูุฉ"))
        return

    # ุตุฑุงุญุฉ
    if "ุตุฑุงุญุฉ" in text or "ุฌุฑุฃุฉ" in text or "ุฌุฑุฃุฉ" in text:
        asked = user_asked_questions.get(user_id, set())
        available = [q for q in truth_questions if q not in asked]
        if not available:
            user_asked_questions[user_id] = set()
            available = truth_questions.copy()
        q = random.choice(available)
        user_asked_questions.setdefault(user_id, set()).add(q)
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text=f"โ ุณุคุงู ุตุฑุงุญุฉ:\n{q}"))
        return

    # ุงุนุชุฑุงู
    if "ุงุนุชุฑุงู" in text or "ุงุนุชุฑู" in text:
        asked = user_asked_confessions.get(user_id, set())
        available = [q for q in confession_questions if q not in asked]
        if not available:
            user_asked_confessions[user_id] = set()
            available = confession_questions.copy()
        q = random.choice(available)
        user_asked_confessions.setdefault(user_id, set()).add(q)
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text=f"๐ฃ๏ธ ุงุนุชุฑุงู:\n{q}"))
        return

    # ุชุญุฏู
    if "ุชุญุฏู" in text:
        asked = user_asked_challenges.get(user_id, set())
        available = [q for q in challenges if q not in asked]
        if not available:
            user_asked_challenges[user_id] = set()
            available = challenges.copy()
        c = random.choice(available)
        user_asked_challenges.setdefault(user_id, set()).add(c)
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text=f"๐ฅ ุชุญุฏู:\n{c}"))
        return

    # ุจุฏุก ุงูุชุญููู ุนู ุทุฑูู ูุต (ูู ุงููุณุชุฎุฏู ูุชุจ "ุชุญููู")
    if "ุชุญููู" in text:
        msg = start_analysis(user_id)
        line_bot_api.reply_message(event.reply_token, msg)
        return

    # ุงูุชุฑุงุถู: ูุง ูุฑุฏ ุนูู ุฃู ูุต ุขุฎุฑ
    return

# ------------------ ุงูุชุนุงูู ูุน Postback (ุฃุฒุฑุงุฑ ุงูุชุญููู) ------------------
@handler.add(PostbackEvent)
def handle_postback(event):
    user_id = event.source.user_id
    data = event.postback.data  # ุงูุดูู urlencoded ูู start_analysis
    params = dict(urllib.parse.parse_qsl(data))
    action = params.get("action")
    if action == "analysis_answer":
        qidx = int(params.get("q", 0))
        choice_idx = int(params.get("c", 0))
        trait = params.get("t", "")
        reply = handle_analysis_postback(user_id, qidx, choice_idx, trait)
        if isinstance(reply, TemplateSendMessage):
            line_bot_api.reply_message(event.reply_token, reply)
        else:
            line_bot_api.reply_message(event.reply_token, TextSendMessage(text=reply))
    else:
        # ุฑุฏูุฏ ุนุงูุฉ ูู ูู actions ุซุงููุฉ (ูุง ูุณุชุฎุฏู ุญุงูููุง)
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text="ุชู ุงูุถุบุท"))

# ------------------ ุชุดุบูู ุงูุชุทุจูู ------------------
if __name__ == "__main__":
    port = int(os.environ.get('PORT', 5000))
    app.run(host='0.0.0.0', port=port)
