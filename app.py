from flask import Flask, request, abort
from linebot import LineBotApi, WebhookHandler
from linebot.exceptions import InvalidSignatureError
from linebot.models import MessageEvent, TextMessage, TextSendMessage
import random, os

app = Flask(__name__)

LINE_CHANNEL_ACCESS_TOKEN = os.environ.get('LINE_CHANNEL_ACCESS_TOKEN')
LINE_CHANNEL_SECRET = os.environ.get('LINE_CHANNEL_SECRET')

line_bot_api = LineBotApi(LINE_CHANNEL_ACCESS_TOKEN)
handler = WebhookHandler(LINE_CHANNEL_SECRET)

asked_questions = []

questions = [
    "ما أكثر شيء يثير اهتمامك عند زوجك أو زوجتك",
    "ما أكثر لحظة رومانسية تتذكرها معه أو معها",
    "هل سبق أن خططت لمفاجأة له أو لها",
    "ما أكثر شيء تحب فعله معه في المساء",
    "هل سبق أن أخفيت شعور عن زوجك أو زوجتك",
    "ما أكثر تصرف يجعلك تشعر بالسعادة معه",
    "من الأكثر رومانسية",
    "من الأكثر كذبا",
    "من الأكثر غموضا",
    "من الأكثر ضحكا",
    "من الأكثر خوفا",
    "من الأكثر أنانية",
    "من الأكثر عصبية",
    "من الأكثر تفكيرا بالمستقبل",
    "من الأكثر نسيانا",
    "من الأكثر فوضى",
    "من الأكثر طيبة",
    "من الأكثر مرحا",
    "من أكثر شخص تحبه في حياتك",
    "هل سبق أن أحببت من النظرة الأولى",
    "كيف تعرف أنك تحب شخص ما",
    "هل يمكن أن تسامح بعد الخيانة",
    "من هو أكثر شخص تفكر فيه قبل النوم",
    "ما أكثر كلمة رومانسية تود سماعها منه أو منها",
    "ما أكثر تصرف يزعجك في العلاقة",
    "ما أطرف موقف حصل معك أثناء العلاقة",
    "ما أكثر شيء يجعلك تشعر بالغيرة",
    "ما أكثر شيء تتمنى فعله مع شريك حياتك",
    "ما أكثر لحظة جعلتك تشعر بالسعادة معه أو معها",
    "ما أكثر شيء يخيفك في العلاقة",
    "ما أكثر تصرف يجعلك تشعر بالإثارة معه أو معها",
    "هل سبق أن شعرت بالغيرة الشديدة",
    "ما أكثر شيء يجعلك تحب شريكك أكثر",
    "ما أكثر مفاجأة أحببتها منه أو لها",
    "ما أكثر موقف جريء فعلته معه أو معها",
    "هل سبق أن أرسلت رسالة رومانسية غير متوقعة",
    "ما أكثر موقف جعلك تضحك معه أو معها",
    "ما أكثر أمنية رومانسية تتمنى تحقيقها",
    "هل تحب المفاجآت أم تفضل التخطيط المسبق",
    "ما أكثر كلمة رومانسية قلتها لشريكك",
    "ما أكثر شيء تحب فعله معه في عطلة نهاية الأسبوع",
    "هل سبق أن شعرت بالخوف على العلاقة",
    "ما أكثر موقف شعرت فيه بالسعادة المطلقة معه",
    "هل سبق أن شعرت بالإحراج أمامه أو أمامها",
    "ما أكثر صفة تحبها فيه أو فيها",
    "ما أكثر لحظة رومانسية تتمنى تكرارها",
    "هل سبق أن شعرت بالرغبة في الهروب معه أو معها",
    "ما أكثر موقف جريء حصل لك معه أو معها",
    "ما أكثر شيء يذكرك بشريكك عند الابتعاد",
    "هل سبق أن أخبرت شخصا سرا رومانسيا عن العلاقة",
    "ما أكثر شيء يجعلك تشعر بالحب الحقيقي",
    "ما أكثر موقف جعلك تشعر بالغيرة الشديدة",
    "هل سبق أن كتبت رسالة حب طويلة لشريكك",
    "ما أكثر تصرف حنون قام به معك",
    "ما أكثر موقف جعلك تشعر بالفخر معه أو معها",
    "من الأكثر اهتماما بالتفاصيل في العلاقة",
    "من الأكثر مرحا في العلاقة",
    "من الأكثر غيرة",
    "من الأكثر حب للتخطيط لمفاجآت",
    "من الأكثر رومانسية في تصرفاته اليومية",
    "من الأكثر صراحة في مشاعره",
    "من الأكثر جرأة في التعبير عن الحب",
    "من الأكثر حنانا",
    "من الأكثر مثابرة للحفاظ على العلاقة",
    "من الأكثر تقديرا لشريك حياته",
    "من الأكثر اهتماما بالشريك عند الحزن",
    "من الأكثر قدرة على المفاجآت",
    "من الأكثر قدرة على إسعاد الآخر",
    "من الأكثر تفهما",
    "من الأكثر اندفاعا بالعاطفة",
    "من الأكثر هدوءا أثناء الخلاف",
    "من الأكثر صبراً",
    "من الأكثر دعابة",
    "من الأكثر اهتماما بالمناسبات الخاصة",
    "من الأكثر انفتاحا في الحديث عن مشاعره",
    "من الأكثر قدرة على الاستماع",
    "من الأكثر اهتماما بالتفاصيل الصغيرة",
    "من الأكثر حب للمرح",
    "من الأكثر تقديرا للهدوء",
    "من الأكثر اهتماما بالجانب الجسدي في العلاقة",
    "من الأكثر اهتماما بالجانب النفسي",
    "من الأكثر قدرة على التسامح",
    "من الأكثر قدرة على التعبير بالكلمات",
    "من الأكثر قدرة على التعبير بالأفعال",
    "من الأكثر قدرة على لفت الانتباه",
    "من الأكثر اهتماما بالحب والرومانسية",
    "من الأكثر قدرة على الاهتمام بالآخرين",
    "من الأكثر اهتماما بمستقبل العلاقة",
    "من الأكثر إبداعا في إظهار الحب",
    "من الأكثر اهتماما بالشريك عند التعب",
    "من الأكثر مشاركة بالمشاعر",
    "من الأكثر حساسية",
    "من الأكثر اهتماما بالاحتفال بالحب",
    "من الأكثر قدرة على إدخال السعادة للشريك",
    "من الأكثر اهتماما بالتفاصيل الرومانسية",
    "من الأكثر حرصا على العلاقة",
    "من الأكثر اهتماما بالمناسبات الصغيرة",
    "من الأكثر اهتماما بإظهار الحب يوميا",
    "من الأكثر قدرة على التعبير عن الحنين",
    "من الأكثر اهتماما بالمسائل العاطفية",
    "من الأكثر قدرة على التعبير عن المشاعر بصراحة",
    "من الأكثر اهتماما بالشريك في الأوقات الصعبة",
    "من الأكثر قدرة على التعبير عن الامتنان",
    "من الأكثر اهتماما بالمفاجآت البسيطة",
    "من الأكثر اهتماما بالحب المتبادل",
    "من الأكثر اهتماما بالسعادة المشتركة",
    "من الأكثر قدرة على التعبير عن الحب بكلمات بسيطة",
    "من الأكثر اهتماما بالجانب العاطفي",
    "من الأكثر قدرة على فهم المشاعر",
    "من الأكثر قدرة على التعبير عن الامتنان",
    "من الأكثر اهتماما بالجانب الرومانسي",
    "من الأكثر قدرة على التعبير عن المودة",
    "من الأكثر اهتماما بالحب اليومي",
    "من الأكثر قدرة على التعبير عن الاهتمام",
    "من الأكثر اهتماما بالعاطفة المشتركة",
    "من الأكثر قدرة على التعبير عن الحب بالتصرفات",
    "من الأكثر اهتماما بالجانب الجسدي",
    "من الأكثر قدرة على التعبير عن الحب بالاهتمام",
    "من الأكثر اهتماما بالشريك وقت الضيق",
    "من الأكثر قدرة على التعبير عن مشاعر الحب",
    "من الأكثر اهتماما بالعلاقة اليومية",
    "من الأكثر قدرة على التعبير عن الحنان",
    "من الأكثر اهتماما بالسعادة العاطفية",
    "من الأكثر قدرة على التعبير عن المشاعر بصدق",
    "من الأكثر اهتماما بالتفاصيل اليومية",
    "من الأكثر قدرة على التعبير عن الحب بالابتسامة",
    "من الأكثر اهتماما بالحب والرومانسية اليومية",
    "من الأكثر قدرة على التعبير عن الحب بالمفاجآت",
    "من الأكثر اهتماما بالحب في التفاصيل الصغيرة",
    "من الأكثر قدرة على التعبير عن الحب بالصراحة",
    "من الأكثر اهتماما بالشريك في الأوقات العاطفية",
    "من الأكثر قدرة على التعبير عن الحب بالكلمات",
    "من الأكثر اهتماما بالمودة اليومية",
    "من الأكثر قدرة على التعبير عن الحب باللمسات البسيطة",
    "من الأكثر اهتماما بالحب الحقيقي",
    "من الأكثر قدرة على التعبير عن الحب بالصبر",
    "من الأكثر اهتماما بالجانب العاطفي اليومي",
    "من الأكثر قدرة على التعبير عن الحب بالاهتمام المستمر",
    "من الأكثر اهتماما بالمشاعر المشتركة",
    "من الأكثر قدرة على التعبير عن الحب بالصراحة اليومية",
    "من الأكثر اهتماما بالمفاجآت اليومية",
    "من الأكثر قدرة على التعبير عن الحب بالتصرفات اليومية",
    "من الأكثر اهتماما بالعاطفة اليومية",
    "من الأكثر قدرة على التعبير عن الحب بالكلمات اليومية",
    "من الأكثر اهتماما بالمودة اليومية",
    "من الأكثر قدرة على التعبير عن الحب بالتصرفات الرومانسية",
    "من الأكثر اهتماما بالحب اليومي",
    "من الأكثر قدرة على التعبير عن الحب بالمشاركة اليومية",
    "من الأكثر اهتماما بالتقدير اليومي",
    "من الأكثر قدرة على التعبير عن الحب بالحب المتبادل",
    "من الأكثر اهتماما بالعاطفة المشتركة اليومية",
    "من الأكثر قدرة على التعبير عن الحب بالرومانسية اليومية",
    "من الأكثر اهتماما بالحب والتقدير اليومي",
    "من الأكثر قدرة على التعبير عن الحب بالاهتمام اليومي",
    "من الأكثر اهتماما بالعاطفة اليومية المستمرة",
    "من الأكثر قدرة على التعبير عن الحب بالمودة اليومية",
    "من الأكثر اهتماما بالحب المتبادل المستمر",
    "من الأكثر قدرة على التعبير عن الحب بالتصرفات اليومية البسيطة",
    "من الأكثر اهتماما بالجانب الرومانسي اليومي",
    "من الأكثر قدرة على التعبير عن الحب بالاهتمام المستمر",
    "من الأكثر اهتماما بالعاطفة اليومية المشتركة",
    "من الأكثر قدرة على التعبير عن الحب بالمشاركة اليومية المستمرة",
    "من الأكثر اهتماما بالتقدير المستمر للشريك",
    "من الأكثر قدرة على التعبير عن الحب بالمودة اليومية المستمرة",
    "من الأكثر اهتماما بالحب المتبادل المستمر اليومي",
    "من الأكثر قدرة على التعبير عن الحب بالتصرفات اليومية الرومانسية",
    "من الأكثر اهتماما بالجانب الرومانسي المستمر",
    "من الأكثر قدرة على التعبير عن الحب بالاهتمام اليومي المستمر",
    "من الأكثر اهتماما بالعاطفة اليومية المستمرة المشتركة",
    "من الأكثر قدرة على التعبير عن الحب بالمشاركة اليومية الرومانسية",
    "من الأكثر اهتماما بالتقدير اليومي المستمر للشريك",
    "من الأكثر قدرة على التعبير عن الحب بالمودة اليومية المستمرة الرومانسية",
    "من الأكثر اهتماما بالحب المتبادل اليومي المستمر",
    "من الأكثر قدرة على التعبير عن الحب بالتصرفات اليومية البسيطة والرومانسية",
    "من الأكثر اهتماما بالجانب الرومانسي اليومي المستمر",
    "من الأكثر قدرة على التعبير عن الحب بالاهتمام اليومي والرومانسية المستمرة",
    "من الأكثر اهتماما بالعاطفة اليومية المستمرة والمشتركة",
    "من الأكثر قدرة على التعبير عن الحب بالمشاركة اليومية الرومانسية المستمرة",
    "من الأكثر اهتماما بالتقدير اليومي والمستمر للشريك",
    "من الأكثر قدرة على التعبير عن الحب بالمودة اليومية المستمرة والرومانسية",
    "من الأكثر اهتماما بالحب المتبادل المستمر اليومي",
    "من الأكثر قدرة على التعبير عن الحب بالتصرفات اليومية البسيطة والرومانسية المستمرة",
    "من الأكثر اهتماما بالجانب الرومانسي اليومي والمستمر",
    "من الأكثر قدرة على التعبير عن الحب بالاهتمام اليومي والرومانسية المستمرة والمتبادلة",
]

@app.route("/callback", methods=['POST'])
def callback():
    signature = request.headers.get('X-Line-Signature', '')
    body = request.get_data(as_text=True)
    try:
        handler.handle(body, signature)
    except InvalidSignatureError:
        abort(400)
    return 'OK'

@handler.add(MessageEvent, message=TextMessage)
def handle_message(event):
    global asked_questions
    text = event.message.text.strip().lower()
    if "سؤال" in text:
        available = [q for q in questions if q not in asked_questions]
        if not available:
            asked_questions = []
            available = questions.copy()
        q = random.choice(available)
        asked_questions.append(q)
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text=q))
        return
    return

if __name__ == "__main__":
    port = int(os.environ.get('PORT', 5000))
    app.run(host='0.0.0.0', port=port)
