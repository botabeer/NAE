import json
import os
import typing
from flask import Flask, request, abort
from linebot import LineBotApi, WebhookHandler
from linebot.exceptions import InvalidSignatureError
from linebot.models import (
    MessageEvent, TextMessage, TextSendMessage, 
    QuickReply, QuickReplyButton, MessageAction
)

app = Flask(__name__)

# === إعداد متغيرات البيئة ===
LINE_CHANNEL_ACCESS_TOKEN = os.getenv("LINE_CHANNEL_ACCESS_TOKEN")
LINE_CHANNEL_SECRET = os.getenv("LINE_CHANNEL_SECRET")

if not LINE_CHANNEL_ACCESS_TOKEN or not LINE_CHANNEL_SECRET:
    raise RuntimeError("يجب تعيين LINE_CHANNEL_ACCESS_TOKEN و LINE_CHANNEL_SECRET")

line_bot_api = LineBotApi(LINE_CHANNEL_ACCESS_TOKEN)
handler = WebhookHandler(LINE_CHANNEL_SECRET)

# === تخزين أسماء المستخدمين ===
user_names = {}  # {user_id: "الاسم"}

# === دالة للحصول على اسم المستخدم ===
def get_user_name(user_id: str) -> str:
    """الحصول على اسم المستخدم من LINE"""
    if user_id in user_names:
        return user_names[user_id]
    
    try:
        profile = line_bot_api.get_profile(user_id)
        user_names[user_id] = profile.display_name
        return profile.display_name
    except Exception:
        return "صديقي"

# === دالة محسّنة لتحميل الملفات ===
def load_file_lines(filename: str) -> typing.List[str]:
    """تحميل محتوى ملف نصي وإرجاع قائمة بالأسطر النظيفة"""
    if not os.path.exists(filename):
        print(f"⚠️ الملف غير موجود: {filename}")
        return []
    
    try:
        with open(filename, "r", encoding="utf-8") as f:
            lines = [line.strip() for line in f if line.strip()]
            print(f"✅ تم تحميل {len(lines)} سطر من {filename}")
            return lines
    except Exception as e:
        print(f"❌ خطأ في تحميل {filename}: {e}")
        return []

# === تحميل الملفات النصية ===
content_files = {
    "سؤال": load_file_lines("questions.txt"),
    "تحدي": load_file_lines("challenges.txt"),
    "اعتراف": load_file_lines("confessions.txt"),
    "شخصي": load_file_lines("personality.txt"),
}

# === تحميل أسئلة "أكثر" من ملف خارجي ===
more_questions = load_file_lines("more_file.txt")

# === تحميل الألعاب ===
def load_games():
    """تحميل بيانات الألعاب من ملف JSON"""
    try:
        with open("personality_games.json", "r", encoding="utf-8") as f:
            data = json.load(f)
            print(f"✅ تم تحميل {len(data)} لعبة")
            return [data[key] for key in sorted(data.keys())]
    except FileNotFoundError:
        print("⚠️ ملف personality_games.json غير موجود")
        return []
    except json.JSONDecodeError as e:
        print(f"❌ خطأ في تنسيق JSON: {e}")
        return []

games_list = load_games()

# === حالات المستخدمين ===
user_game_state = {}  # {user_id: {"game_index": int, "question_index": int, "answers": []}}
user_content_indices = {key: {} for key in content_files.keys()}
global_content_indices = {key: 0 for key in content_files.keys()}
more_questions_index = 0

# === نصوص التحليل المفصلة لجميع الألعاب ===
detailed_results = {
    "لعبة1": {
        "أ": """💛 قلبك من ذهب وتضحي من دون تردد

🌟 **تحليل شخصيتك:**
أنت شخص مساند بطبيعتك، وتشعر الآخرين بالأمان والراحة في وجودك.
تمتلك القدرة على تقديم الدعم النفسي والمادي، وتضع راحة الآخرين قبل راحتك الشخصية.
قلبك الطيب يجعلك محبوباً من الجميع، وتجد سعادتك في إسعاد من حولك.

💪 **نقاط قوتك:**
• التعاطف والحنان الفطري
• القدرة على التضحية بلا حدود
• كسب ثقة الناس بسهولة
• الإخلاص في العلاقات

⚠️ **انتبه لهذا:**
قد تتعب أحيانًا بسبب التزامك الكبير تجاه الآخرين، وقد يستغل البعض طيبتك.

💡 **نصيحة خاصة لك:**
تعلم كيف تحمي قلبك وطاقتك لمن يستحق فعلاً، وابتعد عن من يستنزف طاقتك.""",
        
        "ب": """💙 قلبك نقي لكنه حذر

🌟 **تحليل شخصيتك:**
أنت تعطي بحدود وتحب بعقل، تعرف متى تقترب ومتى تبتعد.
مشاعرك ناضجة وتتعامل مع الحياة بوعي وحكمة، وتوازن بين الحب والاحتياط.

💪 **نقاط قوتك:**
• النضج العاطفي والوعي الذاتي
• القدرة على اتخاذ قرارات حكيمة
• التوازن بين العقل والقلب

💡 **نصيحة خاصة لك:**
لا تدع تجاربك السابقة تمنعك من الانفتاح على الحب مجدداً.""",
        
        "ج": """💚 قلبك مرهف كالزجاج لكنه قوي كالجبال

🌟 **تحليل شخصيتك:**
تشعر بكل شيء بعمق، وتؤثر بك الأحداث والمواقف سريعاً.
تتأثر بسهولة ولكن تتعافى بصمت، وتستفيد من تجاربك السابقة لتقوية شخصيتك.

💪 **نقاط قوتك:**
• الحساسية العالية والتعاطف العميق
• القدرة على التعافي والنمو من الألم
• الفهم العميق للمشاعر الإنسانية

💡 **نصيحة خاصة لك:**
قلبك الحساس هو قوتك الحقيقية، احتفظ به ولكن احمه جيداً."""
    },
    
    "لعبة2": {
        "أ": """💪 أنت شخص قوي التحمل - المحارب الصامت

🌟 **تحليل شخصيتك:**
تواجه الصعوبات بثقة وصبر، ولا تستسلم بسهولة مهما كانت التحديات.
تعتمد على نفسك لحل المشكلات، وتتعلم من كل تجربة لتعزيز قدراتك.

💪 **نقاط قوتك:**
• عزيمة فولاذية لا تنكسر
• الاستقلالية في حل المشكلات
• الصبر والتحمل العالي

💡 **نصيحة خاصة لك:**
قوتك ملهمة، لكن لا تخف من طلب المساعدة أحياناً.""",
        
        "ب": """🤝 القوة الاجتماعية هي سلاحك - قائد الفريق

🌟 **تحليل شخصيتك:**
تعتمد على دعم الآخرين، وتستفيد من العلاقات القوية في حياتك.
تعرف متى تستشير ومتى تتحرك بمفردك، وتؤمن بقوة العمل الجماعي.

💪 **نقاط قوتك:**
• مهارات التواصل الاستثنائية
• القدرة على بناء تحالفات قوية
• كسب ثقة الآخرين بسهولة

💡 **نصيحة خاصة لك:**
علاقاتك ثروتك الحقيقية، حافظ عليها واستثمر فيها.""",
        
        "ج": """🧘 القوة الداخلية والوعي الذاتي - الحكيم الهادئ

🌟 **تحليل شخصيتك:**
تمتلك وعياً عميقاً بنفسك وقدراتك، وتتعامل مع الحياة بتوازن نادر.
تدرك نقاط قوتك وضعفك، وتسعى لتطوير نفسك باستمرار بذكاء ووعي.

💪 **نقاط قوتك:**
• الوعي الذاتي العميق
• التوازن النفسي والعقلي
• الحكمة في اتخاذ القرارات

💡 **نصيحة خاصة لك:**
قوتك الداخلية مذهلة، شاركها مع العالم بثقة."""
    },
    
    "لعبة3": {
        "أ": """🔐 حب الأمان والثقة - الحبيب الوفي

🌟 **تحليل شخصيتك:**
أنت شخص يبحث عن الثبات والاعتماد على الشريك، وتولي أهمية كبيرة للثقة والصدق.
تقدر الاستقرار العاطفي وتبحث عن علاقة قائمة على الاحترام المتبادل.

💕 **في الحب أنت:**
• مخلص وصادق حتى النخاع
• تبني علاقات عميقة وطويلة الأمد
• تحمي من تحب بكل قوتك

💡 **نصيحة خاصة لك:**
الثقة تُبنى بالوقت، وأنت تستحق من يقدّر وفاءك.""",
        
        "ب": """🎉 حب المرح والضحك - الروح المرحة

🌟 **تحليل شخصيتك:**
تستمتع بالأوقات الممتعة والضحك مع الشريك، وتحب مشاركة السعادة والبهجة.
تبحث عن علاقة مليئة بالحيوية والطاقة الإيجابية.

💕 **في الحب أنت:**
• تنشر السعادة والطاقة الإيجابية
• تخلق ذكريات جميلة لا تُنسى
• تجعل الحياة أخف وأجمل

💡 **نصيحة خاصة لك:**
الحب الحقيقي يحتاج للضحك والجدية معاً.""",
        
        "ج": """🤝 حب التفاهم والدعم - الشريك المثالي

🌟 **تحليل شخصيتك:**
أنت شخص يسعى للتفاهم العميق والدعم المتبادل مع شريك حياتك.
تقدر الحوار الصادق وتشعر بالمسؤولية الكبيرة تجاه مشاعر الآخرين.

💕 **في الحب أنت:**
• مستمع ممتاز ومتفهم عميق
• تقدم الدعم العاطفي دائماً
• تبني علاقات صحية ومتوازنة

💡 **نصيحة خاصة لك:**
أنت تستحق شريكاً يبادلك نفس العطاء."""
    },
    
    "لعبة4": {
        "أ": """🌙 سلام الانعزال الذاتي - الراهب الداخلي

🌟 **تحليل شخصيتك:**
تميل للهدوء والتأمل الذاتي، وتجد الراحة الحقيقية في وقتك الخاص.
تتعامل مع الضغوط بالتفكير العميق والتأمل الداخلي.

🕊️ **طريقتك في السلام:**
• الهدوء والتأمل الذاتي
• التفكير العميق في معاني الحياة
• الاستماع لصوتك الداخلي

💡 **نصيحة خاصة لك:**
وقتك الخاص مقدس، لكن شارك أحياناً لحظات سلامك مع من يستحق.""",
        
        "ب": """⚡ سلام النشاط والحركة - المحارب النشيط

🌟 **تحليل شخصيتك:**
تحب الانخراط في النشاطات والحركة المستمرة للتخلص من التوتر.
تعتمد على النشاط البدني أو الهوايات لتصفية ذهنك.

🕊️ **طريقتك في السلام:**
• الرياضة والنشاط البدني
• الخروج والتواصل مع الطبيعة
• تفريغ الطاقة السلبية بالحركة

💡 **نصيحة خاصة لك:**
نشاطك مصدر قوة، لكن لا تنسَ أن الراحة أيضاً ضرورية.""",
        
        "ج": """☮️ سلام الرضا الداخلي - الحكيم المتصالح

🌟 **تحليل شخصيتك:**
تركز على قبول ما لا يمكنك تغييره وتحقيق التوازن النفسي العميق.
تمتلك قدرة نادرة على التعامل مع الصعوبات بصبر ووعي وحكمة.

🕊️ **طريقتك في السلام:**
• القبول والرضا بالواقع
• التعلم من كل تجربة
• الحكمة في التعامل مع المشاكل

💡 **نصيحة خاصة لك:**
سلامك الداخلي كنز نادر، حافظ عليه وعلمه للآخرين."""
    },
    
    "لعبة5": {
        "أ": """🚀 طموح شخصي مستقل - الفارس المنفرد

🌟 **تحليل شخصيتك:**
تسعى لتحقيق أهدافك بنفسك، وتعتمد على قوتك الذاتية وإصرارك الداخلي.
تواجه التحديات دون الاعتماد الكامل على الآخرين.

🎯 **أسلوبك في النجاح:**
• الاعتماد على الذات والاستقلالية
• العمل الجاد دون انتظار المساعدة
• الثقة العالية بالقدرات الشخصية

💡 **نصيحة خاصة لك:**
استقلاليتك ملهمة، لكن لا تخف من قبول يد العون أحياناً.""",
        
        "ب": """🤝 طموح اجتماعي - بطل الفريق

🌟 **تحليل شخصيتك:**
تسعى لتحقيق أهدافك بمشاركة الآخرين والدعم المتبادل.
تؤمن بقوة الفريق والتعاون، وتقدر الأفكار المختلفة.

🎯 **أسلوبك في النجاح:**
• بناء فرق عمل قوية ومتماسكة
• الاستفادة من مهارات الآخرين
• تحقيق نجاحات جماعية كبيرة

💡 **نصيحة خاصة لك:**
قدرتك على بناء الفرق موهبة نادرة، استثمرها جيداً.""",
        
        "ج": """🎓 طموح مدروس وواعٍ - الاستراتيجي الحكيم

🌟 **تحليل شخصيتك:**
تخطط لكل خطوة بحكمة ووعي عميق، وتوازن بين الطموح والواقعية.
تعتمد على تقييم الفرص والمخاطر بدقة.

🎯 **أسلوبك في النجاح:**
• التخطيط الاستراتيجي المحكم
• الموازنة بين الحلم والواقع
• البناء المتدرج والمستدام

💡 **نصيحة خاصة لك:**
حكمتك في التخطيط قوة عظيمة، لكن لا تدع الحذر يشل حركتك."""
    },
    
    "لعبة6": {
        "أ": """🔧 تفكير عملي وحل المشكلات - المهندس العملي

🌟 **تحليل شخصيتك:**
تعتمد على المنطق والتحليل العقلاني، وتسعى لحل كل مشكلة بطريقة عملية.
تستفيد من خبراتك وتجاربك السابقة لتجنب الأخطاء.

🧠 **أسلوبك في التفكير:**
• المنطق والتحليل الموضوعي
• حل المشكلات بطريقة منهجية
• التعلم من الأخطاء السابقة

💡 **نصيحة خاصة لك:**
عقلك التحليلي سلاح قوي، لكن لا تتجاهل صوت قلبك تماماً.""",
        
        "ب": """🌐 تفكير اجتماعي ومشارك - الموجه الحكيم

🌟 **تحليل شخصيتك:**
تؤمن بقوة المشاركة ومساعدة الآخرين، وتستشير عند الحاجة.
تسعى لتبادل الخبرات والمعرفة، وتقدر العلاقات الإنسانية.

🧠 **أسلوبك في التفكير:**
• المشاركة وتبادل الأفكار
• الاستفادة من حكمة الجماعة
• التفكير في مصلحة الجميع

💡 **نصيحة خاصة لك:**
قدرتك على جمع الحكمة من الآخرين ذكاء عظيم، استمر فيه.""",
        
        "ج": """🧘 تفكير هادئ ومتوازن - الفيلسوف الحكيم

🌟 **تحليل شخصيتك:**
تميل للتفكير العميق والمتأني، وتتخذ القرارات بروية وحكمة.
توازن بين المشاعر والمنطق بشكل مثالي.

🧠 **أسلوبك في التفكير:**
• التأمل العميق قبل القرار
• الموازنة بين العقل والعاطفة
• الهدوء في مواجهة الضغوط

💡 **نصيحة خاصة لك:**
توازنك الفكري نعمة كبيرة، لكن كن مرناً عند الحاجة."""
    },
    
    "لعبة7": {
        "أ": """🛡️ صديق مخلص ومسؤول - الحارس الأمين

🌟 **تحليل شخصيتك:**
أنت دائماً حاضر لمساعدة أصدقائك، وتتحمل المسؤولية عن علاقاتك.
تعتمد على الصدق والوفاء، وتحب تقديم الدعم دون انتظار مقابل.

👥 **كصديق أنت:**
• مخلص حتى النهاية
• حاضر في السراء والضراء
• صادق ومباشر دائماً

💡 **نصيحة خاصة لك:**
إخلاصك نادر وثمين، لكن اختر أصدقاءك بعناية.""",
        
        "ب": """🎭 صديق مرح وممتع - روح الجلسة

🌟 **تحليل شخصيتك:**
تتمتع بروح مرحة فريدة، وتحب نشر السعادة والضحك بين أصدقائك.
تعطي طاقة إيجابية مذهلة وتساعد على التخفيف من التوتر.

👥 **كصديق أنت:**
• تنشر البهجة أينما حللت
• تخلق ذكريات لا تُنسى
• تجعل الحياة أخف وأجمل

💡 **نصيحة خاصة لك:**
روحك المرحة هدية للعالم، لكن كن جاداً عندما يحتاجك أصدقاؤك.""",
        
        "ج": """🤝 صديق هادئ ومتفاهم - المستشار الحكيم

🌟 **تحليل شخصيتك:**
تمتلك قدرة استثنائية على الاستماع والتفهم، وتتعامل مع الأصدقاء بصبر.
تفضل حل المشكلات بالحوار الهادئ.

👥 **كصديق أنت:**
• مستمع ممتاز ومتفهم عميق
• حكيم في النصائح والتوجيه
• موثوق به في الأسرار

💡 **نصيحة خاصة لك:**
قدرتك على الفهم والصبر نادرة، استمر في العطاء."""
    },
    
    "لعبة8": {
        "أ": """⚡ قرار سريع وواثق - القائد الحاسم

🌟 **تحليل شخصيتك:**
تثق بحدسك وتتخذ القرارات بسرعة وثقة عند الحاجة.
تعتمد على خبراتك ومعلوماتك دون تردد.

⚖️ **أسلوبك في القرارات:**
• الحسم والسرعة عند الحاجة
• الثقة بالحدس والخبرة
• القدرة على التصرف تحت الضغط

💡 **نصيحة خاصة لك:**
ثقتك وحسمك قوة عظيمة، لكن تعلم متى تتوقف وتفكر.""",
        
        "ب": """🤲 قرار تعاوني ومشترك - الديمقراطي الحكيم

🌟 **تحليل شخصيتك:**
تستشير الآخرين قبل اتخاذ القرارات، وتقدر وجهات النظر المختلفة.
تعمل على تحقيق توازن بين رأيك وآراء من حولك.

⚖️ **أسلوبك في القرارات:**
• الاستشارة وجمع الآراء
• تقدير وجهات النظر المختلفة
• العدالة والتوازن في الاختيار

💡 **نصيحة خاصة لك:**
حكمتك في الاستشارة علامة ذكاء، لكن لا تفقد صوتك الخاص.""",
        
        "ج": """🎯 قرار مدروس وواعٍ - الاستراتيجي المحنك

🌟 **تحليل شخصيتك:**
تقوم بتحليل جميع الخيارات بعناية قبل اتخاذ أي قرار.
توازن بين المخاطر والفوائد بدقة.

⚖️ **أسلوبك في القرارات:**
• التحليل الدقيق لكل الخيارات
• تقييم المخاطر والفوائد
• الحذر والدقة في الاختيار

💡 **نصيحة خاصة لك:**
دقتك في التفكير ميزة رائعة، لكن لا تدع التردد يسيطر عليك."""
    },
    
    "لعبة9": {
        "أ": """🏆 حلم شخصي مستقل - الطموح الذاتي

🌟 **تحليل شخصيتك:**
تركز على تحقيق أهدافك الشخصية بنفسك، وتسعى لتطوير مهاراتك.
تتمتع بالإصرار والمثابرة الشديدة.

💭 **أحلامك وطموحاتك:**
• النجاح الشخصي والتطور الذاتي
• بناء إنجازات بجهدك الخاص
• إثبات قدراتك للعالم

💡 **نصيحة خاصة لك:**
طموحك الشخصي رائع، لكن شارك نجاحك مع أحبائك.""",
        
        "ب": """🌍 حلم اجتماعي - صانع التغيير

🌟 **تحليل شخصيتك:**
تهتم بإسعاد الآخرين وتحقيق فرق إيجابي في حياتهم.
تقدر التعاون والمشاركة الاجتماعية.

💭 **أحلامك وطموحاتك:**
• إسعاد الآخرين وخدمة المجتمع
• بناء علاقات قوية ومؤثرة
• ترك أثر إيجابي في العالم

💡 **نصيحة خاصة لك:**
روحك الإنسانية كنز نادر، استمر في العطاء.""",
        
        "ج": """⚖️ حلم متوازن وواعٍ - الحالم الواقعي

🌟 **تحليل شخصيتك:**
توازن بين طموحك الشخصي وبين مساعدة الآخرين بحكمة.
تسعى لتحقيق رضا داخلي واستقرار عاطفي.

💭 **أحلامك وطموحاتك:**
• تحقيق التوازن بين الذات والآخرين
• السعادة الشخصية والاجتماعية
• حياة متكاملة ومتوازنة

💡 **نصيحة خاصة لك:**
توازنك في الحياة حكمة عظيمة، حافظ عليها."""
    },
    
    "لعبة10": {
        "أ": """🌙 سلام الانعزال الذاتي - الناسك الحكيم

🌟 **تحليل شخصيتك:**
تحب أن تكون مع نفسك لتجديد الطاقة والتركيز.
تتعامل مع التوتر بضبط النفس والتأمل الداخلي.

🕊️ **راحتك النفسية في:**
• الهدوء والعزلة الإيجابية
• التأمل وإعادة ترتيب الأفكار
• التحليل الذاتي العميق

💡 **نصيحة خاصة لك:**
عزلتك الإيجابية قوة، لكن شارك سلامك مع من تحب أحياناً.""",
        
        "ب": """⚡ سلام النشاط والحركة - الروح الحرة

🌟 **تحليل شخصيتك:**
تعتمد على النشاط البدني والهوايات للتخلص من التوتر.
تجد في الحركة المستمرة وسيلة لتوازن حياتك.

🕊️ **راحتك النفسية في:**
• الرياضة والنشاط البدني
• الخروج والتواصل مع الطبيعة
• الحركة وتفريغ الطاقة

💡 **نصيحة خاصة لك:**
طاقتك ونشاطك رائعان، لكن امنح نفسك فترات راحة.""",
        
        "ج": """☮️ سلام الرضا الداخلي - الحكيم المتصالح

🌟 **تحليل شخصيتك:**
تركز على القبول الداخلي والتوازن النفسي والرضا بقدر الله.
تعرف كيف تستفيد من تجاربك لتعيش بسلام وطمأنينة.

🕊️ **راحتك النفسية في:**
• القبول والرضا بالواقع
• الحكمة والتعلم من التجارب
• التصالح مع النفس والماضي

💡 **نصيحة خاصة لك:**
سلامك الداخلي كنز نادر، حافظ عليه وعلّم الآخرين."""
    }
}

# === خريطة الأوامر ===
commands_map = {
    "سؤال": ["سؤال", "سوال", "اسأله", "اسئلة", "اسأل"],
    "تحدي": ["تحدي", "تحديات", "تحد"],
    "اعتراف": ["اعتراف", "اعترافات"],
    "شخصي": ["شخصي", "شخصية", "شخصيات"],
    "أكثر": ["أكثر", "اكثر", "زيادة"]
}

# === دالة لإيجاد الأمر المطابق ===
def find_command(text: str) -> typing.Optional[str]:
    """البحث عن الأمر المطابق من النص المدخل"""
    text_lower = text.lower().strip()
    for key, variants in commands_map.items():
        if text_lower in [v.lower() for v in variants]:
            return key
    return None

# === دالة لإنشاء القائمة السريعة ===
def create_main_menu():
    """إنشاء القائمة الرئيسية للبوت"""
    return QuickReply(items=[
        QuickReplyButton(action=MessageAction(label="❓ سؤال", text="سؤال")),
        QuickReplyButton(action=MessageAction(label="🎯 تحدي", text="تحدي")),
        QuickReplyButton(action=MessageAction(label="💬 اعتراف", text="اعتراف")),
        QuickReplyButton(action=MessageAction(label="🧠 شخصي", text="شخصي")),
        QuickReplyButton(action=MessageAction(label="✨ أكثر", text="أكثر")),
        QuickReplyButton(action=MessageAction(label="🎮 لعبة", text="لعبه")),
    ])

# === دالة للحصول على محتوى عادي ===
def get_content(command: str, user_id: str) -> str:
    """الحصول على محتوى بناءً على الأمر"""
    file_list = content_files.get(command, [])
    
    if not file_list:
        return f"⚠️ لا توجد بيانات متاحة في قسم '{command}' حالياً.\nجرب قسماً آخر! 😊"
    
    # استخدام المؤشر العام
    index = global_content_indices[command]
    content = file_list[index]
    
    # تحديث المؤشرات
    global_content_indices[command] = (index + 1) % len(file_list)
    user_content_indices[command][user_id] = global_content_indices[command]
    
    return content

# === دالة للحصول على محتوى "أكثر" ===
def get_more_question(user_id: str) -> str:
    """الحصول على سؤال من نوع 'أكثر'"""
    global more_questions_index
    
    if not more_questions:
        return "⚠️ لا توجد أسئلة متاحة في قسم 'أكثر' حالياً."
    
    # الحصول على اسم المستخدم
    user_name = get_user_name(user_id)
    
    # الحصول على السؤال التالي
    question = more_questions[more_questions_index]
    more_questions_index = (more_questions_index + 1) % len(more_questions)
    
    # إضافة اسم المستخدم للسؤال بطريقة احترافية
    formatted_question = f"💭 {question}\n\n👤 {user_name}"
    
    return formatted_question

# === دالة لعرض قائمة الألعاب ===
def get_games_list() -> str:
    """إرجاع قائمة بأسماء الألعاب المتاحة"""
    if not games_list:
        return "⚠️ لا توجد ألعاب متاحة حالياً."
    
    titles = [
        "🎮 الألعاب المتاحة:",
        "",
        "1️⃣ أي نوع من القلوب تمتلك",
        "2️⃣ القوة الشخصية",
        "3️⃣ الحب والعلاقات",
        "4️⃣ السلام الداخلي",
        "5️⃣ الطموح والنجاح",
        "6️⃣ التفكير الإيجابي",
        "7️⃣ الصداقة والعلاقات الاجتماعية",
        "8️⃣ القرارات الحياتية",
        "9️⃣ الأحلام والطموحات",
        "🔟 الراحة النفسية",
        "",
        "📌 أرسل رقم اللعبة للبدء (1-10)"
    ]
    return "\n".join(titles)

# === دالة لحساب النتيجة ===
def calculate_result(answers: typing.List[str], game_index: int) -> str:
    """حساب نتيجة اللعبة بناءً على الإجابات"""
    # عد الإجابات
    count = {"أ": 0, "ب": 0, "ج": 0}
    for ans in answers:
        if ans in count:
            count[ans] += 1
    
    # تحديد الإجابة الأكثر تكرارًا
    most_common = max(count, key=count.get)
    
    # الحصول على النص المفصل
    game_key = f"لعبة{game_index + 1}"
    result_text = detailed_results.get(game_key, {}).get(
        most_common, 
        f"✅ إجابتك الأكثر: {most_common}\n\n🎯 نتيجتك تعكس شخصية فريدة!"
    )
    
    # إضافة إحصائيات
    stats = f"\n\n📊 إحصائياتك:\n"
    stats += f"أ: {count['أ']} | ب: {count['ب']} | ج: {count['ج']}"
    
    return result_text + stats

# === Routes ===
@app.route("/", methods=["GET"])
def home():
    """الصفحة الرئيسية للتحقق من عمل البوت"""
    return "✅ البوت يعمل بنجاح!", 200

@app.route("/callback", methods=["POST"])
def callback():
    """معالجة الرسائل الواردة من LINE"""
    signature = request.headers.get("X-Line-Signature", "")
    body = request.get_data(as_text=True)
    
    try:
        handler.handle(body, signature)
    except InvalidSignatureError:
        print("❌ توقيع غير صالح")
        abort(400)
    
    return "OK"

# === معالج الرسائل ===
@handler.add(MessageEvent, message=TextMessage)
def handle_message(event):
    """معالجة رسائل المستخدمين"""
    user_id = event.source.user_id
    text = event.message.text.strip()
    text_lower = text.lower()
    
    # === أمر المساعدة ===
    if text_lower in ["مساعدة", "help", "بداية", "start"]:
        welcome_msg = (
            "👋 أهلاً بك في البوت!\n\n"
            "📋 الأقسام المتاحة:\n"
            "❓ سؤال - أسئلة ممتعة\n"
            "🎯 تحدي - تحديات مثيرة\n"
            "💬 اعتراف - اعترافات صادقة\n"
            "🧠 شخصي - أسئلة شخصية\n"
            "✨ أكثر - أسئلة 'أكثر واحد'\n"
            "🎮 لعبة - ألعاب تحليل الشخصية\n\n"
            "🔽 اختر من القائمة أدناه:"
        )
        line_bot_api.reply_message(
            event.reply_token,
            TextSendMessage(text=welcome_msg, quick_reply=create_main_menu())
        )
        return
    
    # === معالجة الأوامر العادية ===
    command = find_command(text)
    if command:
        # معالجة خاصة لأمر "أكثر"
        if command == "أكثر":
            content = get_more_question(user_id)
        else:
            content = get_content(command, user_id)
            # إضافة اسم المستخدم للمحتوى
            user_name = get_user_name(user_id)
            content = f"👤 {user_name}\n\n{content}"
        
        line_bot_api.reply_message(
            event.reply_token,
            TextSendMessage(text=content, quick_reply=create_main_menu())
        )
        return
    
    # === بدء لعبة ===
    if text_lower in ["لعبه", "لعبة", "العاب", "ألعاب", "game"]:
        line_bot_api.reply_message(
            event.reply_token,
            TextSendMessage(text=get_games_list())
        )
        return
    
    # === اختيار رقم اللعبة ===
    if text.isdigit():
        num = int(text)
        if 1 <= num <= len(games_list):
            game_index = num - 1
            user_game_state[user_id] = {
                "game_index": game_index,
                "question_index": 0,
                "answers": []
            }
            
            # الحصول على اسم المستخدم
            user_name = get_user_name(user_id)
            
            first_q = games_list[game_index]["questions"][0]
            options = "\n".join([f"{k}. {v}" for k, v in first_q["options"].items()])
            msg = f"🎮 {games_list[game_index].get('title', f'اللعبة {num}')}\n"
            msg += f"👤 اللاعب: {user_name}\n\n"
            msg += f"❓ {first_q['question']}\n\n{options}\n\n📝 أرسل: أ، ب، أو ج"
            
            line_bot_api.reply_message(
                event.reply_token,
                TextSendMessage(text=msg)
            )
        else:
            line_bot_api.reply_message(
                event.reply_token,
                TextSendMessage(text=f"⚠️ اختر رقماً من 1 إلى {len(games_list)}")
            )
        return
    
    # === معالجة إجابات اللعبة ===
    if user_id in user_game_state:
        state = user_game_state[user_id]
        
        # تحويل الإجابة
        answer_map = {"1": "أ", "2": "ب", "3": "ج", "a": "أ", "b": "ب", "c": "ج"}
        answer = answer_map.get(text_lower, text)
        
        if answer in ["أ", "ب", "ج"]:
            state["answers"].append(answer)
            game = games_list[state["game_index"]]
            state["question_index"] += 1
            
            # التحقق من وجود أسئلة إضافية
            if state["question_index"] < len(game["questions"]):
                q = game["questions"][state["question_index"]]
                options = "\n".join([f"{k}. {v}" for k, v in q["options"].items()])
                progress = f"[{state['question_index'] + 1}/{len(game['questions'])}]"
                msg = f"{progress} ❓ {q['question']}\n\n{options}\n\n📝 أرسل: أ، ب، أو ج"
                
                line_bot_api.reply_message(
                    event.reply_token,
                    TextSendMessage(text=msg)
                )
            else:
                # حساب النتيجة النهائية
                user_name = get_user_name(user_id)
                result = calculate_result(state["answers"], state["game_index"])
                final_msg = f"🎉 انتهت اللعبة!\n"
                final_msg += f"👤 {user_name}\n\n"
                final_msg += f"{result}\n\n"
                final_msg += f"💬 أرسل 'لعبه' لتجربة لعبة أخرى!"
                
                line_bot_api.reply_message(
                    event.reply_token,
                    TextSendMessage(text=final_msg, quick_reply=create_main_menu())
                )
                
                # حذف حالة المستخدم
                del user_game_state[user_id]
        # إذا كانت الإجابة خاطئة في اللعبة، نتجاهلها
        return
    
    # === تجاهل أي رسائل أخرى ===
    # لا يرد البوت على أي شيء غير الأوامر المحددة
    return

# === تشغيل التطبيق ===
if __name__ == "__main__":
    port = int(os.getenv("PORT", 5000))
    print(f"🚀 البوت يعمل على المنفذ {port}")
    app.run(host="0.0.0.0", port=port, debug=False)
