from flask import Flask, request, abort
from linebot import LineBotApi, WebhookHandler
from linebot.exceptions import InvalidSignatureError
from linebot.models import MessageEvent, TextMessage, TextSendMessage
import os, random, typing, re

app = Flask(__name__)

# LINE credentials from environment
LINE_CHANNEL_ACCESS_TOKEN = os.getenv("LINE_CHANNEL_ACCESS_TOKEN")
LINE_CHANNEL_SECRET = os.getenv("LINE_CHANNEL_SECRET")
if not LINE_CHANNEL_ACCESS_TOKEN or not LINE_CHANNEL_SECRET:
    raise RuntimeError("Set LINE_CHANNEL_ACCESS_TOKEN and LINE_CHANNEL_SECRET environment variables")

line_bot_api = LineBotApi(LINE_CHANNEL_ACCESS_TOKEN)
handler = WebhookHandler(LINE_CHANNEL_SECRET)

# -----------------------------
# Load optional external lists
# -----------------------------
def load_file_lines(filename: str) -> typing.List[str]:
    try:
        with open(filename, "r", encoding="utf-8") as f:
            return [line.strip() for line in f if line.strip()]
    except Exception:
        return []

questions_file = load_file_lines("questions.txt")
challenges_file = load_file_lines("challenges.txt")
confessions_file = load_file_lines("confessions.txt")
personality_file = load_file_lines("personality.txt")

personality_index = 0

if not questions_file:
    questions_file = ["ما أكثر صفة تحبها في شريك حياتك؟", "ما أول شعور جاءك لما شفته لأول مرة؟"]
if not challenges_file:
    challenges_file = ["اكتب رسالة قصيرة تبدأ بـ: أحبك لأن...", "ارسل له صورة تمثل أجمل ذكرى عندك معه."]
if not confessions_file:
    confessions_file = ["اعترف بأول شخص جذبك في حياتك.", "اعترف بأكثر عادة سيئة عندك."]
if not personality_file:
    personality_file = ["تحب تبدأ يومك بالنشاط ولا بالهدوء؟", "هل تعتبر نفسك اجتماعي أم انطوائي؟"]

# -----------------------------
# Games: 10 games, 5 Qs each
# -----------------------------
games: typing.Dict[str, typing.List[str]] = {
    "لعبه1": [
        "سؤال 1:\nتمشي في مكان غامض وترى شخص يبتسم لك. ماذا تفعل؟\n1. تقترب وتعرفه\n2. تتجنب\n3. تراقبه بصمت\n4. تبتسم بالمقابل",
        "سؤال 2:\nوجدت رسالة غامضة على الطاولة. كيف تتصرف؟\n1. تقرأها فورًا\n2. تتجاهلها\n3. تحفظها لوقت لاحق\n4. تشاركها مع شخص تثق به",
        "سؤال 3:\nشخص يعرض عليك مساعدة سرية، تقبل؟\n1. نعم مباشرة\n2. لا أبدا\n3. أستفسر أولًا\n4. أراقب الوضع",
        "سؤال 4:\nوجدت كتابًا مغلقًا بلا عنوان، تفعل؟\n1. تفتحه فورًا\n2. تتركه\n3. تحمله معك\n4. تعرضه للآخرين",
        "سؤال 5:\nشخص يطلب رأيك في أمر حساس. ماذا تختار؟\n1. الصراحة التامة\n2. الدبلوماسية\n3. التجاهل\n4. المساعدة بطريقة خفية"
    ],
    "لعبه2": [
        "سؤال 1:\nتستيقظ في مكان غامض وتسمع صوت موسيقى. ماذا تفعل؟\n1. تتبع الصوت\n2. تهرب\n3. تنتظر\n4. تبحث عن مصدر آخر",
        "سؤال 2:\nشخص غريب يقدم لك هدية غير متوقعة. كيف تتصرف؟\n1. تقبل بسرور\n2. ترفض بأدب\n3. تسأل عن السبب\n4. تراقبه قبل الرد",
        "سؤال 3:\nرأيت شخصًا يبدو مهمًا يراقبك. تتصرف؟\n1. تقترب للتحدث\n2. تتجاهل\n3. تبتعد بهدوء\n4. تراقبه أولًا",
        "سؤال 4:\nتجد مفتاح غامض على الأرض، تفعل؟\n1. تلتقطه\n2. تتركه\n3. تبحث عن صاحبه\n4. تخفيه لنفسك",
        "سؤال 5:\nيُطلب منك اتخاذ قرار سريع. كيف تتصرف؟\n1. تصنع القرار مباشرة\n2. تنتظر\n3. تستشير أحدًا\n4. تدرس الخيارات بعناية"
    ],
    "لعبه3": [
        "سؤال 1:\nشخص يشاركك سرًا. كيف تتصرف؟\n1. تحافظ على السر\n2. تشارك أحدًا آخر\n3. تستفسر عن التفاصيل\n4. تتجاهل السر",
        "سؤال 2:\nتكتشف رسالة مكتوبة لك بدون توقيع. ماذا تفعل؟\n1. تحللها\n2. تتجاهلها\n3. تسأل عن مصدرها\n4. تشاركها مع صديق",
        "سؤال 3:\nوجدت دعوة لحفل غامض، تحضر؟\n1. نعم بحماس\n2. لا تفضل\n3. تنتظر معرفة التفاصيل\n4. تسأل من حضر من قبل",
        "سؤال 4:\nشخص يحتاج لمساعدتك في أمر صعب، تفعل؟\n1. تقدم المساعدة فورًا\n2. تدرس الطلب أولًا\n3. تتجنب\n4. تقدم نصائح فقط",
        "سؤال 5:\nترى مشهدًا غريبًا في الشارع، رد فعلك؟\n1. تقترب للتأكد\n2. تبتعد\n3. تراقب بهدوء\n4. تتصل بشخص آخر"
    ],
    "لعبه4": [
        "سؤال 1:\nرسالة غامضة تصل على هاتفك، تقرأها؟\n1. فورًا\n2. تنتظر\n3. تحذفها\n4. تسأل صديقًا",
        "سؤال 2:\nشخص يقدم نصيحة غير متوقعة، تفعل؟\n1. تنفذها مباشرة\n2. تتجاهل\n3. تدرسها\n4. تسأل آخرين",
        "سؤال 3:\nرأيت فرصة للمغامرة، ماذا تختار؟\n1. تنتهزها\n2. تتراجع\n3. تراقب الوضع\n4. تدرس المخاطر",
        "سؤال 4:\nتجد شيئًا مفقودًا، تفعل؟\n1. تبحث عنه\n2. تتركه\n3. تبلغ السلطات\n4. تستخدمه لنفسك",
        "سؤال 5:\nيُطلب منك اتخاذ خطوة غامضة، كيف؟\n1. مباشرة\n2. بتردد\n3. بمساعدة الآخرين\n4. بالتفكير أولًا"
    ],
    "لعبه5": [
        "سؤال 1:\nتجد صندوقًا مغلقًا مع مفتاح، تفعل؟\n1. تفتحه فورًا\n2. تتركه\n3. تبحث عن صاحبه\n4. تخبئه",
        "سؤال 2:\nشخص يعرض عليك رحلة مجهولة، تقبل؟\n1. نعم مباشرة\n2. لا تفضل\n3. تدرس الوضع\n4. تسأل من ذاقها",
        "سؤال 3:\nتسمع سرًا مهمًا، ماذا تفعل؟\n1. تحافظ عليه\n2. تشاركه\n3. تحلل المعلومات\n4. تتجاهله",
        "سؤال 4:\nشخص غريب يحتاج لمساعدة، كيف تتصرف؟\n1. تقدمها مباشرة\n2. تدرس الموقف\n3. تتجنب\n4. تقدم نصائح فقط",
        "سؤال 5:\nترى فرصة لاكتشاف شيء جديد، تفعل؟\n1. تستغلها\n2. تنتظر\n3. تراقب أولًا\n4. تتجاهل"
    ],
    "لعبه6": [
        "سؤال 1:\nرسالة غامضة تجدها في البريد، تقرأها؟\n1. فورًا\n2. تنتظر\n3. تحذفها\n4. تستشير صديقًا",
        "سؤال 2:\nشخص يقدم هدية غير متوقعة، كيف؟\n1. تقبل بسرور\n2. ترفض بأدب\n3. تسأل عن السبب\n4. تراقبه",
        "سؤال 3:\nتكتشف شخصًا يراقبك، ماذا تفعل؟\n1. تقترب\n2. تبتعد\n3. تراقب بصمت\n4. تسأل عن السبب",
        "سؤال 4:\nرأيت مكانًا غامضًا، تدخل؟\n1. نعم مباشرة\n2. لا تفضل\n3. تراقب أولًا\n4. تبحث عن صديق",
        "سؤال 5:\nشخص يحتاج لنصيحة، تعطيه؟\n1. مباشرة\n2. بتردد\n3. تدرس الموضوع\n4. تقدم نصيحة جزئية"
    ],
    "لعبه7": [
        "سؤال 1:\nتسمع قصة غريبة من شخص مجهول، ماذا تفعل؟\n1. تستمع بعناية\n2. تتجاهل\n3. تسأل للتوضيح\n4. تشارك مع آخرين",
        "سؤال 2:\nوجدت رسالة على المقعد، تقرأها؟\n1. فورًا\n2. تنتظر\n3. تحذفها\n4. تسأل صديقًا",
        "سؤال 3:\nشخص يطلب رأيك، كيف؟\n1. صراحة\n2. بلطف\n3. تجنب الموضوع\n4. بطريقة مبسطة",
        "سؤال 4:\nرأيت شخصًا يحتاج مساعدة، تفعل؟\n1. تساعده\n2. تراقبه\n3. تتجاهل\n4. تقدم نصيحة فقط",
        "سؤال 5:\nتجد فرصة جديدة، ماذا تفعل؟\n1. تنتهزها\n2. تدرسها\n3. تتجاهلها\n4. تستشير صديقًا"
    ],
    "لعبه8": [
        "سؤال 1:\nشخص يقدم لك نصيحة غريبة، تتبع؟\n1. نعم مباشرة\n2. لا\n3. تدرسها\n4. تسأل آخرين",
        "سؤال 2:\nتجد رسالة غير مفهومة، ماذا تفعل؟\n1. تحللها\n2. تتجاهل\n3. تسأل عن مصدرها\n4. تشاركها مع صديق",
        "سؤال 3:\nشخص يحتاج لمساعدتك، كيف؟\n1. تقدمها فورًا\n2. تتردد\n3. تدرس الموقف\n4. تقدم نصائح فقط",
        "سؤال 4:\nرأيت شيء غامض في الطريق، تفعل؟\n1. تقترب\n2. تبتعد\n3. تراقب أولًا\n4. تتجاهل",
        "سؤال 5:\nتصل إليك فرصة غير متوقعة، ماذا تفعل؟\n1. تنتهزها\n2. تدرسها\n3. تتجاهل\n4. تستشير صديقًا"
    ],
    "لعبه9": [
        "سؤال 1:\nشخص يعرض عليك مساعدة سرية، تقبل؟\n1. نعم مباشرة\n2. لا\n3. تدرس الأمر\n4. تراقب الوضع",
        "سؤال 2:\nرأيت رسالة غامضة، تفعل؟\n1. تقرأها\n2. تتجاهل\n3. تحلل\n4. تسأل شخصًا آخر",
        "سؤال 3:\nوجدت فرصة جديدة، ماذا تفعل؟\n1. تنتهزها\n2. تدرسها\n3. تتجاهل\n4. تستشير صديقًا",
        "سؤال 4:\nشخص يحتاج لمساعدتك، كيف؟\n1. تقدمها مباشرة\n2. تدرس الموقف\n3. تتجنب\n4. تقدم نصائح فقط",
        "سؤال 5:\nتسمع سرًا مهمًا، تفعل؟\n1. تحافظ عليه\n2. تشارك\n3. تحلل المعلومات\n4. تتجاهل"
    ],
    "لعبه10": [
        "سؤال 1:\nرأيت شخصًا غريبًا يناديك، ماذا تفعل؟\n1. تقترب\n2. تبتعد\n3. تراقب\n4. تتجاهل",
        "سؤال 2:\nشخص يعطيك رسالة غامضة، تقرأ؟\n1. فورًا\n2. تنتظر\n3. تحذفها\n4. تسأل صديقًا",
        "سؤال 3:\nوجدت مفتاحًا غامضًا، تفعل؟\n1. تلتقطه\n2. تتركه\n3. تبحث عن صاحبه\n4. تخبئه",
        "سؤال 4:\nتسمع قصة غير متوقعة، تستمع؟\n1. نعم\n2. لا\n3. تدرس القصة\n4. تشاركها",
        "سؤال 5:\nشخص يحتاج نصيحة عاجلة، تعطي؟\n1. مباشرة\n2. بتردد\n3. تدرس الوضع\n4. تقدم جزئيًا"
    ]
}

# -----------------------------
# Person characters: 10 جديدة + 4 قديمة
# -----------------------------
KEYWORDS = {
    "قيادية": [r"\bتدخل\b", r"\bتقترب\b", r"\bتسرع\b", r"\bتركض\b"],
    "تعبيرية": [r"\bأتحدث\b", r"\bأتواصل\b", r"\bأشارك\b", r"\bألوّح\b"],
    "تحليلية": [r"\bأبحث\b", r"\bأخطط\b", r"\bأدرس\b", r"\bأفحص\b"],
    "داعمة": [r"\bأساعد\b", r"\bأساند\b", r"\bأهتم\b", r"\bأقف مع\b"],
    "محلل_استراتيجي": [r"\bتحليل\b", r"\bأخطط\b", r"\bأدرس\b"],
    "مستكشف_مغامر": [r"\bأستكشف\b", r"\bأغامر\b", r"\bأبحث\b"],
    "مبتكر_مبدع": [r"\bأبتكر\b", r"\bأصنع\b", r"\bأخلق\b"],
    "مرشد_حكيم": [r"\bأرشد\b", r"\bأستمع\b", r"\bأوجه\b"],
    "حالم_عاطفي": [r"\bأشعر\b", r"\bأحس\b", r"\bأحلم\b"],
    "منفذ_عملي": [r"\bأنجز\b", r"\bأقوم\b", r"\bأفعل\b"],
    "دبلوماسي_اجتماعي": [r"\bأتواصل\b", r"\bأفاوض\b", r"\bأحل\b"],
    "شخص_مستقل": [r"\bأقرر\b", r"\bأعتمد\b", r"\bأختار\b"],
    "محفز_ملهم": [r"\bأشجع\b", r"\bأحفز\b", r"\bأبني\b"],
    "باحث_فلسفي": [r"\bأفكر\b", r"\bأتأمل\b", r"\bأدرس\b"]
}

DESCRIPTIONS = {
    "قيادية": "الشخصية القيادية: حزم، وضوح، اتخاذ قرارات سريعة، ملهمة للفريق. تحفز الآخرين وتدير المواقف الصعبة بثقة وفعالية، تجعل الجميع يشعر بالأمان ويحقق الإنتاجية القصوى.",
    "تعبيرية": "الشخصية التعبيرية: تواصل اجتماعي، مشاركة المشاعر، مرنة وعاطفية. تهتم بالآخرين، تعبر عن مشاعرها بوضوح، تخلق جوًا من الانسجام والإيجابية.",
    "تحليلية": "الشخصية التحليلية: تفكير منطقي، تخطيط، تقييم المعلومات بعناية. تحلل كل موقف قبل اتخاذ القرار، تحرص على التفاصيل وتفكر بالنتائج قبل التنفيذ.",
    "داعمة": "الشخصية الداعمة: تساعد الآخرين، صبورة، تقدم دعم مستمر. تعزز الثقة والمساندة بين أفراد الفريق، تهتم برفاهية من حولها وتدعم الجميع بشكل مستمر.",
    "محلل_استراتيجي": "المحلل الاستراتيجي: يفكر بعيد المدى، يخطط بدقة، يحلل المعلومات قبل اتخاذ القرار. يعتمد على المنطق والبيانات لتحقيق أفضل النتائج ويوازن بين المخاطر والفرص.",
    "مستكشف_مغامر": "المستكشف المغامر: يحب المغامرة واكتشاف المجهول، يواجه المخاطر بشجاعة، يتمتع بفضول قوي وروح مبادرة. يسعى لتجربة أشياء جديدة وتوسيع آفاقه باستمرار.",
    "مبتكر_مبدع": "المبتكر المبدع: يخلق حلولًا جديدة للمشكلات، يتميز بخيال واسع، يحب التجربة والابتكار. يفكر خارج الصندوق ويحب تحسين العمليات بطرق مبتكرة وغير تقليدية.",
    "مرشد_حكيم": "المرشد الحكيم: يعطي نصائح مدروسة، يستمع جيدًا للآخرين، يوازن بين العاطفة والمنطق. يقدم التوجيه بطريقة حكيمة ويحفز الآخرين على النمو والتعلم.",
    "حالم_عاطفي": "الحالم العاطفي: يعيش في عواطفه وأفكاره، حساس تجاه مشاعر الآخرين، يبحث عن معنى أعمق للعلاقات والحياة. يعبر عن مشاعره بصدق ويهتم بالجانب العاطفي لكل موقف.",
    "منفذ_عملي": "المنفذ العملي: يركز على النتائج، ينفذ الخطط بسرعة وفعالية، يحب العمل الملموس. يفضل التعامل مع الواقع مباشرة ويحل المشكلات بطريقة عملية.",
    "دبلوماسي_اجتماعي": "الدبلوماسي الاجتماعي: يتفوق في فهم الآخرين وبناء العلاقات، يجيد التفاوض وحل النزاعات. يسعى لإيجاد التوازن بين مصالح الجميع ويعزز الانسجام.",
    "شخص_مستقل": "الشخص المستقل: يعتمد على نفسه في اتخاذ القرارات، يثق بقدراته، يحدد مبادئه بوضوح. يفضل الاعتماد على التحليل الشخصي والتفكير المستقل قبل أي خطوة.",
    "محفز_ملهم": "المحفز الملهم: يحفز الآخرين بكلماته وأفعاله، يخلق طاقة إيجابية، يشجعهم على التفوق وتحقيق أهدافهم. مصدر حماسة ودافعية للفريق.",
    "باحث_فلسفي": "الباحث الفلسفي: يحب التفكير العميق في الحياة والعلاقات، يبحث عن المعنى والدروس من التجارب. يعكس التأمل والتحليل العميق لكل موقف ويستخرج العبر."
}

# -----------------------------
# Help text
# -----------------------------
HELP_TEXT = (
    "أوامر البوت:\n"
    "- سؤال → عرض سؤال عام.\n"
    "- تحدي → تحدي ممتع.\n"
    "- اعتراف → اعتراف.\n"
    "- شخصي → سؤال شخصي من الملف.\n"
    "- لعبه1 إلى لعبه10 → بدء لعبة جماعية.\n\n"
    "طريقة اللعب:\n"
    "1. بعد بدء اللعبة، كل عضو يرسل 'ابدأ' للانضمام.\n"
    "2. سيظهر لكل عضو 5 أسئلة بالترتيب.\n"
    "3. يجيب كل عضو على كل سؤال بالرقم المناسب (1-4).\n"
    "4. بعد انتهاء جميع الأسئلة، سيظهر تحليل شخصيته بشكل منطقي مبني على إجابات كل شخص."
)

# -----------------------------
# Event handling
# -----------------------------
@app.route("/callback", methods=["POST"])
def callback():
    signature = request.headers["X-Line-Signature"]
    body = request.get_data(as_text=True)
    try:
        handler.handle(body, signature)
    except InvalidSignatureError:
        abort(400)
    return "OK"

@handler.add(MessageEvent, message=TextMessage)
def handle_message(event):
    text = event.message.text.strip()
    user_id = event.source.user_id

    # أمر مساعدة
    if text == "مساعدة":
        line_bot_api.reply_message(event.reply_token, TextSendMessage(HELP_TEXT))
        return

    # ألعاب
    if text in games:
        # تفعيل اللعبة مع المستخدم
        questions = games[text]
        analysis = analyze_user(questions)
        msg = f"لقد انتهيت من اللعبة '{text}'!\n\nتحليل شخصيتك:\n{analysis}"
        line_bot_api.reply_message(event.reply_token, TextSendMessage(msg))
        return

    # أسئلة عامة
    if text == "سؤال":
        q = random.choice(questions_file)
        line_bot_api.reply_message(event.reply_token, TextSendMessage(q))
        return

    # تحدي
    if text == "تحدي":
        c = random.choice(challenges_file)
        line_bot_api.reply_message(event.reply_token, TextSendMessage(c))
        return

    # اعتراف
    if text == "اعتراف":
        c = random.choice(confessions_file)
        line_bot_api.reply_message(event.reply_token, TextSendMessage(c))
        return

    # شخصي
    if text == "شخصي":
        c = random.choice(personality_file)
        line_bot_api.reply_message(event.reply_token, TextSendMessage(c))
        return

    line_bot_api.reply_message(event.reply_token, TextSendMessage("لم أفهم الأمر. ارسل 'مساعدة' لعرض الأوامر."))

# -----------------------------
# Analysis based on answers
# -----------------------------
def analyze_user(answers: typing.List[str]) -> str:
    scores = {k: 0 for k in DESCRIPTIONS.keys()}
    for ans in answers:
        for key, patterns in KEYWORDS.items():
            for p in patterns:
                if re.search(p, ans):
                    scores[key] += 1

    # ترتيب الشخصيات حسب النقاط
    sorted_scores = sorted(scores.items(), key=lambda x: x[1], reverse=True)
    top_character = sorted_scores[0][0]
    description = DESCRIPTIONS[top_character]
    return description

# -----------------------------
# Run Flask app
# -----------------------------
if __name__ == "__main__":
    app.run(port=5000, debug=True)
