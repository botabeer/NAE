from flask import Flask, request, abort
from linebot import LineBotApi, WebhookHandler
from linebot.exceptions import InvalidSignatureError
from linebot.models import MessageEvent, TextMessage, TextSendMessage
import random, os

app = Flask(__name__)

LINE_CHANNEL_ACCESS_TOKEN = os.environ.get('LINE_CHANNEL_ACCESS_TOKEN')
LINE_CHANNEL_SECRET = os.environ.get('LINE_CHANNEL_SECRET')

line_bot_api = LineBotApi(LINE_CHANNEL_ACCESS_TOKEN)
handler = WebhookHandler(LINE_CHANNEL_SECRET)

# -------------------------------------------------------
# Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø­Ø¨ØŒ Ø§Ù„ØªØ­Ø¯ÙŠØ§ØªØŒ Ø§Ù„Ø§Ø¹ØªØ±Ø§ÙØ§Øª
# -------------------------------------------------------
questions = [
"Ù…Ø§ Ø£ÙƒØ«Ø± Ø´ÙŠØ¡ ØªØ­Ø¨Ù‡ ÙÙŠ Ø´Ø±ÙŠÙƒ Ø­ÙŠØ§ØªÙƒØŸ",
"Ø§Ø¹ØªØ±Ù Ø¨Ø´ÙŠØ¡ ØªØ®ÙÙŠÙ‡ Ø¹Ù†Ù‡.",
"Ù‡Ù„ Ø³Ø¨Ù‚ ÙˆÙ†Ø¯Ù…Øª Ø¹Ù„Ù‰ ØªØµØ±Ù Ù…Ø¹ Ø´Ø±ÙŠÙƒÙƒØŸ",
"Ù‡Ù„ ØªØºØ§Ø± Ø¹Ù„ÙŠÙ‡ ÙƒØ«ÙŠØ±ØŸ",
"Ù‡Ù„ ØªØ´Ø¹Ø± Ø£Ù†Ù‡ ÙŠÙÙ‡Ù…Ùƒ Ø¨Ø¯ÙˆÙ† ÙƒÙ„Ø§Ù…ØŸ",
"Ù…Ø§ Ø£ÙˆÙ„ Ø´ÙŠØ¡ Ø¬Ø°Ø¨Ùƒ ÙÙŠÙ‡ØŸ",
"Ù‡Ù„ ØªØ¹ØªØ¨Ø± Ù†ÙØ³Ùƒ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø£ÙƒØ«Ø± Ø­Ø¨Ø§Ù‹ØŸ",
"Ù‡Ù„ ØªØ­Ø¨ Ø§Ù„Ù…ÙØ§Ø¬Ø¢Øª Ø§Ù„Ø±ÙˆÙ…Ø§Ù†Ø³ÙŠØ©ØŸ",
"Ù…Ø§ Ø£ÙƒØ«Ø± Ø´ÙŠØ¡ ÙŠØ¬Ø¹Ù„Ùƒ ØªØ¨ØªØ³Ù… Ù…Ø¹Ù‡ØŸ",
"Ù…Ø§ Ø£Ø¬Ù…Ù„ Ø°ÙƒØ±Ù‰ Ø¨ÙŠÙ†ÙƒÙ…Ø§ØŸ"
]

love_challenges = [
"Ø§ÙƒØªØ¨ Ù„Ù‡ Ø±Ø³Ø§Ù„Ø© ØªØ¨Ø¯Ø£ Ø¨ÙƒÙ„Ù…Ø© (Ø£Ø­Ø¨Ùƒ Ù„Ø£Ù†...).",
"Ø´Ø§Ø±Ùƒ Ù…Ø¹Ù‡ Ø°ÙƒØ±Ù‰ Ù…Ø§ ØªÙ†Ø³Ø§Ù‡Ø§.",
"Ù‚Ù„ Ù„Ù‡ Ø´ÙŠ ØªØ­Ø¨Ù‡ ÙÙŠÙ‡ Ù…Ø§ Ù‚Ø¯ Ù‚Ù„ØªÙ‡.",
"Ø§Ø±Ø³Ù„Ù‡ ØµÙˆØ±Ø© Ù‚Ø¯ÙŠÙ…Ø© ØªØ¬Ù…Ø¹ÙƒÙ….",
"Ø§Ø­ÙƒÙŠ Ù„Ù‡ Ø£ÙˆÙ„ Ù„Ø­Ø¸Ø© Ø®ÙÙ‚ ÙÙŠÙ‡Ø§ Ù‚Ù„Ø¨Ùƒ Ù„Ù‡."
]

confessions = [
"Ø§Ø¹ØªØ±Ù Ø¨Ø£ÙˆÙ„ Ø´Ø®Øµ Ø¬Ø°Ø¨Ùƒ ÙÙŠ Ø­ÙŠØ§ØªÙƒ.",
"Ø§Ø¹ØªØ±Ù Ø¨Ø£ÙƒØ«Ø± Ø¹Ø§Ø¯Ø© Ø³ÙŠØ¦Ø© Ø¹Ù†Ø¯Ùƒ.",
"Ø§Ø¹ØªØ±Ù Ø¨Ø´ÙŠ Ù†Ø¯Ù…Øª Ø¹Ù„ÙŠÙ‡.",
"Ø§Ø¹ØªØ±Ù Ø¨Ø§Ø³Ù… Ø£ÙˆÙ„ Ø­Ø¨ ÙÙŠ Ø­ÙŠØ§ØªÙƒ.",
"Ø§Ø¹ØªØ±Ù Ø¨Ø³Ø± Ù…Ø§ Ù‚Ù„ØªÙ‡ Ù„Ø£Ø­Ø¯."
]

# -------------------------------------------------------
# Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ Ø§Ù„Ø«Ù„Ø§Ø« (ÙƒÙ„ Ù„Ø¹Ø¨Ø© 10 Ø£Ø³Ø¦Ù„Ø©ØŒ 4 Ø®ÙŠØ§Ø±Ø§Øª)
# -------------------------------------------------------
games = {
    "1": {
        "name": "Ø§Ù„ØºØ§Ø¨Ø©",
        "questions": [
            {"q": "Ø£Ù†Øª ÙÙŠ ØºØ§Ø¨Ø© ÙˆÙ‚Ø¯Ø§Ù…Ùƒ ÙƒÙˆØ® Ù…Ù‡Ø¬ÙˆØ±ØŒ ØªØ®ØªØ§Ø±:", "options": ["ØªØ¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ®", "ØªØªØ¬Ø§Ù‡Ù„Ù‡ ÙˆØªÙƒÙ…Ù„ Ø§Ù„Ù…Ø´ÙŠ", "ØªØ¯ÙˆØ± Ø­ÙˆÙ„Ù‡ ÙˆØªØ³ØªÙƒØ´Ù", "ØªØ¬Ù„Ø³ Ù‚Ø±ÙŠØ¨ ÙˆØªØ±Ø§Ù‚Ø¨ Ø§Ù„Ù…ÙƒØ§Ù†"]},
            {"q": "ÙˆØ¬Ø¯Øª Ø¬Ø¯ÙˆÙ„ Ù…ÙŠØ§Ù‡ ØµØºÙŠØ± ÙÙŠ Ø§Ù„ØºØ§Ø¨Ø©ØŒ ØªØ®ØªØ§Ø±:", "options": ["ØªØ´Ø±Ø¨ Ù…Ù†Ù‡", "ØªÙ…Ù„Ø£ Ø²Ø¬Ø§Ø¬ØªÙƒ", "ØªØªØ¨Ø¹ Ù…Ø¬Ø±Ù‰ Ø§Ù„Ù…Ø§Ø¡", "ØªØªØ±ÙƒÙ‡"]},
            {"q": "Ø±Ø£ÙŠØª Ø·Ø§Ø¦Ø± ØºØ±ÙŠØ¨ ÙÙŠ Ø§Ù„Ø³Ù…Ø§Ø¡ØŒ ØªØ®ØªØ§Ø±:", "options": ["ØªØªØ¨Ø¹ Ø§Ù„Ø·Ø§Ø¦Ø±", "ØªØªØ±ÙƒÙ‡", "ØªØ­Ø§ÙˆÙ„ ØªØµÙˆÙŠØ±Ù‡", "ØªØ¬Ù„Ø³ ØªØªØ£Ù…Ù„"]},
            {"q": "ÙˆØ¬Ø¯Øª Ø«Ù…Ø±Ø© ØºØ±ÙŠØ¨Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø±Ø¶ØŒ ØªØ®ØªØ§Ø±:", "options": ["ØªØ£ÙƒÙ„Ù‡Ø§", "ØªØªØ±ÙƒÙ‡Ø§", "ØªØ¬Ù…Ø¹Ù‡Ø§", "ØªÙØ­ØµÙ‡Ø§"]},
            {"q": "ØµÙˆØª ØºØ±ÙŠØ¨ ÙŠØ£ØªÙŠ Ù…Ù† Ø§Ù„Ø£Ø´Ø¬Ø§Ø±ØŒ ØªØ®ØªØ§Ø±:", "options": ["ØªØ³ØªÙƒØ´Ù Ø§Ù„ØµÙˆØª", "ØªØºØ§Ø¯Ø± Ø§Ù„Ù…ÙƒØ§Ù†", "ØªØ±Ø§Ù‚Ø¨ Ø¨Ù‡Ø¯ÙˆØ¡", "ØªØµØ±Ø® Ù„ØªØ¹Ø±Ù Ø±Ø¯Ø© ÙØ¹Ù„"]},
            {"q": "ÙˆØ¬Ø¯Øª Ø¬Ø³Ø± Ø®Ø´Ø¨ÙŠ Ù‚Ø¯ÙŠÙ…ØŒ ØªØ®ØªØ§Ø±:", "options": ["ØªØ¹Ø¨Ø±Ù‡", "ØªØªØ¬Ø§Ù‡Ù„Ù‡", "ØªÙØ­ØµÙ‡ Ø£ÙˆÙ„Ø§Ù‹", "ØªÙ‚Ù Ù„Ù„ØªÙÙƒÙŠØ±"]},
            {"q": "Ø³Ù…Ø¹Øª Ø­ÙŠÙˆØ§Ù† ÙŠØ²Ù…Ø¬Ø±ØŒ ØªØ®ØªØ§Ø±:", "options": ["ØªÙ‚ØªØ±Ø¨ Ø¨Ø­Ø°Ø±", "ØªØ®ØªØ¨Ø¦", "ØªØµØ±Ø®", "ØªØªØ±Ø§Ø¬Ø¹"]},
            {"q": "ÙˆØ¬Ø¯Øª Ø®Ø±ÙŠØ·Ø© Ù‚Ø¯ÙŠÙ…Ø©ØŒ ØªØ®ØªØ§Ø±:", "options": ["ØªØªØ¨Ø¹Ù‡Ø§", "ØªØªØ±ÙƒÙ‡Ø§", "ØªØ­Ø±Ù‚Ù‡Ø§", "ØªØ­Ù„Ù„Ù‡Ø§"]},
            {"q": "Ø±Ø§Ø¦Ø­Ø© Ø¹Ø·Ø± ØºØ±ÙŠØ¨Ø©ØŒ ØªØ®ØªØ§Ø±:", "options": ["ØªØªØ¨Ø¹Ù‡Ø§", "ØªØªØ¬Ø§Ù‡Ù„Ù‡Ø§", "ØªØ­Ø°Ø±", "ØªØ³ØªÙ…ØªØ¹ Ø¨Ù‡Ø§"]},
            {"q": "Ù„ÙŠÙ„Ø© Ù‡Ø§Ø¯Ø¦Ø© ÙˆØ§Ù„ØºØ§Ø¨Ø© Ù…Ø¸Ù„Ù…Ø©ØŒ ØªØ®ØªØ§Ø±:", "options": ["ØªØ®ÙŠÙ…", "ØªÙˆØ§ØµÙ„ Ø§Ù„Ù…Ø´ÙŠ", "ØªØ³ØªØ±ÙŠØ­ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø±Ø¶", "ØªØ±Ø§Ù‚Ø¨ Ø§Ù„Ù†Ø¬ÙˆÙ…"]}
        ]
    },
    "2": {
        "name": "Ø§Ù„Ø¬Ø²ÙŠØ±Ø©",
        "questions": [
            {"q": "Ø£Ù†Øª Ø¹Ù„Ù‰ Ø´Ø§Ø·Ø¦ Ø¬Ø²ÙŠØ±Ø© Ù…Ù‡Ø¬ÙˆØ±Ø©ØŒ ØªØ®ØªØ§Ø±:", "options": ["ØªØ³ØªÙƒØ´Ù Ø§Ù„Ø´Ø§Ø·Ø¦", "ØªØ¬Ù„Ø³ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ù…Ø§Ù„", "ØªØ¨Ø­Ø« Ø¹Ù† Ù…Ø£ÙˆÙ‰", "ØªØ³Ø¨Ø­ ÙÙŠ Ø§Ù„Ø¨Ø­Ø±"]},
            {"q": "ÙˆØ¬Ø¯Øª ÙƒÙ‡ÙˆÙ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø²ÙŠØ±Ø©ØŒ ØªØ®ØªØ§Ø±:", "options": ["ØªØ¯Ø®Ù„ Ø§Ù„ÙƒÙ‡Ù", "ØªØ±Ø§Ù‚Ø¨Ù‡ ÙÙ‚Ø·", "ØªØªØ¬Ø§Ù‡Ù„Ù‡", "ØªØ¨Ø­Ø« Ø¹Ù† Ù…Ø¯Ø®Ù„ Ø¢Ø®Ø±"]},
            {"q": "Ø±Ø£ÙŠØª Ù‚Ø§Ø±Ø¨ Ù…Ù‡Ø¬ÙˆØ±ØŒ ØªØ®ØªØ§Ø±:", "options": ["ØªÙØ­ØµÙ‡", "ØªØ±ÙƒÙ‡", "ØªØ­Ø§ÙˆÙ„ ØªØ´ØºÙŠÙ„Ù‡", "ØªØ®Ø¨Ø¦Ù‡"]},
            {"q": "ÙˆØ¬Ø¯Øª ÙØ§ÙƒÙ‡Ø© ØºØ±ÙŠØ¨Ø©ØŒ ØªØ®ØªØ§Ø±:", "options": ["ØªØ£ÙƒÙ„Ù‡Ø§", "ØªØ¬Ù…Ø¹Ù‡Ø§", "ØªØªØ±ÙƒÙ‡Ø§", "ØªØ³ØªØ´ÙŠØ± Ø§Ù„Ø¢Ø®Ø±ÙŠÙ†"]},
            {"q": "Ø³Ù…Ø¹Øª ØµÙˆØª Ø£Ù…ÙˆØ§Ø¬ ØºØ±ÙŠØ¨Ø©ØŒ ØªØ®ØªØ§Ø±:", "options": ["ØªØ³ØªÙƒØ´Ù Ø§Ù„ØµÙˆØª", "ØªØªØ±Ùƒ Ø§Ù„Ù…ÙƒØ§Ù†", "ØªØ³Ø¬Ù„ Ø§Ù„ØµÙˆØª", "ØªØ±Ø§Ù‚Ø¨ Ø§Ù„Ø£Ù…ÙˆØ§Ø¬"]},
            {"q": "Ø±Ø£ÙŠØª Ø­ÙŠÙˆØ§Ù† ØºØ±ÙŠØ¨ØŒ ØªØ®ØªØ§Ø±:", "options": ["ØªÙ‚ØªØ±Ø¨ Ø¨Ø­Ø°Ø±", "ØªØªØ±ÙƒÙ‡", "ØªØµÙˆØ±Ù‡", "ØªØ±Ø§Ù‚Ø¨Ù‡"]},
            {"q": "ÙˆØ¬Ø¯Øª Ø®Ø±ÙŠØ·Ø© Ø¬Ø²ÙŠØ±Ø©ØŒ ØªØ®ØªØ§Ø±:", "options": ["ØªØªØ¨Ø¹Ù‡Ø§", "ØªØªØ±ÙƒÙ‡Ø§", "ØªØ­Ù„Ù„Ù‡Ø§", "ØªØ­Ø±Ù‚Ù‡Ø§"]},
            {"q": "Ø±Ø§Ø¦Ø­Ø© Ø¯Ø®Ø§Ù† Ù…Ù† Ø¨Ø¹ÙŠØ¯ØŒ ØªØ®ØªØ§Ø±:", "options": ["ØªØªØ¬Ù‡ Ù†Ø­ÙˆÙ‡", "ØªØªØ¬Ø§Ù‡Ù„Ù‡", "ØªØ­Ø°Ø±", "ØªØ±Ø§Ù‚Ø¨ Ù…Ù† Ø¨Ø¹ÙŠØ¯"]},
            {"q": "Ù„ÙŠÙ„ Ø§Ù„Ø¬Ø²ÙŠØ±Ø© Ù…Ø¸Ù„Ù…ØŒ ØªØ®ØªØ§Ø±:", "options": ["ØªØ®ÙŠÙ…", "ØªÙˆØ§ØµÙ„ Ø§Ù„Ù…Ø´ÙŠ", "ØªØ±Ø§Ù‚Ø¨ Ø§Ù„Ù†Ø¬ÙˆÙ…", "ØªØ¬Ù„Ø³ Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ù„Ù†Ø§Ø±"]},
            {"q": "ÙˆØ¬Ø¯Øª ØµÙ†Ø¯ÙˆÙ‚ Ù‚Ø¯ÙŠÙ…ØŒ ØªØ®ØªØ§Ø±:", "options": ["ØªÙØªØ­Ù‡", "ØªØªØ±ÙƒÙ‡", "ØªÙØ­ØµÙ‡", "ØªØ­Ù…Ù„Ù‡ Ù…Ø¹Ùƒ"]}
        ]
    },
    "3": {
        "name": "Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©",
        "questions": [
            {"q": "Ø£Ù†Øª ÙÙŠ Ø´Ø§Ø±Ø¹ Ù…Ø²Ø¯Ø­Ù…ØŒ ØªØ®ØªØ§Ø±:", "options": ["ØªØ³ÙŠØ± Ù…Ø¹ Ø§Ù„Ù†Ø§Ø³", "ØªØªÙˆÙ‚Ù ÙˆØªØªØ£Ù…Ù„", "ØªØ¯Ø®Ù„ Ù…Ø­Ù„ Ù‚Ø±ÙŠØ¨", "ØªØ³Ø£Ù„ Ø¹Ù† Ø§Ù„Ø§ØªØ¬Ø§Ù‡"]},
            {"q": "ÙˆØ¬Ø¯Øª Ù†Ø§ÙÙˆØ±Ø© Ø¬Ù…ÙŠÙ„Ø©ØŒ ØªØ®ØªØ§Ø±:", "options": ["ØªØµÙˆØ±Ù‡Ø§", "ØªØ¬Ù„Ø³ Ø¨Ø¬Ø§Ù†Ø¨Ù‡Ø§", "ØªØªØ¬Ø§Ù‡Ù„Ù‡Ø§", "ØªØ±Ø§Ù‚Ø¨ Ø§Ù„Ù†Ø§Ø³ Ø­ÙˆÙ„Ù‡Ø§"]},
            {"q": "Ø±Ø£ÙŠØª Ù‚Ø·Ø© Ø¶Ø§Ø¦Ø¹Ø©ØŒ ØªØ®ØªØ§Ø±:", "options": ["ØªÙ‚ØªØ±Ø¨ Ù…Ù†Ù‡Ø§", "ØªØªØ±ÙƒÙ‡Ø§", "ØªØ­Ø§ÙˆÙ„ Ø¥Ø·Ø¹Ø§Ù…Ù‡Ø§", "ØªØ¨Ø­Ø« Ø¹Ù† ØµØ§Ø­Ø¨Ù‡Ø§"]},
            {"q": "Ø³Ù…Ø¹Øª Ù…ÙˆØ³ÙŠÙ‚Ù‰ Ù…Ù† Ø¨Ø¹ÙŠØ¯ØŒ ØªØ®ØªØ§Ø±:", "options": ["ØªØªØ¨Ø¹ Ø§Ù„ØµÙˆØª", "ØªØªØ¬Ø§Ù‡Ù„Ù‡", "ØªØ³ØªÙ…ØªØ¹ Ù…Ù† Ù…ÙƒØ§Ù†Ùƒ", "ØªØ³Ø¬Ù„ Ø§Ù„ØµÙˆØª"]},
            {"q": "Ø±Ø£ÙŠØª Ù…ØªØ¬Ø± ØºØ±ÙŠØ¨ØŒ ØªØ®ØªØ§Ø±:", "options": ["ØªØ¯Ø®Ù„ Ø§Ù„Ù…ØªØ¬Ø±", "ØªØªØ¬Ø§Ù‡Ù„Ù‡", "ØªØ±Ø§Ù‚Ø¨Ù‡", "ØªØ³Ø£Ù„ Ø¹Ù† Ù…Ù†ØªØ¬Ø§ØªÙ‡"]},
            {"q": "Ø±Ø§Ø¦Ø­Ø© Ø·Ø¹Ø§Ù… Ù„Ø°ÙŠØ°ØŒ ØªØ®ØªØ§Ø±:", "options": ["ØªØªØ¨Ø¹ Ø§Ù„Ø±Ø§Ø¦Ø­Ø©", "ØªØ³ØªÙ…ØªØ¹ Ø¨Ù‡Ø§ Ù…Ù† Ø¨Ø¹ÙŠØ¯", "ØªØªØ¬Ø§Ù‡Ù„Ù‡Ø§", "ØªØ³Ø£Ù„ Ù…Ù† ØµØ§Ø­Ø¨Ù‡Ø§"]},
            {"q": "ÙˆØ¬Ø¯Øª ÙƒØªØ§Ø¨ Ù…Ù‡Ù…Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø±ØµÙŠÙØŒ ØªØ®ØªØ§Ø±:", "options": ["ØªÙØªØ­Ù‡", "ØªØªØ±ÙƒÙ‡", "ØªØµÙˆØ±Ù‡", "ØªØ­Ù…Ù„Ù‡ Ù…Ø¹Ùƒ"]},
            {"q": "Ø±Ø£ÙŠØª Ø·ÙÙ„ ÙŠØ¨ÙƒÙŠØŒ ØªØ®ØªØ§Ø±:", "options": ["ØªØ³Ø§Ø¹Ø¯Ù‡", "ØªØªØ±ÙƒÙ‡", "ØªØ³Ø£Ù„ Ø¹Ù† Ø³Ø¨Ø¨ Ø§Ù„Ø¨ÙƒØ§Ø¡", "ØªØ±Ø§Ù‚Ø¨Ù‡"]},
            {"q": "Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ù…Ø¸Ù„Ù…ØŒ ØªØ®ØªØ§Ø±:", "options": ["ØªØ³ÙŠØ± Ø¨Ø³Ø±Ø¹Ø©", "ØªØªÙˆÙ‚Ù ÙˆØªØªØ£Ù…Ù„", "ØªØ¯Ø®Ù„ Ù…Ø·Ø¹Ù…", "ØªØ±Ø§Ù‚Ø¨ Ø§Ù„Ø´Ø§Ø±Ø¹"]},
            {"q": "ÙˆØ¬Ø¯Øª Ø±Ø³Ø§Ù„Ø© ØºØ±ÙŠØ¨Ø©ØŒ ØªØ®ØªØ§Ø±:", "options": ["ØªÙ‚Ø±Ø£Ù‡Ø§", "ØªØªØ±ÙƒÙ‡Ø§", "ØªØµÙˆØ±Ù‡Ø§", "ØªØ­Ù„Ù„Ù‡Ø§"]}
        ]
    }
}

# -------------------------------------------------------
# Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
# -------------------------------------------------------
user_sessions = {}  # Ù„ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù…: {"game": "1", "step": 0, "answers": []}
user_asked_questions = {}  # Ù„ØªØ¬Ù†Ø¨ ØªÙƒØ±Ø§Ø± Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø­Ø¨ ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ§Øª

# -------------------------------------------------------
# ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø´Ø®ØµÙŠØ©
# -------------------------------------------------------
def analyze_personality(answers, user_name="Ù…Ø´Ø§Ø±Ùƒ"):
    score_active = 0
    score_calm = 0
    score_love = 0

    for a in answers:
        t = a.strip().lower()
        if any(x in t for x in ["1", "ØªØ¯Ø®Ù„", "ØªØ³ÙŠØ±", "Ù…ØºØ§Ù…Ø±Ø©", "Ù†Ø´Ø§Ø·", "Ø§Ø³ØªÙƒØ´Ø§Ù", "ØªØ¬Ø±Ø¨Ø©", "Ù‚Ø§Ø¦Ø¯"]):
            score_active += 1
        if any(x in t for x in ["2", "ØªØ¬Ù„Ø³", "Ù‡Ø¯ÙˆØ¡", "ØµØ¨Ø±", "ØªÙÙƒØ±", "Ø±Ø§Ù‚Ø¨"]):
            score_calm += 1
        if any(x in t for x in ["3", "4", "Ø¹Ø§Ø·ÙÙŠ", "Ø­Ø¨", "Ù…Ø´Ø§Ø¹Ø±", "Ù‚Ù„Ø¨", "ØªÙ‡ØªÙ…"]):
            score_love += 1

    total = score_active + score_calm + score_love
    def pct(n):
        return int((n / total) * 100) if total > 0 else 0

    result = f"ğŸ”¹ ØªØ­Ù„ÙŠÙ„ Ø´Ø®ØµÙŠØ© {user_name}:\n"
    result += f"Ø§Ù„Ø³Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©: "
    if score_love > max(score_active, score_calm):
        result += "Ø¹Ø§Ø·ÙÙŠØ© ÙˆØ­Ø³Ø§Ø³Ø© ğŸ’—\n\n"
    elif score_active > score_calm:
        result += "Ù…Ù†ÙØªØ­Ø© ÙˆÙ†Ø´ÙŠØ·Ø© ğŸ”¥\n\n"
    elif score_calm > score_active:
        result += "Ù‡Ø§Ø¯Ø¦Ø© ÙˆÙ…ØªØ²Ù†Ø© ğŸŒ¿\n\n"
    else:
        result += "Ù…ØªÙˆØ§Ø²Ù†Ø© ğŸ‘Œ\n\n"

    result += f"ğŸ’¥ Ø§Ù„Ù†Ø´Ø§Ø· ÙˆØ§Ù„Ø·Ø§Ù‚Ø©: {pct(score_active)}%\n"
    result += "- ØªØ­Ø¨ Ø§Ù„Ù…Ø¨Ø§Ø¯Ø±Ø© ÙˆØ§Ù„Ù…ØºØ§Ù…Ø±Ø©ØŒ ÙˆØªØ¬Ø±Ø¨Ø© Ø£Ø´ÙŠØ§Ø¡ Ø¬Ø¯ÙŠØ¯Ø©.\n"
    result += f"ğŸŒ¿ Ø§Ù„Ù‡Ø¯ÙˆØ¡ ÙˆØ§Ù„ØµØ¨Ø±: {pct(score_calm)}%\n"
    result += "- ØªÙ…ÙŠÙ„ Ù„Ù„ØªÙÙƒÙŠØ± Ù‚Ø¨Ù„ Ø§ØªØ®Ø§Ø° Ø§Ù„Ù‚Ø±Ø§Ø±Ø§ØªØŒ ØµØ¨ÙˆØ± ÙˆØªØ­Ø§ÙØ¸ Ø¹Ù„Ù‰ ØªÙˆØ§Ø²Ù†Ùƒ.\n"
    result += f"ğŸ’– Ø§Ù„Ø¹Ø§Ø·ÙØ© ÙˆØ§Ù„Ù…Ø´Ø§Ø¹Ø±: {pct(score_love)}%\n"
    result += "- Ø­Ø³Ø§Ø³ ÙˆØªÙ‡ØªÙ… Ø¨Ø§Ù„Ø¢Ø®Ø±ÙŠÙ†ØŒ ØªØ¹Ø¨Ø± Ø¹Ù† Ù…Ø´Ø§Ø¹Ø±Ùƒ Ø¨ÙˆØ¶ÙˆØ­.\n\n"
    result += "âœ¨ Ù†ØµÙŠØ­Ø©: Ø­Ø§ÙˆÙ„ Ù…ÙˆØ§Ø²Ù†Ø© Ø·Ø§Ù‚ØªÙƒØŒ ØµØ¨Ø±ÙƒØŒ ÙˆØ¹Ø§Ø·ÙØªÙƒ Ù„ØªØ¹ÙŠØ´ Ø­ÙŠØ§ØªÙƒ ÙˆØ¹Ù„Ø§Ù‚Ø§ØªÙƒ Ø¨Ø£ÙØ¶Ù„ Ø´ÙƒÙ„."
    return result

# -------------------------------------------------------
# Webhook
# -------------------------------------------------------
@app.route("/callback", methods=['POST'])
def callback():
    signature = request.headers.get('X-Line-Signature', '')
    body = request.get_data(as_text=True)
    try:
        handler.handle(body, signature)
    except InvalidSignatureError:
        abort(400)
    return 'OK'

# -------------------------------------------------------
# Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
# -------------------------------------------------------
@handler.add(MessageEvent, message=TextMessage)
def handle_message(event):
    user_id = event.source.user_id
    text = event.message.text.strip().lower()
    user_name = "Ù…Ø´Ø§Ø±Ùƒ"
    try:
        user_name = line_bot_api.get_profile(user_id).display_name
    except:
        pass

    # ------------------- Ø£Ù„Ø¹Ø§Ø¨ -------------------
    if "Ø§Ø¨Ø¯Ø£ Ù„Ø¹Ø¨Ø© 1" in text or "Ø§Ø¨Ø¯Ø£ Ù„Ø¹Ø¨Ø© 2" in text or "Ø§Ø¨Ø¯Ø£ Ù„Ø¹Ø¨Ø© 3" in text:
        game_num = text[-1]
        user_sessions[user_id] = {"game": game_num, "step": 0, "answers": []}
        q = games[game_num]["questions"][0]
        opts = "\n".join([f"{i+1}. {o}" for i,o in enumerate(q["options"])])
        line_bot_api.reply_message(event.reply_token, TextSendMessage(
            text=f"ğŸ® Ø¨Ø¯Ø£Øª Ù„Ø¹Ø¨Ø© {games[game_num]['name']}!\nØ§Ù„Ø³Ø¤Ø§Ù„ 1:\n{q['q']}\n{opts}"
        ))
        return

    # ------------------- Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù„Ø¹Ø¨Ø© -------------------
    if user_id in user_sessions:
        session = user_sessions[user_id]
        game_num = session["game"]
        step = session["step"]
        qlist = games[game_num]["questions"]

        # ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©
        session["answers"].append(text)
        session["step"] += 1

        # Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ
        if session["step"] >= len(qlist):
            analysis = analyze_personality(session["answers"], user_name)
            del user_sessions[user_id]
            line_bot_api.reply_message(event.reply_token, TextSendMessage(text=analysis))
        else:
            q = qlist[session["step"]]
            opts = "\n".join([f"{i+1}. {o}" for i,o in enumerate(q["options"])])
            line_bot_api.reply_message(event.reply_token, TextSendMessage(
                text=f"Ø§Ù„Ø³Ø¤Ø§Ù„ {session['step']+1}:\n{q['q']}\n{opts}"
            ))
        return

    # ------------------- Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø­Ø¨ -------------------
    if "Ø³Ø¤Ø§Ù„" in text or "Ø³ÙˆØ§Ù„" in text:
        asked = user_asked_questions.get(user_id, set())
        available = [q for q in questions if q not in asked]
        if not available:
            user_asked_questions[user_id] = set()
            available = questions.copy()
        q = random.choice(available)
        user_asked_questions.setdefault(user_id, set()).add(q)
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text=q))
        return

    # ------------------- ØªØ­Ø¯ÙŠ -------------------
    if "ØªØ­Ø¯ÙŠ" in text:
        c = random.choice(love_challenges)
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text=f"ğŸ’Œ {c}"))
        return

    # ------------------- Ø§Ø¹ØªØ±Ø§Ù -------------------
    if "Ø§Ø¹ØªØ±Ø§Ù" in text:
        conf = random.choice(confessions)
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text=f"ğŸ©· {conf}"))
        return

    # ------------------- ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø´Ø®ØµÙŠØ© -------------------
    if "Ø­Ù„Ù„ Ø´Ø®ØµÙŠØªÙŠ" in text:
        # ØªØ­Ù„ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© ÙÙŠ Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨
        if user_id in user_sessions:
            answers = user_sessions[user_id]["answers"]
        else:
            answers = []
        analysis = analyze_personality(answers, user_name)
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text=analysis))
        return

    # ------------------- Ù…Ø³Ø§Ø¹Ø¯Ø© -------------------
    if "Ù…Ø³Ø§Ø¹Ø¯Ø©" in text:
        help_text = (
            "â¤ï¸ Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¨ÙˆØª:\n"
            "- 'Ø³Ø¤Ø§Ù„' Ø£Ùˆ 'Ø³ÙˆØ§Ù„' â†’ Ø³Ø¤Ø§Ù„ Ø­Ø¨ Ø£Ùˆ ØµØ±Ø§Ø­Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠ.\n"
            "- 'ØªØ­Ø¯ÙŠ' â†’ ØªØ­Ø¯ÙŠ Ø­Ø¨ Ø±ÙˆÙ…Ø§Ù†Ø³ÙŠ.\n"
            "- 'Ø§Ø¹ØªØ±Ø§Ù' â†’ Ø³Ø¤Ø§Ù„ Ø§Ø¹ØªØ±Ø§Ù ØµØ±ÙŠØ­.\n"
            "- 'Ø§Ø¨Ø¯Ø£ Ù„Ø¹Ø¨Ø© 1/2/3' â†’ ØªØ¨Ø¯Ø£ Ø£ÙŠ Ù…Ù† Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ Ø§Ù„Ø«Ù„Ø§Ø«.\n"
            "- 'Ø­Ù„Ù„ Ø´Ø®ØµÙŠØªÙŠ' â†’ ÙŠØ¹Ø·ÙŠ ØªØ­Ù„ÙŠÙ„ ØªÙØµÙŠÙ„ÙŠ Ù…Ù† Ø¥Ø¬Ø§Ø¨Ø§ØªÙƒ.\n"
            "- 'Ù…Ø³Ø§Ø¹Ø¯Ø©' â†’ Ø¹Ø±Ø¶ Ø§Ù„Ø£ÙˆØ§Ù…Ø±.\n"
            "ğŸ’¡ ØªÙ‚Ø¯Ø± ØªØ¬Ø§ÙˆØ¨ Ø¨Ø§Ù„Ø±Ù‚Ù…ØŒ Ø§Ù„Ù†ØµØŒ Ø£Ùˆ 'Ø§Ù„ØªØ§Ù„ÙŠ' Ù„ØªÙƒÙ…Ù„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©."
        )
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text=help_text))
        return

    # Ø£ÙŠ Ø´ÙŠØ¡ Ø¢Ø®Ø±
    line_bot_api.reply_message(event.reply_token, TextSendMessage(
        text="Ù…Ø§ ÙÙ‡Ù…ØªØŒ Ø­Ø§ÙˆÙ„ ØªÙƒØªØ¨ Ø§Ù„Ø±Ù‚Ù… Ø£Ùˆ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ø£Ùˆ â€˜Ø§Ù„ØªØ§Ù„ÙŠâ€™ Ø£Ùˆ Ø£Ø­Ø¯ Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¨ÙˆØª."
    ))
    return

# -------------------------------------------------------
if __name__ == "__main__":
    port = int(os.environ.get('PORT', 5000))
    app.run(host='0.0.0.0', port=port)
